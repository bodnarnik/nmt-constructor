
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система тестування НМТ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['\\(', '\\)'], ['$', '$']] },
            svg: { fontCache: 'global' },
            startup: {
                typeset: false
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
	/* Стиль для розширеного попереднього перегляду в Банку */
        .bank-preview-content {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.95rem;
            color: #374151;
            margin-bottom: 5px;
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 5px;
            text-align: left;
        }
        /* Зменшуємо картинки в прев'ю, щоб не ламали верстку */
        .bank-preview-content img {
            max-height: 80px;
            width: auto;
            max-width: 100%;
        }
        /* Стиль для Latex у прев'ю */
        .bank-preview-content .math-node {
            font-size: 1rem;
        }
	/* --- BANK STYLES --- */
        .bank-layout { display: flex; height: calc(100vh - 80px); gap: 20px; }
        .bank-sidebar { width: 300px; background: white; border-right: 1px solid #e5e7eb; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .bank-content { flex: 1; background: white; padding: 20px; overflow-y: auto; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .bank-folder-item { 
            padding: 8px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; color: #374151;
        }
        .bank-folder-item:hover { background-color: #f3f4f6; }
        .bank-folder-item.active { background-color: #eff6ff; color: #2563eb; font-weight: bold; }
        .bank-folder-icon { color: #fbbf24; }

        .bank-task-card {
            border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: #fff;
            display: flex; gap: 15px; align-items: flex-start; transition: box-shadow 0.2s;
            cursor: grab;
        }
        .bank-task-card:active { cursor: grabbing; }
        .bank-task-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #d1d5db; }
        
        .bank-task-number { 
            font-size: 1.2em; font-weight: bold; color: #9ca3af; min-width: 30px; text-align: center; 
            background: #f9fafb; padding: 5px; border-radius: 4px;
        }
        .bank-task-info { flex: 1; }
        .bank-task-type { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: bold; margin-bottom: 4px; letter-spacing: 0.05em; }
        .bank-task-preview { font-size: 0.95rem; color: #1f2937; max-height: 60px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .bank-task-actions { display: flex; gap: 5px; flex-direction: column; }	

        /* --- Global SPA Styles --- */
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; color: #313131; transition: padding-top 0.3s ease, background-color 0.3s ease; }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px;
            max-width: 1000px; width: 95%; /* ЗБІЛЬШЕНО ШИРИНУ */
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-actions { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }

        /* --- Dashboard & Editor Common UI --- */
        .spa-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .spa-btn-primary { background-color: #FF2938; color: white; border: 1px solid #FF2938; }
        .spa-btn-primary:hover { background-color: #d91e2b; }
        .spa-btn-secondary { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .spa-btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .spa-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 16px; }
        
        /* --- Folder & Breadcrumb Styles --- */
        .folder-card {
            display: flex; align-items: center; gap: 12px;
            padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;
            background-color: #f9fafb; cursor: pointer; transition: all 0.2s;
            position: relative; /* For Drag & Drop */
        }
        .folder-card:hover { background-color: #f3f4f6; border-color: #d1d5db; }
        .folder-card.drag-over {
            background-color: #eff6ff; /* light blue */
            border: 2px dashed #2563eb;
            transform: scale(1.02);
        }
        
        .folder-icon { width: 24px; height: 24px; color: #fbbf24; }
        .folder-title { font-weight: 600; color: #1f2937; flex-grow: 1; }
        
        .breadcrumbs {
            display: flex; flex-wrap: wrap; align-items: center;
            gap: 8px; margin-bottom: 16px; font-size: 1rem;
            min-height: 30px; /* To ensure drop target size */
        }
        .breadcrumb-link { color: #FF2938; text-decoration: none; font-weight: 500; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .breadcrumb-link:hover { text-decoration: underline; background-color: rgba(255, 41, 56, 0.1); }
        .breadcrumb-link.drag-over {
            background-color: #eff6ff;
            border: 2px dashed #2563eb;
            text-decoration: none;
        }

        .breadcrumb-current { color: #374151; font-weight: 500; }
        .breadcrumb-separator { color: #9ca3af; }

        /* Draggable Test Card Styles */
        .spa-card[draggable="true"] {
            cursor: grab;
        }
        .spa-card[draggable="true"]:active {
            cursor: grabbing;
        }

        /* --- RICH EDITOR STYLES --- */
        .rich-editor-container { border: 1px solid #d1d5db; border-radius: 6px; background: white; overflow: hidden; margin-bottom: 8px; }
        .rich-toolbar { background: #f9fafb; border-bottom: 1px solid #e5e7eb; padding: 6px; display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        .rich-btn { 
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; 
            border: 1px solid transparent; border-radius: 4px; background: transparent; cursor: pointer; color: #4b5563; 
            transition: all 0.1s;
        }
        .rich-btn:hover { background-color: #e5e7eb; color: #111; border-color: #d1d5db; }
        .rich-btn svg { width: 16px; height: 16px; }
        
        .rich-select {
            height: 28px; border: 1px solid #d1d5db; border-radius: 4px; background: white; 
            color: #4b5563; font-size: 12px; padding: 0 4px; cursor: pointer;
        }
        .rich-select:hover { border-color: #9ca3af; }

        /* Styles for content inside the editor */
        .rich-content { padding: 12px; min-height: 60px; outline: none; font-size: 1rem; line-height: 1.5; max-height: 300px; overflow-y: auto; }
        .rich-content:focus { background-color: #fffbfc; }
        
        /* FIX: Global List Styles (Editor + Runner) */
        .rich-content ul, .problem ul, .instruction-block ul, .explanation-box ul, .hint-content ul { 
            list-style-type: disc; 
            margin-left: 1.5em; 
            padding-left: 0.5em; 
        }
        .rich-content ol, .problem ol, .instruction-block ol, .explanation-box ol, .hint-content ol { 
            list-style-type: decimal; 
            margin-left: 1.5em; 
            padding-left: 0.5em; 
        }
        .rich-content li, .problem li, .instruction-block li, .explanation-box li, .hint-content li { 
            margin-bottom: 0.25em; 
        }
        
        /* Link styles in editor/runner */
        /* Стилі для посилань: у редакторі, у завданнях, в інструкціях ТА в інфо-панелі */
        .rich-content a, .problem a, .instruction-block a, .info-text a {
            color: #2563eb !important; /* Яскраво-синій */
            text-decoration: underline !important; /* Підкреслення, щоб точно було видно */
            cursor: pointer;
            font-weight: 500;
        }
        .rich-content a:hover, .problem a:hover, .instruction-block a:hover {
            text-decoration: underline; /* Підкреслення при наведенні */
        }

        .rich-separator { width: 1px; background: #d1d5db; margin: 0 4px; height: 20px; align-self: center; }
        
        /* LaTeX Math Styles in Editor & Runner */
        .math-node {
            display: inline !important;
            padding: 0 1px;
            border-radius: 2px;
            border: 1px solid transparent;
            white-space: nowrap;
        }
        .rich-content .math-node { cursor: pointer; }
        .rich-content .math-node:hover { background-color: #f3f4f6; border-color: #d1d5db; }
        
        /* FIX: MathJax Color Inheritance */
        .math-node, 
        .math-node mjx-container, 
        .math-node svg, 
        .math-node path {
            color: inherit !important;
            fill: currentColor !important;
        }

        /* Dropdown Marker in Editor */
        .dropdown-marker {
            display: inline-block;
            background-color: #e0f2fe;
            border: 1px dashed #0284c7;
            color: #0284c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            user-select: none;
            margin: 0 2px;
        }

        mjx-container { display: inline-block !important; margin: 0 !important; padding: 0 !important; width: auto !important; text-align: left !important; text-indent: 0 !important; }
        mjx-container[display="true"] { display: inline-block !important; width: auto !important; margin: 0 !important; }
        .mjx-chtml { display: inline-block !important; margin: 0 !important; width: auto !important; white-space: nowrap !important; }

        /* --- RUNNER Styles --- */
        .header-brand-color { color: #FF2938; }
        .problem-header { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #313131; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .btn-brand { background-color: #FF2938; border: 1px solid #FF2938; color: #fff; padding: 10px 24px; font-size: 16px; font-weight: 600; border-radius: 30px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-brand:hover { background-color: #cc212d; border-color: #cc212d; }
        .btn-brand:active { transform: scale(0.98); }
        .btn-saved-state { background-color: #e5e7eb !important; border-color: #d1d5db !important; color: #4b5563 !important; cursor: default; transform: none !important; }
        
        .top-info-panel { position: fixed; top: 0; left: 0; width: 100%; background-color: #f3f4f6; border-bottom: 1px solid #d1d5db; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px 20px; transition: transform 0.3s ease; }
        .top-info-panel.hidden-panel { transform: translateY(-100%); }
        .info-text { font-size: 0.9rem; color: #4b5563; line-height: 1.4; max-width: 1200px; margin: 0 auto 5px auto; }
        .timer-controls { display: flex; align-items: center; justify-content: flex-end; gap: 15px; max-width: 1200px; margin: 0 auto; }
        .timer-display { font-family: monospace; font-size: 1.2rem; font-weight: bold; color: #1f2937; min-width: 80px; text-align: center; }
        
        .eye-btn-styled { background-color: #FF2938; border: 1px solid #FF2938; color: #fff; border-radius: 50%; padding: 8px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .return-panel-btn { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1001; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .xblock { background: white; padding: 25px; border: 1px solid #d9d9d9; border-radius: 4px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .instruction-block { border: 1px solid #E6E6E6; background-color: #fafafa; padding: 20px; text-align: center; margin-bottom: 30px; font-size: 1.25rem; line-height: 1.6; }
        
        .option-card { display: flex; align-items: center; padding: 12px 16px; margin-bottom: 10px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; background-color: #fff; font-size: 1.125rem; }
        .option-card:hover { border-color: #FF2938; }
        .option-card.selected { border-color: #FF2938; background-color: #fffbfc; }
        .field-input { accent-color: #2563eb; transform: scale(1.5); margin-right: 12px; cursor: pointer; }
        
        .option-card-multi { display: flex; align-items: center; padding: 12px 16px; margin-bottom: 10px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; background-color: #fff; font-size: 1.125rem; }
        .option-card-multi:hover { border-color: #FF2938; }
        .option-card-multi.selected { border-color: #FF2938; background-color: #fffbfc; }
        .field-input-multi { accent-color: #2563eb; transform: scale(1.5); margin-right: 12px; cursor: pointer; border-radius: 4px; }

        /* Dropdown in Runner */
        .runner-select {
            border: 2px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            margin: 0 4px;
            min-width: 100px;
        }
        .runner-select:focus {
            border-color: #2563eb;
            outline: none;
        }

        .dnd-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .dnd-column-left { flex: 2; min-width: 350px; }
        .dnd-column-right { flex: 1; min-width: 280px; }
        .dnd-questions-box { background-color: #d7fdfb; padding: 15px; border-radius: 10px; border: 1px solid #999; }
        .dnd-answers-box { background-color: #d6fdd1; padding: 15px; border-radius: 10px; border: 1px solid #999; display: flex; flex-direction: column; gap: 10px; }
        .dnd-row { display: flex; align-items: center; margin-bottom: 10px; justify-content: space-between; }
        .dnd-item-question { background-color: #bde5fd; border: 1px solid silver; border-radius: 5px; padding: 10px; flex-grow: 1; width: 50%; margin-right: 5px; min-height: 45px; display: flex; align-items: center; font-size: 1.125rem; }
        .dnd-arrow { position: relative; width: 40px; height: 2px; background-color: #999; margin: 0 20px 0 10px; flex-shrink: 0; }
        .dnd-arrow::after { content: ''; position: absolute; right: -12px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 12px solid #999; }
        .dnd-slot { background-color: #fff; border: 1px solid #999; border-radius: 5px; width: 260px; min-width: 260px; max-width: 260px; flex-grow: 0; flex-shrink: 0; height: auto; min-height: 45px; display: flex; align-items: center; padding: 0; cursor: pointer; position: relative; }
        .dnd-draggable { background-color: #92f97c; border: 1px solid silver; border-radius: 5px; padding: 10px; cursor: move; width: 100%; height: 100%; position: relative; z-index: 10; font-size: 1.125rem; }
        .dnd-draggable:active { cursor: move; }
        .dnd-draggable.selected { background-color: #e2e8e4; border: 1px solid silver; }
        .dnd-remove { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; background: #eee; border: 1px solid #999; border-radius: 4px; width: 24px; height: 24px; line-height: 20px; text-align: center; display: none; z-index: 20; }
        .dnd-slot:has(.dnd-draggable) .dnd-remove { display: block; }
        
        .formulaequationinput input { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: 180px; font-size: 16px; }

        .sidebar-panel { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: sticky; top: 280px; }
        /* ЗМІНЕНО: 5 колонок замість 3 для компактності */
        .sidebar-grid { 
            display: grid; 
            gap: 6px; 
            justify-items: center; 
            width: 100%; /* На всю ширину панелі */
        }
        
        /* Стиль для кнопки бічної панелі */
        /* Базовий стиль квадратика (розміри теж будуть змінюватися через JS) */
        .task-square { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            font-weight: 500; 
            color: #333; 
            background-color: white; 
            transition: all 0.2s; 
            cursor: pointer; 
            /* width/height/font-size видалені звідси, бо вони будуть динамічні */
        }
        .task-square:hover { border-color: #9ca3af; background-color: #f9fafb; }
        .task-square.completed { background-color: #FF2938; color: white; border-color: #FF2938; }
        
        /* НОВЕ: Стиль блоку розриву сторінки в редакторі */
        .page-break-block {
            background-color: #fee2e2;
            border: 2px dashed #ef4444;
            color: #b91c1c;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        /* НОВЕ: Кнопки навігації по сторінках у тесті */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        .task-square { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 1px solid #d1d5db; border-radius: 4px; font-weight: 500; color: #333; background-color: white; transition: background-color 0.3s; cursor: pointer; }
        .task-square.completed { background-color: #FF2938; color: white; border-color: #FF2938; }

        .analysis-block { display: none; margin-top: 20px; border-top: 2px solid #e5e7eb; padding-top: 20px; }
        .correct-answer-box { background-color: #ecfdf5; border: 1px solid #6ee7b7; color: #064e3b; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .explanation-box { background-color: #eff6ff; border: 1px solid #93c5fd; color: #1e3a8a; padding: 15px; border-radius: 8px; }
        .notification { margin-top: 15px; padding: 12px; border-radius: 6px; display: none; font-weight: 500; color: #842029; background-color: #f8d7da; }
    
        .move-btn {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #d1d5db; background: #f9fafb; border-radius: 4px; cursor: pointer;
            font-size: 14px; color: #4b5563;
        }
        .move-btn:hover { background: #e5e7eb; }
        .move-btn:disabled { background: #f9fafb; color: #d1d5db; cursor: not-allowed; }
    
        .rich-content img { max-width: 100%; height: auto; vertical-align: middle; }
        .problem img { resize: none; overflow: visible; border: none; }
        .sidebar-title { text-align: center; font-weight: normal; font-size: 1.25rem; margin-bottom: 15px; }
        
        .table-modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px; }
        .table-modal-grid label { display: block; font-weight: 500; margin-bottom: 5px; color: #374151; }
        .table-modal-grid input[type="number"], .table-modal-grid input[type="color"], .table-modal-grid input[type="text"], .table-modal-grid select { 
            width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; box-sizing: border-box; 
        }
        .table-modal-grid input[type="color"] { height: 42px; padding: 4px; }
        .table-modal-grid select { height: 42px; }

        /* Style for color picker labels */
        .color-picker-label {
            position: relative;
            cursor: pointer;
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            border: 1px solid transparent; border-radius: 4px;
            font-weight: bold;
        }
        .color-picker-label:hover { background-color: #e5e7eb; border-color: #d1d5db; }
        .color-picker-label input[type="color"] {
            position: absolute;
            width: 0; height: 0; padding: 0; border: 0; opacity: 0;
            cursor: pointer;
        }
        
        /* Hint Styles */
        .hint-btn {
            margin-top: 10px;
            background-color: #fff9c4;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 5px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .hint-btn:hover { background-color: #fff3cd; }
        .hint-box {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            border-radius: 4px;
            font-size: 0.95rem;
        }

	/* Блокування редагування зображень у режимі тестування */
        .problem div[style*="resize"], .instruction-block div[style*="resize"] {
            resize: none !important;       /* Забороняє зміну розміру */
            border: none !important;       /* Прибирає пунктирну рамку */
            overflow: visible !important;  /* Прибирає смуги прокрутки, якщо є */
        }

	/* Блокування редагування зображень у режимі перегляду та статистики */
        .modal-content img, 
        .modal-content div[style*="resize"],
        .problem img,
        .problem div[style*="resize"],
        .analysis-block img,
        .analysis-block div[style*="resize"] {
            resize: none !important;       /* Забороняє зміну розміру */
            border: none !important;       /* Прибирає рамку редагування */
            overflow: visible !important; 
            pointer-events: none;          /* Забороняє кліки та перетягування */
        }
        
        /* Але дозволяємо кліки на кнопки всередині модалки */
        .modal-content button, .problem button, .problem input, .problem label {
            pointer-events: auto !important;
        }

	/* --- ВИПРАВЛЕННЯ: Прибираємо прямокутник редагування Latex у режимах перегляду --- */
        
        /* 1. Для Банку завдань та вікна "Додати з Банку" */
        .bank-preview-content .math-node:hover {
            background-color: transparent !important;
            border-color: transparent !important;
            cursor: default !important;
        }

        /* 2. Для режиму проходження тесту (включаючи підпитання структурованих завдань) */
        .problem .math-node:hover {
            background-color: transparent !important;
            border-color: transparent !important;
            cursor: default !important;
        }

    </style>
</head>
<body>
    <!-- Global Modal for Yes/No -->
    <div id="global-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" class="text-xl font-bold mb-4">Заголовок</h2>
            <div id="modal-body" class="text-gray-600 mb-4">Текст модального вікна</div>
            <div class="modal-actions">
                <button id="modal-btn-yes" class="btn-brand">Так</button>
                <button id="modal-btn-no" class="btn-brand bg-gray-500 border-gray-500 hover:bg-gray-600">Ні</button>
            </div>
        </div>
    </div>

    <!-- Special Latex Input Modal -->
    <div id="latex-modal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-2">Вставити LaTeX формулу</h2>
            <p class="text-gray-500 text-sm mb-4">Введіть код формули (без дужок), наприклад: <code>\sqrt{x^2 + 1}</code></p>
            <textarea id="latex-input-area" class="w-full border p-2 rounded mb-4 font-mono bg-gray-50" rows="3" placeholder="\frac{a}{b}"></textarea>
            <div class="modal-actions">
                <button id="latex-btn-insert" class="btn-brand">Вставити</button>
                <button onclick="document.getElementById('latex-modal').style.display='none'" class="btn-brand bg-gray-500 border-gray-500 hover:bg-gray-600">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- Special Table Input Modal -->
    <div id="table-modal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-content">
            <h2 id="table-modal-title" class="text-xl font-bold mb-4">Вставити таблицю</h2>
            <div class="table-modal-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <!-- Row/Col -->
                <div>
                    <label for="table-rows">Рядки:</label>
                    <input type="number" id="table-rows" value="3" min="1" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label for="table-cols">Стовпці:</label>
                    <input type="number" id="table-cols" value="3" min="1" class="w-full border p-2 rounded">
                </div>
                <!-- Colors -->
                <div>
                    <label for="table-border-color">Колір контуру:</label>
                    <input type="color" id="table-border-color" value="#000000">
                </div>
                <div>
                    <label for="table-bg-color">Колір заливки:</label>
                    <input type="color" id="table-bg-color" value="#FFFFFF">
                </div>
                <!-- Width -->
                <div style="grid-column: 1 / 3">
                    <label for="table-width">Ширина:</label>
                    <input type="text" id="table-width" value="100" class="w-full border p-2 rounded">
                </div>
                <div style="grid-column: 3 / 5">
                    <label for="table-width-unit">Одиниці:</label>
                    <select id="table-width-unit" class="w-full border p-2 rounded">
                        <option value="%">%</option>
                        <option value="px">px</option>
                        <option value="cm">cm</option>
                    </select>
                </div>
                <!-- Height -->
                <div style="grid-column: 1 / 3">
                    <label for="table-height">Висота:</label>
                    <input type="text" id="table-height" value="" placeholder="auto" class="w-full border p-2 rounded">
                </div>
                <div style="grid-column: 3 / 5">
                    <label for="table-height-unit">Одиниці:</label>
                    <select id="table-height-unit" class="w-full border p-2 rounded">
                        <option value="">auto</option>
                        <option value="px">px</option>
                        <option value="cm">cm</option>
                    </select>
                </div>
                <!-- NEW Alignment Inputs -->
                <div style="grid-column: 1 / 3">
                    <label for="table-text-align">Текст гориз.:</label>
                    <select id="table-text-align" class="w-full border p-2 rounded">
                        <option value="left">Ліворуч</option>
                        <option value="center">По центру</option>
                        <option value="right">Праворуч</option>
                    </select>
                </div>
                <div style="grid-column: 3 / 5">
                    <label for="table-vertical-align">Текст верт.:</label>
                    <select id="table-vertical-align" class="w-full border p-2 rounded">
                        <option value="top">Верх</option>
                        <option value="middle">Середина</option>
                        <option value="bottom">Низ</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button id="table-btn-insert" class="btn-brand">Вставити</button>
                <button onclick="document.getElementById('table-modal').style.display='none'" class="btn-brand bg-gray-500 border-gray-500 hover:bg-gray-600">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- Reference Materials Modal -->
    <div id="reference-modal" class="modal-overlay" style="z-index: 5000; background: rgba(0,0,0,0.7); padding: 20px;">
        <button onclick="document.getElementById('reference-modal').style.display='none'; document.getElementById('reference-iframe').src='about:blank';" 
                class="absolute top-2 right-4 text-white font-bold text-5xl" 
                style="cursor: pointer; z-index: 5001; line-height: 1;">&times;</button>
        <iframe id="reference-iframe" src="about:blank" style="width: 95vw; height: 95vh; border: none; background: white;"></iframe>
    </div>

    <!-- NEW Prompt Modal for Folder Name -->
    <div id="prompt-modal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-content">
            <h2 id="prompt-modal-title" class="text-xl font-bold mb-4">Введіть назву</h2>
            <input type="text" id="prompt-modal-input" class="w-full border p-2 rounded mb-4" placeholder="Нова папка">
            <div class="modal-actions">
                <button id="prompt-modal-btn-ok" class="btn-brand">OK</button>
                <button id="prompt-modal-btn-cancel" class="btn-brand bg-gray-500 border-gray-500 hover:bg-gray-600">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app"></div>

    <!-- JAVASCRIPT APP LOGIC -->
    <script>
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        const STORAGE_KEY = 'nmtConstructorItems'; 

        window.saveTestsToStorage = function() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(window.state.items));
                
                // Зберігаємо Банк
                localStorage.setItem('nmtBankItems', JSON.stringify(window.state.bankItems));

                const cabinetData = JSON.stringify({
                    sessions: window.state.sessions,
                    results: window.state.results
                });
                localStorage.setItem('nmtCabinetData', cabinetData);
                
                return true;
            } catch (e) {
                // ... (обробка помилок без змін)
                console.error('Failed to save', e);
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    alert("УВАГА! Пам'ять браузера переповнена...");
                }
                return false;
            }
        };

        window.loadTestsFromStorage = function() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) window.state.items = JSON.parse(data);
                else window.state.items = [{ ...JSON.parse(JSON.stringify(originalNMTTest)), type: 'test', parentId: 'root' }];

                // Завантаження Банку
                const bankData = localStorage.getItem('nmtBankItems');
                if (bankData) window.state.bankItems = JSON.parse(bankData);
                else window.state.bankItems = []; // Пустий банк на старті

                const cabinetData = localStorage.getItem('nmtCabinetData');
                if (cabinetData) {
                    const parsed = JSON.parse(cabinetData);
                    window.state.sessions = parsed.sessions || [];
                    window.state.results = parsed.results || [];
                }
            } catch (e) { console.error('Failed to load', e); }
        };

        const ICONS = {
            left: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 10H3M21 6H3M21 14H3M17 18H3"/></svg>',
            center: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10H3M21 6H3M21 14H3M21 18H3"/></svg>',
            centerReal: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg>',
            right: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10H7M21 6H3M21 14H3M21 18H7"/></svg>',
            justify: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="3" y1="14" x2="21" y2="14"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>',
            bold: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>',
            italic: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>',
            underline: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg>',
            strike: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.172 16.172a4 4 0 0 1 5.656 0M5.05 19.314a8 8 0 0 1 1.586-12.036M11.95 4.686a8 8 0 0 1 10.036 10.036"></path><line x1="4" y1="12" x2="20" y2="12"></line></svg>',
            ul: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>',
            ol: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><path d="M4 6h1v4"></path><path d="M4 10h2"></path><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path></svg>',
            latex: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4l16 16"/><path d="M4 20l16-16"/><path d="M9 4h6"/><path d="M9 20h6"/></svg>',
            image: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
            table: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>',
            folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
            trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
            copy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
            link: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',
            col2: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"></path><path d="M12 3v18"></path></svg>',
            col3: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"></path><path d="M9 3v18"></path><path d="M15 3v18"></path></svg>'
        };

        const originalNMTTest = {
            id: 'nmt-demo-2024',
            title: 'Математика',
            description: 'Демонстраційний варіант НМТ-2024',
            selectedTasksInfo: 'Вибрані завдання: №1, №15, №16, №19',
            timeLimit: 7200,
            preTestDescription: 'Це детальний опис тесту, який студент бачить перед початком. <b>Успіхів!</b>',
            infoPanelContent: 'Національний мультипредметний тест обмежений у часі. Таймер праворуч показує, скільки часу залишилося до кінця роботи. Вибравши відповідь на завдання, не забудьте натиснути на "Зберегти відповідь" для кожного завдання. Якщо Ви цього не зробите, відповідь не буде збережено і зараховано. Перш ніж натиснути на "Завершити роботу над тестом", перевірте, чи зберегли всі надані відповіді.',
            referenceUrl: 'https://testportal.gov.ua/wp-content/uploads/2022/04/ZNO_Math_dovidkovy-materialy.pdf',
            blocks: [
                { id: 'instr-1', type: 'instruction', text: 'Завдання 1–15 мають по п’ять варіантів відповіді, з яких лише один правильний. Виберіть правильний, на Вашу думку, варіант відповіді й натисніть курсором на значок <span class="inline-block w-4 h-4 border-2 border-gray-400 rounded-full align-middle"></span>. Позначений Вами варіант відповіді <span class="inline-block w-4 h-4 border-2 border-gray-400 rounded-full align-middle relative"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-[#2563eb] rounded-full"></span></span> ЗБЕРЕЖІТЬ, натиснувши курсором на кнопку під завданням.' },
                {
                    id: 'task-1', type: 'single', number: 1,
                    points: 1, 
                    question: 'У першу годину роботи на телефон гарячої лінії надійшло <span class="math-node" contenteditable="false" data-latex="145">\\(145\\)</span> дзвінків, а за другу годину – на <span class="math-node" contenteditable="false" data-latex="17">\\(17\\)</span> дзвінків більше. Скільки всього дзвінків надійшло на телефон гарячої лінії за дві години роботи?',
                    options: [{ id: 'o1', text: '<span class="math-node" contenteditable="false" data-latex="307">\\(307\\)</span>' }, { id: 'o2', text: '<span class="math-node" contenteditable="false" data-latex="290">\\(290\\)</span>' }, { id: 'o3', text: '<span class="math-node" contenteditable="false" data-latex="287">\\(287\\)</span>' }, { id: 'o4', text: '<span class="math-node" contenteditable="false" data-latex="273">\\(273\\)</span>' }, { id: 'o5', text: '<span class="math-node" contenteditable="false" data-latex="162">\\(162\\)</span>' }],
                    correctId: 'o1', explanation: '<p>1) Кількість дзвінків за першу годину: <span class="math-node" contenteditable="false" data-latex="145">\\(145\\)</span>.</p><p>2) Кількість дзвінків за другу годину: <span class="math-node" contenteditable="false" data-latex="145 + 17 = 162">\\(145 + 17 = 162\\)</span>.</p><p>3) Загальна кількість: <span class="math-node" contenteditable="false" data-latex="145 + 162 = 307">\\(145 + 162 = 307\\)</span>.</p>',
                    hint: 'Знайдіть спочатку кількість дзвінків за другу годину, додавши 17 до 145.'
                },
                {
                    id: 'task-15', type: 'single', number: 15,
                    points: 1, 
                    question: 'Укажіть похідну функції <span class="math-node" contenteditable="false" data-latex="f(x)=x(x^3+1)">\\(f(x)=x(x^3+1)\\)</span>.',
                    options: [{ id: 'o1', text: '<span class="math-node" contenteditable="false" data-latex="f\'(x)=4x^3+1">\\(f\'(x)=4x^3+1\\)</span>' }, { id: 'o2', text: '<span class="math-node" contenteditable="false" data-latex="f\'(x)=4x^3">\\(f\'(x)=4x^3\\)</span>' }, { id: 'o3', text: '<span class="math-node" contenteditable="false" data-latex="f\'(x)=3x^2">\\(f\'(x)=3x^2\\)</span>' }, { id: 'o4', text: '<span class="math-node" contenteditable="false" data-latex="f\'(x)=3x^2+1">\\(f\'(x)=3x^2+1\\)</span>' }, { id: 'o5', text: '<span class="math-node" contenteditable="false" data-latex="f\'(x)=\\frac{x^5}{5}+\\frac{x^2}{2}">\\(f\'(x)=\\frac{x^5}{5}+\\frac{x^2}{2}\\)</span>' }],
                    correctId: 'o1', explanation: '<p>Спочатку розкриємо дужки: <span class="math-node" contenteditable="false" data-latex="f(x) = x \\cdot x^3 + x \\cdot 1 = x^4 + x">\\(f(x) = x \\cdot x^3 + x \\cdot 1 = x^4 + x\\)</span>.</p><p>Знайдемо похідну від суми: <span class="math-node" contenteditable="false" data-latex="f\'(x) = (x^4)\' + (x)\' = 4x^3 + 1">\\(f\'(x) = (x^4)\' + (x)\' = 4x^3 + 1\\)</span>.</p>',
                    hint: ''
                },
                { id: 'instr-2', type: 'instruction', text: 'У завданнях 16–18 до кожного з трьох фрагментів інформації, позначених цифрами, доберіть один правильний, на Вашу думку, варіант відповіді, позначений буквою. Для цього натисніть курсором на нього, а потім – на порожнє поле навпроти інформації, позначеної цифрою. Або натисніть курсором на варіант відповіді, позначений буквою, і перетягніть його на порожнє поле навпроти інформації, позначеної цифрою.<br>Ви можете змінити дібраний варіант відповіді: видаліть його, натиснувши курсором на значок <span class="inline-block w-5 h-5 bg-[#eee] border border-[#999] rounded text-center leading-4 text-sm text-gray-600 align-middle" style="line-height: 18px;">×</span>. Виберіть новий варіант відповіді. Після остаточного вибору ЗБЕРЕЖІТЬ відповідь, натиснувши курсором на кнопку під завданням.' },
                {
                    id: 'task-16', type: 'matching', number: 16,
                    pointsPerPair: 1, 
                    question: 'До кожного початку речення <span class="math-node" contenteditable="false" data-latex="(1-3)">\\((1-3)\\)</span> доберіть його закінченням <span class="math-node" contenteditable="false" data-latex="(А - Д)">\\((А - Д)\\)</span> так, щоб утворилося правильне твердження.',
                    leftLabel: 'Початок речення',
                    rightLabel: 'Закінчення речення',
                    leftItems: [{ id: 'l1', text: '1. Функція&nbsp; <span class="math-node" contenteditable="false" data-latex="y=\\sqrt{x-4}">\\(y=\\sqrt{x-4}\\)</span>' }, { id: 'l2', text: '2. Функція&nbsp; <span class="math-node" contenteditable="false" data-latex="y=2">\\(y=2\\)</span>' }, { id: 'l3', text: '3. Функція&nbsp; <span class="math-node" contenteditable="false" data-latex="y=x^3">\\(y=x^3\\)</span>' }],
                    rightItems: [{ id: 'r1', text: 'А. спадає на проміжку <span class="math-node" contenteditable="false" data-latex="(-\\infty; 0)">\\((-\\infty; 0)\\)</span>.' }, { id: 'r2', text: 'Б. не визначена в точці <span class="math-node" contenteditable="false" data-latex="x=1">\\(x=1\\)</span>.' }, { id: 'r3', text: 'В. набуває від’ємного значення в точці <span class="math-node" contenteditable="false" data-latex="x=8">\\(x=8\\)</span>.' }, { id: 'r4', text: 'Г. набуває додатного значення в точці <span class="math-node" contenteditable="false" data-latex="x=-3">\\(x=-3\\)</span>.' }, { id: 'r5', text: 'Д. є непарною.' }],
                    correctPairs: { 'l1': 'r2', 'l2': 'r4', 'l3': 'r5' }, explanation: '<p>1) <span class="math-node" contenteditable="false" data-latex="y=\\sqrt{x-4}">\\(y=\\sqrt{x-4}\\)</span>. ОДЗ: <span class="math-node" contenteditable="false" data-latex="x \\ge 4">\\(x \\ge 4\\)</span>. Точка <span class="math-node" contenteditable="false" data-latex="x=1">\\(x=1\\)</span> не входить (Б).</p>'
                },
                { id: 'instr-3', type: 'instruction', text: 'Розв’яжіть завдання 19–22. Одержані числові відповіді впишіть у спеціальне поле. Відповіді записуйте лише десятковим дробом, використовуючи крапку для відокремлення цілої і дробової частини числа. ЗБЕРЕЖІТЬ відповідь.' },
                {
                    id: 'task-19', type: 'short', number: 19,
                    points: 2, 
                    question: `На рисунку зображено <b>фрагмент</b> частини поперечного перерізу стосу дерев’яних колод. У нижньому ряду стосу <span class="math-node" contenteditable="false" data-latex="13">\\(13\\)</span> колод, а у верхньому – одна. Визначте загальну кількість колод у цьому стосі.
                    <div class="my-6 flex justify-center">
                        <svg width="250" height="180" viewBox="0 0 250 180" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="125" cy="30" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <text x="125" y="35" font-size="12" text-anchor="middle" fill="#555">1</text>
                            <circle cx="108" cy="58" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <circle cx="142" cy="58" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <text x="125" y="100" font-size="24" text-anchor="middle" fill="#333">...</text>
                            <circle cx="30" cy="150" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <circle cx="62" cy="150" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <circle cx="94" cy="150" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <text x="125" y="155" font-size="12" text-anchor="middle" fill="#333">...</text>
                            <circle cx="156" cy="150" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <circle cx="188" cy="150" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <circle cx="220" cy="150" r="15" fill="#e5e7eb" stroke="#333" stroke-width="2"/>
                            <path d="M 25 170 L 225 170" stroke="#333" stroke-width="1"/>
                            <line x1="25" y1="165" x2="25" y2="175" stroke="#333"/>
                            <line x1="225" y1="165" x2="225" y2="175" stroke="#333"/>
                            <text x="125" y="185" font-size="14" text-anchor="middle" fill="#333">13 колод</text>
                        </svg>
                    </div>`,
                    correctAnswer: '91', explanation: '<p>Арифметична прогресія: <span class="math-node" contenteditable="false" data-latex="S_n = \\frac{1+13}{2} \\cdot 13 = 91">\\(S_n = \\frac{1+13}{2} \\cdot 13 = 91\\)</span>.</p>'
                },
                { 
                    id: 'instr-4', type: 'instruction', 
                    text: 'Завдання 28–30 мають по сім варіантів відповіді, з яких лише ТРИ правильні. Виберіть правильні, на Вашу думку, варіанти відповідей і натисніть курсором на значки <span class="inline-block w-4 h-4 border-2 border-gray-500 rounded-sm align-middle"></span>. Варіанти відповідей <span class="inline-block w-4 h-4 border-2 border-blue-600 bg-blue-600 rounded-sm align-middle relative"><svg class="absolute top-0 left-0 w-full h-full text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"></path></svg></span>, позначені Вами, ЗБЕРЕЖІТЬ, натиснувши курсором на кнопку під завданням.' 
                },
                {
                    id: 'task-28', type: 'multiple', number: 28,
                    pointsPerSelection: 1, 
                    question: 'Укажіть, які з наведених тверджень є правильними.',
                    options: [
                        { id: 'o1', text: 'Твердження 1 (Правильне)' }, 
                        { id: 'o2', text: 'Твердження 2 (Неправильне)' }, 
                        { id: 'o3', text: 'Твердження 3 (Правильне)' }, 
                        { id: 'o4', text: 'Твердження 4 (Неправильне)' }, 
                        { id: 'o5', text: 'Твердження 5 (Правильне)' },
                        { id: 'o6', text: 'Твердження 6 (Неправильне)' },
                        { id: 'o7', text: 'Твердження 7 (Неправильне)' }
                    ],
                    correctIds: ['o1', 'o3', 'o5'], 
                    explanation: '<p>Правильними є твердження 1, 3 та 5.</p>'
                },
                // NEW Dropdown Instruction
                { 
                    id: 'instr-dropdown', type: 'instruction', 
                    text: 'У завданнях 29 і 30 до кожного з трьох фрагментів інформації доберіть із випадного списку один правильний, на Вашу думку, варіант відповіді. Ви можете замінити вибраний варіант відповіді на інший. Після остаточного вибору ЗБЕРЕЖІТЬ відповідь, натиснувши курсором на кнопку під завданням.' 
                }
            ]
        };

        // STATE
        window.state = {
            view: 'dashboard',
            currentSection: 'tests', // 'tests', 'cabinet', або 'bank'
            items: [], 
            bankItems: [], // НОВЕ: Елементи банку (папки і завдання)
            currentBankFolderId: 'root', // НОВЕ: Поточна папка в банку
            editingBankTaskId: null, // НОВЕ: ID завдання, яке редагується в банку 
            sessions: [], // Тут будуть відкриті сесії тестування
            results: [],  // Тут будуть збережені відповіді учнів
            currentFolderId: 'root', 
            activeTestId: null,
            activeSessionId: null, // ID поточної сесії для учня
            studentName: null,     // Ім'я учня
            editorDraft: null,
            runnerState: {}
        };


        let timerInterval;
        window.editingTableElement = null; // NEW: Track table being edited

        // --- NEW: UNDO HISTORY STACK ---
        window.editorHistory = [];
        
        window.saveHistory = function() {
            // Зберігаємо історію, тільки якщо є активний редактор
            if (window.activeEditorElement) {
                // Обмежуємо глибину історії
                if (window.editorHistory.length > 50) window.editorHistory.shift();
                
                window.editorHistory.push({
                    editor: window.activeEditorElement,
                    html: window.activeEditorElement.innerHTML
                });
                console.log("History saved. Stack size:", window.editorHistory.length);
            }
        };

window.undoLastAction = function() {
            if (window.editorHistory.length > 0) {
                const lastState = window.editorHistory.pop();
                
                // Спроба знайти редактор: або збережений, або активний зараз
                let targetEditor = lastState.editor;
                
                // Якщо збереженого редактора вже немає на сторінці, шукаємо поточний активний
                if (!targetEditor || !document.body.contains(targetEditor)) {
                    if (window.activeEditorElement && document.body.contains(window.activeEditorElement)) {
                        targetEditor = window.activeEditorElement;
                    } else {
                        // Якщо зовсім не знайшли, куди повертати - шукаємо перший-ліпший видимий редактор
                        targetEditor = document.querySelector('.rich-content');
                    }
                }

                if (targetEditor) {
                    targetEditor.innerHTML = lastState.html;
                    // Відновлюємо фокус, щоб можна було продовжувати писати
                    targetEditor.focus();
                    console.log("Undo performed.");
                } 
            } else {
                console.log("History empty.");
            }
        };

	// --- ВИПРАВЛЕННЯ: Довідкові матеріали ---
        window.showReferenceMaterials = function() {
            const test = window.findItem(window.state.activeTestId);
            if (!test || !test.referenceUrl) {
                alert("Для цього тесту не вказано посилання на довідкові матеріали.");
                return;
            }
            const iframe = document.getElementById('reference-iframe');
            if (iframe) {
                iframe.src = test.referenceUrl;
                document.getElementById('reference-modal').style.display = 'block';
            }
        };

	// Функція для розбиття блоків на сторінки
        window.getTestPages = function(blocks) {
            let pages = [];
            let currentPage = [];
            
            blocks.forEach(b => {
                if (b.type === 'pageBreak') {
                    // Якщо зустріли розрив, зберігаємо поточну сторінку (якщо вона не пуста)
                    if (currentPage.length > 0) pages.push(currentPage);
                    currentPage = [];
                } else {
                    currentPage.push(b);
                }
            });
            
            // Додаємо останню сторінку
            if (currentPage.length > 0) pages.push(currentPage);
            
            // Якщо тест пустий або складається тільки з розривів
            if (pages.length === 0) pages.push([]);
            
            return pages;
        };

	// Функція для розрахунку параметрів бічної панелі
        window.getSidebarConfig = function(taskCount) {
            // Якщо завдань мало (до 30) - 3 колонки, великі кнопки
            if (taskCount <= 30) {
                return { cols: 3, size: '40px', fontSize: '14px' };
            } 
            // Середня кількість (31-40) - 4 колонки, менші кнопки
            else if (taskCount <= 40) {
                return { cols: 4, size: '32px', fontSize: '12px' };
            } 
            // Багато завдань (41-50) - 5 колонок, маленькі кнопки
            else {
                return { cols: 5, size: '26px', fontSize: '11px' };
            }
        };

        // --- INIT ---
        window.init = function() {
            window.loadTestsFromStorage();
            window.state.currentSection = localStorage.getItem('nmtCurrentSection') || 'tests'; 
            
            // ПЕРЕВІРКА URL
            const urlParams = new URLSearchParams(window.location.search);
            const studentSessionId = urlParams.get('student_session');
            
            if (studentSessionId) {
                // 1. Спочатку шукаємо сесію в базі
                const session = window.state.sessions.find(s => s.id === studentSessionId);
                
                if (session && session.isActive) {
                    window.state.activeSessionId = studentSessionId;
                    
                    // 2. ПЕРЕВІРКА: Чи є збережений прогрес (незавершений тест)
                    const savedProgress = localStorage.getItem('nmtProgress_' + studentSessionId);
                    
                    if (savedProgress) {
                        try {
                            const parsed = JSON.parse(savedProgress);
                            window.state.studentName = parsed.studentName;
                            window.state.activeTestId = parsed.testId;
                            
                            window.state.runnerState = {
                                answers: parsed.answers,
                                startTime: parsed.startTime
                            };

                            // --- ВИПРАВЛЕННЯ ДЛЯ F5 (Оновлення) ---
                            // Замість автоматичного старту, показуємо екран "Продовжити"
                            // Це дозволяє знову активувати повний екран коректно
                            window.state.view = 'student-login'; 
                            
                            // Чекаємо рендеру, потім міняємо текст кнопки і поведінку
                            setTimeout(() => {
                                const container = document.getElementById('app');
                                if (container) {
                                    container.innerHTML = `
                                        <div class="min-h-screen flex items-center justify-center bg-gray-100">
                                            <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
                                                <h1 class="text-2xl font-bold mb-4 text-blue-600">Тест перервано</h1>
                                                <p class="text-gray-600 mb-6">Ви оновили сторінку. Натисніть кнопку нижче, щоб продовжити виконання тесту.</p>
                                                <div class="mb-4 text-left p-4 bg-gray-50 rounded">
                                                    <p><b>Учень:</b> ${window.state.studentName}</p>
                                                </div>
                                                <button onclick="window.confirmStudentLogin()" class="w-full btn-brand py-3 text-lg">Продовжити тестування ▶</button>
                                            </div>
                                        </div>
                                    `;
                                    // Заповнюємо прихований інпут, щоб confirmStudentLogin спрацював коректно
                                    const hiddenInput = document.createElement('input');
                                    hiddenInput.id = 'student-name-input';
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.value = window.state.studentName;
                                    container.appendChild(hiddenInput);
                                }
                            }, 50);

                            return; 
                        } catch (e) {
                            console.error("Помилка відновлення", e);
                        }
                    }
                    
                    // Якщо прогресу немає - показуємо логін
                    window.state.view = 'student-login';
                } else {
                    alert('Цей тест більше не доступний або посилання невірне.');
                    window.location.href = window.location.pathname; 
                    return;
                }
            }

            window.renderApp();
            
            // Слухачі подій (залиште старі)
            document.addEventListener('paste', window.handlePaste);
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault(); 
                    window.undoLastAction();
                }
            });

	    document.addEventListener('paste', window.handlePaste);
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault(); 
                    window.undoLastAction();
                }
            });

            // 1. Mouse Move to show cursors
            document.addEventListener('mousemove', function(e) {
                if (resizeState.isResizing) {
                    if (resizeState.type === 'col') {
                        const dx = e.clientX - resizeState.startX;
                        resizeState.element.style.width = (resizeState.startWidth + dx) + 'px';
                    } else if (resizeState.type === 'row') {
                        const dy = e.clientY - resizeState.startY;
                        resizeState.element.style.height = (resizeState.startHeight + dy) + 'px';
                    }
                    return;
                }

                // Only active inside rich-content editor
                if (!e.target.closest('.rich-content')) return;
                
                const cell = e.target.closest('td, th');
                if (!cell) return;

                const rect = cell.getBoundingClientRect();
                const nearRight = (rect.right - e.clientX) < 5;
                const nearBottom = (rect.bottom - e.clientY) < 5;

                if (nearRight) {
                    cell.style.cursor = 'col-resize';
                } else if (nearBottom) {
                    cell.style.cursor = 'row-resize';
                } else {
                    cell.style.cursor = 'text'; // or auto
                }
            });

            // 2. Mouse Down (Right Click) to start resize
            document.addEventListener('mousedown', function(e) {
                // Only active inside rich-content
                if (!e.target.closest('.rich-content')) return;
                
                const cell = e.target.closest('td, th');
                if (!cell) return;

                // Check if cursor is in resize mode based on position
                // Re-calculate because style.cursor might lag
                const rect = cell.getBoundingClientRect();
                const nearRight = (rect.right - e.clientX) < 5;
                const nearBottom = (rect.bottom - e.clientY) < 5;

                // Check for LEFT CLICK (button 0) and near border
                if (e.button === 0 && (nearRight || nearBottom)) {
                    e.preventDefault(); // Prevent text selection
                    e.stopPropagation();

                    resizeState.isResizing = true;
                    resizeState.element = cell;
                    resizeState.startX = e.clientX;
                    resizeState.startY = e.clientY;
                    resizeState.startWidth = cell.offsetWidth;
                    resizeState.startHeight = cell.offsetHeight;
                    resizeState.type = nearRight ? 'col' : 'row';
                }
            });

            // 3. Prevent Context Menu if Resizing
            document.addEventListener('contextmenu', function(e) {
                if (resizeState.isResizing) {
                    e.preventDefault();
                }
            });

            // 4. Mouse Up to stop resize
            document.addEventListener('mouseup', function(e) {
                if (resizeState.isResizing) {
                    resizeState.isResizing = false;
                    resizeState.element = null;
                    // Ensure cursor resets
                    document.body.style.cursor = 'default';
                }
            });
	// ЗАХИСТ ВІД ВИПАДКОВОГО ОНОВЛЕННЯ СТОРІНКИ
            window.addEventListener('beforeunload', function (e) {
                // Якщо ми в редакторі, показуємо попередження
                if (window.state.view === 'editor') {
                    e.preventDefault();
                    e.returnValue = ''; // Стандарт для сучасних браузерів, щоб викликати діалог
                    return '';
                }
            });
        };

        // --- ROUTING & RENDERING ---
        window.renderApp = function() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            // Стилі для різних видів
            if (window.state.view === 'runner') {
                document.body.style.paddingTop = '260px';
                document.body.style.backgroundColor = '#ffffff';
            } else if (window.state.view === 'student-login') {
                document.body.style.paddingTop = '0px';
                document.body.style.backgroundColor = '#f3f4f6';
            } else { 
                document.body.style.paddingTop = '40px';
                document.body.style.backgroundColor = '#f3f4f6';
            }

            if (window.state.view === 'dashboard') window.renderDashboard(app);
            else if (window.state.view === 'editor') window.renderEditor(app);
            else if (window.state.view === 'pre-test') window.renderPreTest(app);
            else if (window.state.view === 'runner') window.renderRunner(app);
            else if (window.state.view === 'student-login') window.renderStudentLogin(app);
            
            // ВИПРАВЛЕННЯ LATEX: Запускаємо з невеликою затримкою, щоб гарантувати обробку
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            } else {
                // Якщо MathJax ще не завантажився (при рефреші), пробуємо через 0.5 сек
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise();
                    }
                }, 500);
            }
        };

        // --- DASHBOARD ---
        window.renderDashboard = function(container) {
            // Перевірка: яку вкладку малювати
            if (window.state.currentSection === 'cabinet') {
                window.renderCabinet(container);
                return;
            }

	    // НОВЕ: Перехід до Банку
            if (window.state.currentSection === 'bank') {
                window.renderBank(container);
                return;
            }

            // --- Стандартний вигляд "Мої тести" ---
            const currentItems = window.state.items.filter(item => item.parentId === window.state.currentFolderId);
            const folders = currentItems.filter(item => item.type === 'folder').sort((a,b) => a.title.localeCompare(b.title));
            const tests = currentItems.filter(item => item.type === 'test').sort((a,b) => a.title.localeCompare(b.title));
            const breadcrumbsHtml = window.getBreadcrumbsHtml();

            container.innerHTML = `
                <div class="max-w-6xl mx-auto p-6">
                    <div class="flex gap-4 mb-8 border-b pb-2">
                        <button onclick="window.switchSection('tests')" class="text-xl font-bold border-b-2 border-[#FF2938] pb-2 px-4 text-[#FF2938]">Мої тести</button>
                        <button onclick="window.switchSection('bank')" class="text-xl font-bold text-gray-500 hover:text-gray-800 pb-2 px-4">Банк завдань</button>
                        <button onclick="window.switchSection('cabinet')" class="text-xl font-bold text-gray-500 hover:text-gray-800 pb-2 px-4">Кабінет тестування</button>
                    </div>

                    <div class="flex gap-2 flex-wrap justify-end">
                            <button onclick="window.exportFullBackup()" class="spa-btn border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" title="Зберегти всі тести у файл">💾 Зберегти у файл</button>
                            <button onclick="window.triggerImport()" class="spa-btn border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" title="Завантажити тести з файлу">📂 Відкрити файл</button>
                            <input type="file" id="import-file-input" style="display: none;" accept=".json" onchange="window.importFullBackup(event)">
                            
                            <div class="w-px bg-gray-300 mx-1"></div> <button onclick="window.createNewFolder()" class="spa-btn spa-btn-secondary">Створити папку</button>
                            <button onclick="window.createNewTest()" class="spa-btn spa-btn-primary">Створити тест</button>
                        </div>

                    <div class="breadcrumbs mb-6">${breadcrumbsHtml}</div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                        ${folders.map(item => `
                            <div class="folder-card" onclick="window.openFolder('${item.id}')" draggable="true" ondragstart="window.dashDragStart(event, '${item.id}')" ondragover="window.dashDragOver(event)" ondrop="window.dashDrop(event, '${item.id}')">
                                <span class="folder-icon">${ICONS.folder}</span>
                                <span class="folder-title">${item.title}</span>
                                <div class="flex gap-1">
                                    <button onclick="window.renameItem(event, '${item.id}')" class="spa-btn text-blue-600 hover:bg-blue-50 p-2">${ICONS.edit}</button>
                                    <button onclick="window.deleteItem(event, '${item.id}')" class="spa-btn text-red-600 hover:bg-red-50 p-2">${ICONS.trash}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="grid gap-6">
                        ${tests.map(t => `
                            <div class="spa-card flex justify-between items-center" draggable="true" ondragstart="window.dashDragStart(event, '${t.id}')">
                                <div><h2 class="text-xl font-bold">${t.title}</h2><p class="text-gray-500">${t.description || ''}</p></div>
                                <div class="flex gap-2">
                                    <button onclick="window.runTest('${t.id}')" class="spa-btn bg-green-600 text-white hover:bg-green-700 border-green-600">Пройти</button>
                                    <button onclick="window.openTestForSession('${t.id}')" class="spa-btn bg-purple-600 text-white hover:bg-purple-700 border-purple-600" title="Відкрити доступ для учнів">Відкрити тест</button>
                                    <button onclick="window.editTest('${t.id}')" class="spa-btn spa-btn-secondary">Редагувати</button>
                                    <button onclick="window.deleteItem(event, '${t.id}')" class="spa-btn text-red-600 hover:bg-red-50 p-2">${ICONS.trash}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        };

	// --- CABINET LOGIC ---
        
        // 1. Відкрити тест (створити сесію)
        window.openTestForSession = function(testId) {
            const test = window.findItem(testId);
            
            // ПИТАННЯ ПРО ПОВНИЙ ЕКРАН
            const useFullscreen = confirm(
                `Відкрити тест "${test.title}" для учнів?\n\n` + 
                `Натисніть "ОК", щоб вимагати ПОВНОЕКРАННИЙ режим (суворий контроль).\n` +
                `Натисніть "Скасувати", щоб дозволити звичайний режим.`
            );

            const sessionId = uuid();
            const session = {
                id: sessionId,
                testId: testId,
                testTitle: test.title,
                dateOpened: new Date().toLocaleString(),
                isActive: true,
                requiresFullscreen: useFullscreen // Зберігаємо налаштування
            };
            window.state.sessions.push(session);
            window.saveTestsToStorage();
            
            // Переходимо в кабінет
            alert(`Тест відкрито! Режим: ${useFullscreen ? 'СУВОРИЙ (Повний екран)' : 'Звичайний'}. Переходимо в кабінет.`);
            window.state.currentSection = 'cabinet';
            window.renderApp();
        };

        // 2. Рендер Кабінету
        window.renderCabinet = function(container) {
            // Очищаємо попередній таймер
            if (window.cabinetInterval) clearInterval(window.cabinetInterval);

            const drawContent = () => {
                const sessions = window.state.sessions.sort((a,b) => b.isActive - a.isActive);
                container.dataset.resultsCount = window.state.results.length;

                container.innerHTML = `
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="flex gap-4 mb-8 border-b pb-2">
                        <button onclick="window.switchSection('tests')" class="text-xl font-bold text-gray-500 hover:text-gray-800 pb-2 px-4">Мої тести</button>
                        <button onclick="window.switchSection('bank')" class="text-xl font-bold text-gray-500 hover:text-gray-800 pb-2 px-4">Банк завдань</button>
                        <button onclick="window.switchSection('cabinet')" class="text-xl font-bold border-b-2 border-[#FF2938] pb-2 px-4 text-[#FF2938]">Кабінет тестування</button>
                    </div>

                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Журнал тестувань</h2>
                            <span class="text-sm text-green-600 animate-pulse">● Автооновлення увімкнено</span>
                        </div>

                        ${sessions.length === 0 ? '<p class="text-gray-500">Поки що немає відкритих тестів.</p>' : ''}

                        <div class="grid gap-8">
                            ${sessions.map(s => {
                                const finishedResults = window.state.results.filter(r => r.sessionId === s.id);
                                let activeRows = '';
                                
                                if (s.isActive) {
                                    const rawProgress = localStorage.getItem('nmtProgress_' + s.id);
                                    if (rawProgress) {
                                        try {
                                            const p = JSON.parse(rawProgress);
                                            const alreadyFinished = finishedResults.find(r => r.studentName === p.studentName);
                                            
                                            if (!alreadyFinished) {
                                                const startTime = new Date(p.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                                activeRows = `
                                                    <tr class="border-b bg-yellow-50 animate-pulse">
                                                        <td class="p-2 font-bold text-gray-700">
                                                            👤 ${p.studentName}
                                                            <span class="ml-2 text-xs bg-yellow-200 text-yellow-800 px-1 rounded">ВИКОНУЄ</span>
                                                        </td>
                                                        <td class="p-2 text-gray-500">Розпочато о ${startTime}</td>
                                                        <td class="p-2 text-gray-400 italic">в процесі...</td>
                                                        <td class="p-2 flex gap-3">
                                                            <button onclick="window.deleteActiveAttempt('${s.id}')" class="text-red-600 hover:underline font-bold" title="Анулювати спробу">✕ Видалити</button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }
                                        } catch(e) {}
                                    }
                                }

                                const link = `${window.location.href.split('?')[0]}?student_session=${s.id}`;

                                return `
                                <div class="bg-white border ${s.isActive ? 'border-l-4 border-l-green-500' : 'border-gray-200 opacity-75'} rounded shadow p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-xl font-bold flex items-center gap-2">
                                                ${s.testTitle}
                                                ${s.isActive 
                                                    ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">ВІДКРИТО</span>' 
                                                    : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">ЗАВЕРШЕНО</span>'}
                                            </h3>
                                            <p class="text-sm text-gray-500">Створено: ${s.dateOpened}</p>
                                        </div>
                                        <div class="flex flex-col gap-2 items-end">
                                            <button onclick="window.showSessionStatistics('${s.id}')" class="btn-brand bg-purple-600 border-purple-600 hover:bg-purple-700 py-1 px-3 text-sm flex items-center gap-1">📊 Статистика завдань</button>
                                            ${s.isActive ? `
                                                <button onclick="window.copyLink('${link}')" class="text-blue-600 hover:underline text-sm font-bold">📋 Копіювати посилання</button>
                                                <button onclick="window.startStudentMode('${s.id}')" class="btn-brand bg-blue-600 border-blue-600 hover:bg-blue-700 py-1 px-3 text-sm">👤 Запустити тут</button>
                                                <button onclick="window.closeSession('${s.id}')" class="text-red-600 hover:underline text-sm mt-2">🔒 Закрити тест</button>
                                            ` : `
                                                <button onclick="window.deleteSession('${s.id}')" class="text-red-600 hover:underline text-sm">🗑️ Видалити журнал</button>
                                            `}
                                        </div>
                                    </div>

                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 border-b">
                                                    <th class="p-2">Учень</th>
                                                    <th class="p-2">Дата</th>
                                                    <th class="p-2">Результат</th>
                                                    <th class="p-2">Дії</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${activeRows}
                                                ${finishedResults.length > 0 ? finishedResults.map(res => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2 font-bold">${res.studentName}</td>
                                                        <td class="p-2 text-gray-500">${res.timestamp}</td>
                                                        <td class="p-2"><span class="font-bold text-lg">${res.score}</span> / ${res.maxScore}</td>
                                                        <td class="p-2 flex gap-3">
                                                            <button onclick="window.viewStudentDetails('${res.id}')" class="text-blue-600 hover:underline font-bold">👁 Перегляд</button>
                                                            <button onclick="window.deleteStudentResult('${res.id}')" class="text-red-600 hover:underline" title="Видалити">🗑</button>
                                                        </td>
                                                    </tr>
                                                `).join('') : (activeRows ? '' : `<tr><td colspan="4" class="p-4 text-center text-gray-400 italic">Ще ніхто не завершив тест</td></tr>`)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            };

            drawContent();

            window.cabinetInterval = setInterval(() => {
                // ВИПРАВЛЕННЯ: Тепер перевіряємо ще й window.state.view
                // Якщо ми в режимі 'runner' (перегляд студента) або 'statistics' (хоча статистика в модалці),
                // таймер не повинен працювати.
                if (window.state.currentSection !== 'cabinet' || window.state.view !== 'dashboard') {
                    clearInterval(window.cabinetInterval);
                    return;
                }
                
                const rawData = localStorage.getItem('nmtCabinetData');
                if (rawData) {
                    const parsed = JSON.parse(rawData);
                    const newResults = parsed.results || [];
                    const hasActiveSessions = window.state.sessions.some(s => s.isActive);
                    
                    if (newResults.length !== window.state.results.length || hasActiveSessions) {
                        window.state.results = newResults;
                        window.state.sessions = parsed.sessions || [];
                        drawContent();
                    }
                }
            }, 3000);
        };

        // Допоміжні функції Кабінету
	window.deleteStudentResult = function(resultId) {
            if(confirm('Ви впевнені, що хочете видалити результат цього учня?')) {
                window.state.results = window.state.results.filter(r => r.id !== resultId);
                window.saveTestsToStorage();
                window.renderApp();
            }
        };	

        window.closeSession = function(sid) {
            if(confirm('Якщо закрити тест, учні більше не зможуть його проходити за цим посиланням. Продовжити?')) {
                const s = window.state.sessions.find(x => x.id === sid);
                if(s) s.isActive = false;
                window.saveTestsToStorage();
                window.renderApp();
            }
        };

        window.deleteSession = function(sid) {
            if(confirm('Видалити цей журнал і всі результати? Це неможливо відновити.')) {
                window.state.sessions = window.state.sessions.filter(x => x.id !== sid);
                window.state.results = window.state.results.filter(x => x.sessionId !== sid);
                window.saveTestsToStorage();
                window.renderApp();
            }
        };

        window.copyLink = function(text) {
            navigator.clipboard.writeText(text).then(() => alert('Посилання скопійовано! Надішліть його учню, якщо він має доступ до цього файлу, або відкрийте на цьому пристрої.'));
        };

        window.viewStudentDetails = function(resultId) {
            const res = window.state.results.find(r => r.id === resultId);
            if(!res) return;

            const session = window.state.sessions.find(s => s.id === res.sessionId);
            if(!session) return alert("Сесію не знайдено");

            window.state.activeTestId = session.testId;
            window.state.activeSessionId = null; 
            window.state.studentName = res.studentName;
            
            window.state.runnerState = {
                isFinished: true, 
                answers: JSON.parse(JSON.stringify(res.answers)),
                timerVisible: false,
                currentPage: 0 // ВАЖЛИВО: Додано для підтримки пагінації
            };
            
            window.state.isReviewMode = true; 
            window.state.view = 'runner';
            window.renderApp();
        };

        // Функція для візуалізації відповідей у режимі перегляду
        window.highlightAnswersInReview = function() {
            const answers = window.state.runnerState.answers;
            const test = window.findItem(window.state.activeTestId);

            // Чекаємо трохи, щоб HTML точно встиг намалюватися
            setTimeout(() => {
                test.blocks.forEach(b => {
                    // 1. Показуємо пояснення
                    const an = document.getElementById(`an-${b.id}`);
                    const hasExplanation = b.explanation && b.explanation.replace(/<[^>]*>/g, '').trim().length > 0;
                    if(an && hasExplanation) an.style.display = 'block';
                    else if (an) an.style.display = 'none';
                    
                    // 2. Блокуємо інпути
                    const blk = document.getElementById(`blk-${b.id}`);
                    if(blk) blk.querySelectorAll('input, button, select').forEach(el => el.disabled = true);
                    
                    // 3. Підсвічуємо відповіді користувача
                    const userAns = answers[b.id]?.final;

                    if (b.type === 'single' && userAns) {
                        // userAns - це ID варіанту
                        const opt = document.getElementById(`opt-${userAns}`);
                        if(opt) {
                            const radio = opt.querySelector('input[type="radio"]');
                            if(radio) radio.checked = true;
                            opt.classList.add('selected');
                            // Фарбуємо в червоний, якщо неправильно (тільки якщо вибрано)
                            if (userAns !== b.correctId) {
                                opt.style.backgroundColor = '#fee2e2'; 
                                opt.style.borderColor = '#ef4444';
                            } else {
                                opt.style.backgroundColor = '#dcfce7'; // Зелений, якщо правильно
                                opt.style.borderColor = '#22c55e';
                            }
                        }
                    }
                    else if (b.type === 'multiple' && Array.isArray(userAns)) {
                        userAns.forEach(oid => {
                             const opt = document.getElementById(`opt-${oid}`);
                             if(opt) {
                                 const checkbox = opt.querySelector('input[type="checkbox"]');
                                 if(checkbox) checkbox.checked = true;
                                 opt.classList.add('selected');
                                 
                                 // Перевірка на правильність конкретного пункту
                                 if (b.correctIds && !b.correctIds.includes(oid)) {
                                    opt.style.backgroundColor = '#fee2e2'; // Червоний, якщо зайвий
                                 } else {
                                    opt.style.backgroundColor = '#dcfce7'; // Зелений, якщо правильно вгадав
                                 }
                             }
                        });
                    }
                    else if (b.type === 'structured' && userAns) {
                        b.items.forEach(item => {
                            const input = document.getElementById(`in-${b.id}-${item.id}`);
                            const val = userAns[item.id];
                            if(input && val !== undefined) {
                                input.value = val;
                                let cleanUser = val.toString().replace(',', '.').trim();
                                let cleanCorrect = item.correctAnswer.toString().replace(',', '.').trim();
                                if (cleanUser != cleanCorrect) {
                                    input.style.backgroundColor = '#fee2e2';
                                    input.style.borderColor = 'red';
                                } else {
                                    input.style.backgroundColor = '#ecfdf5';
                                    input.style.borderColor = 'green';
                                }
                            }
                        });
                    }
                    else if (b.type === 'short' && userAns) {
                        const input = document.getElementById(`in-${b.id}`);
                        if(input) {
                            input.value = userAns;
                            let cleanUser = userAns.toString().replace(',', '.').trim();
                            let cleanCorrect = b.correctAnswer.toString().replace(',', '.').trim();
                            if(cleanUser != cleanCorrect) input.style.backgroundColor = '#fee2e2';
                            else input.style.backgroundColor = '#ecfdf5';
                        }
                    }
                    else if (b.type === 'dropdown' && userAns) {
                        for(const [ddId, val] of Object.entries(userAns)) {
                            const sel = document.getElementById(`dd-input-${b.id}-${ddId}`);
                            if(sel) sel.value = val;
                        }
                    }
                    else if (b.type === 'matching' && userAns) {
                        for (const [leftId, rightId] of Object.entries(userAns)) {
                            const slot = document.getElementById(`slot-${b.id}-${leftId}`);
                            const rightItem = blk.querySelector(`.dnd-draggable[data-rid="${rightId}"]`);
                            if (slot && rightItem) slot.appendChild(rightItem);
                        }
                    }
                });
            }, 200); // Збільшена затримка для надійності
            
            // Приховуємо панель таймера
            const topPanel = document.getElementById('top-panel');
            if(topPanel) topPanel.classList.add('hidden-panel');
            document.body.style.paddingTop = '60px';
        };

	// --- STUDENT MODE ---

        // Запуск через кнопку в кабінеті
        window.startStudentMode = function(sessionId) {
            window.state.activeSessionId = sessionId;
            window.state.view = 'student-login';
            window.renderApp();
        };

        // Екран логіну
        window.renderStudentLogin = function(container) {
            const session = window.state.sessions.find(s => s.id === window.state.activeSessionId);
            if (!session || !session.isActive) {
                container.innerHTML = `<div class="p-10 text-center text-red-600 font-bold text-2xl">Цей тест закрито або не знайдено.</div>`;
                return;
            }

            container.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100">
                    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
                        <h1 class="text-2xl font-bold mb-2">${session.testTitle}</h1>
                        <p class="text-gray-600 mb-6">Введіть свої дані для початку тестування</p>
                        
                        <div class="mb-4 text-left">
                            <label class="block text-sm font-bold mb-1">Прізвище та ім'я</label>
                            <input type="text" id="student-name-input" class="w-full border p-3 rounded text-lg" placeholder="Петренко Іван">
                        </div>

                        <button onclick="window.confirmStudentLogin()" class="w-full btn-brand py-3 text-lg">Розпочати тест</button>
                    </div>
                </div>
            `;
        };

        window.confirmStudentLogin = function() {
            const name = document.getElementById('student-name-input').value.trim();
            if (!name) return alert("Будь ласка, введіть ім'я!");
            
            window.state.studentName = name;
            
            const session = window.state.sessions.find(s => s.id === window.state.activeSessionId);
            window.state.activeTestId = session.testId;
            
            // ЛОГІКА ПОВНОГО ЕКРАНУ
            if (session.requiresFullscreen) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().then(() => {
                        window.startActualTest();
                    }).catch(err => {
                        alert("Не вдалося увійти в повноекранний режим. Дозвольте це в налаштуваннях браузера.");
                    });
                } else {
                    // Для Safari/iOS, де API може відрізнятися, просто запускаємо
                    window.startActualTest(); 
                }
            } else {
                window.startActualTest(); 
            }
        };

        // Допоміжна функція перемикання
        window.switchSection = function(sec) {
            window.state.currentSection = sec;
            localStorage.setItem('nmtCurrentSection', sec);
            window.renderApp();
        };

        // --- DASHBOARD DRAG AND DROP ---
        window.dashDragStart = function(event, id) {
            event.dataTransfer.setData("text/plain", id);
            event.dataTransfer.effectAllowed = "move";
        };

        window.dashDragOver = function(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
            event.dataTransfer.dropEffect = "move";
        };

        window.dashDragLeave = function(event) {
            event.currentTarget.classList.remove('drag-over');
        };

        window.dashDrop = function(event, targetFolderId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const itemId = event.dataTransfer.getData("text/plain");
            
            // Check if dropped on itself
            if (itemId === targetFolderId) return;
            
            const item = window.findItem(itemId);
            if (!item) return;

            // Prevent cycle (moving folder into itself or its children)
            if (item.type === 'folder') {
                if (window.isDescendant(itemId, targetFolderId)) {
                    alert("Не можна перемістити папку в саму себе або її підпапку.");
                    return;
                }
            }

            item.parentId = targetFolderId;
            window.saveTestsToStorage();
            window.renderApp();
        };

        window.isDescendant = function(parentId, childId) {
            if (parentId === childId) return true;
            const child = window.findItem(childId);
            if (child && child.parentId) {
                return window.isDescendant(parentId, child.parentId);
            }
            return false;
        };

        // --- NEW Dashboard Helpers ---
        window.findItem = function(id) {
            if (id === 'root') return { id: 'root', title: 'Головна', parentId: null };
            return window.state.items.find(i => i.id === id);
        };

        window.getBreadcrumbsHtml = function() {
            let path = [];
            let currentId = window.state.currentFolderId;
            
            while(currentId !== null && currentId !== undefined) {
                const item = window.findItem(currentId);
                if (!item) break; 
                path.push(item);
                currentId = item.parentId;
            }
            
            path.reverse(); 

            return path.map((item, index) => {
                // Allow dropping on breadcrumbs to move items UP the hierarchy
                const dropAttrs = `
                    ondragover="window.dashDragOver(event)"
                    ondragleave="window.dashDragLeave(event)"
                    ondrop="window.dashDrop(event, '${item.id}')"
                `;
                
                if (index === path.length - 1) {
                    return `<span class="breadcrumb-current" ${dropAttrs}>${item.title}</span>`;
                }
                return `<a href="#" class="breadcrumb-link" ${dropAttrs} onclick="event.preventDefault(); window.openFolder('${item.id}')">${item.title}</a> <span class="breadcrumb-separator">/</span>`;
            }).join('');
        };

        window.openFolder = function(folderId) {
            window.state.currentFolderId = folderId;
            window.renderApp();
        };

        window.createNewFolder = function() {
            window.showPrompt("Введіть назву папки", "Нова папка", (folderName) => {
                if (folderName) { 
                    const newFolder = {
                        id: uuid(),
                        type: 'folder',
                        parentId: window.state.currentFolderId,
                        title: folderName
                    };
                    window.state.items.push(newFolder);
                    window.saveTestsToStorage();
                    window.renderApp();
                }
            });
        };

        // New Rename function
        window.renameItem = function(event, id) {
            event.stopPropagation();
            const item = window.findItem(id);
            if(!item) return;

            window.showPrompt("Перейменувати папку", item.title, (newName) => {
                if (newName) {
                    item.title = newName;
                    window.saveTestsToStorage();
                    window.renderApp();
                }
            });
        };
        // --- End of NEW Dashboard Helpers ---

        window.createNewTest = function() {
            const newTest = { 
                id: uuid(), 
                type: 'test',
                parentId: window.state.currentFolderId,
                title: 'Новий тест', 
                description: '', 
                preTestDescription: 'Опис перед тестом...',
                infoPanelContent: 'Національний мультипредметний тест обмежений у часі. Таймер праворуч показує, скільки часу залишилося до кінця роботи. Вибравши відповідь на завдання, не забудьте натиснути на "Зберегти відповідь" для кожного завдання. Якщо Ви цього не зробите, відповідь не буде збережено і зараховано. Перш ніж натиснути на "Завершити роботу над тестом", перевірте, чи зберегли всі надані відповіді.',
                referenceUrl: '', 
                timeLimit: 3600, 
                blocks: [] 
            };
            window.state.items.push(newTest);
            window.saveTestsToStorage(); 
            window.editTest(newTest.id);
        };

        // REFACTORED DELETE ITEM
        window.deleteItem = function(event, id) {
            event.stopPropagation(); 

            const item = window.findItem(id);
            if (!item) return;

            if (item.type === 'test') {
                window.showModal('Видалення тесту', `Видалити тест "${item.title}"?`, () => {
                    window.state.items = window.state.items.filter(i => i.id !== id);
                    window.saveTestsToStorage();
                    window.renderApp();
                });
            } else if (item.type === 'folder') {
                const idsToDelete = [id];
                const findChildrenRecursive = (parentId) => {
                    const children = window.state.items.filter(i => i.parentId === parentId);
                    children.forEach(child => {
                        idsToDelete.push(child.id);
                        if (child.type === 'folder') {
                            findChildrenRecursive(child.id);
                        }
                    });
                };
                
                findChildrenRecursive(id);
                
                window.showModal('Видалення папки', `Видалити папку "${item.title}" та увесь її вміст (${idsToDelete.length - 1} елементів)?`, () => {
                    window.state.items = window.state.items.filter(i => !idsToDelete.includes(i.id));
                    window.saveTestsToStorage();
                    window.renderApp();
                });
            }
        };

        // --- EDITOR ---
        window.editTest = function(id) {
            window.state.activeTestId = id;
            const test = window.findItem(id); 
            window.state.editorDraft = JSON.parse(JSON.stringify(test));
            window.state.view = 'editor';
            window.renderApp();
        };

        // NEW FUNCTION: Confirm Exit
        window.confirmExitEditor = function() {
            window.showModal(
                'Вихід без збереження',
                'Зміни не будуть збережені. Вийти?',
                function() {
                    window.state.view = 'dashboard';
                    window.renderApp();
                }
            );
        };

        window.saveEditorChanges = function() {
            const idx = window.state.items.findIndex(i => i.id === window.state.activeTestId); 
            if (idx !== -1) {
                window.state.items[idx] = window.state.editorDraft;
            }
            window.saveTestsToStorage(); 
            window.state.view = 'dashboard';
            window.renderApp();
        };

        window.addBlock = function(type) {
	    const blocks = window.state.editorDraft.blocks;
            
            // ПЕРЕВІРКА ЛІМІТУ (50 завдань на одній сторінці)
            if (type !== 'instruction' && type !== 'pageBreak') {
                // 1. Знаходимо початок поточної сторінки (індекс останнього pageBreak)
                let lastBreakIndex = -1;
                for (let i = blocks.length - 1; i >= 0; i--) {
                    if (blocks[i].type === 'pageBreak') {
                        lastBreakIndex = i;
                        break;
                    }
                }
                
                // 2. Рахуємо кількість номерних завдань після останнього розриву
                let tasksOnCurrentPage = 0;
                for (let i = lastBreakIndex + 1; i < blocks.length; i++) {
                    if (blocks[i].number) tasksOnCurrentPage++;
                }

                if (tasksOnCurrentPage >= 50) {
                    alert('Ліміт завдань на одній сторінці вичерпано (50 шт).\nБудь ласка, створіть нову сторінку ("+ Нова сторінка"), щоб додавати далі.');
                    return; // Скасовуємо додавання
                }
            }
            const block = { id: uuid(), type };
            if(type==='instruction') block.text = 'Текст інструкції...';
            if(type==='single') { 
                block.number = window.state.editorDraft.blocks.filter(b => b.number).length + 1;
                block.points = 1; 
                block.question = 'Запитання...'; 
                block.options=[{id:uuid(),text:'Варіант А'}, {id:uuid(),text:'Варіант Б'}]; 
                block.correctId = block.options[0].id;
                block.explanation = '';
                block.hint = '';
            }
            if(type==='multiple') { 
                block.number = window.state.editorDraft.blocks.filter(b => b.number).length + 1;
                block.pointsPerSelection = 1; 
                block.question = 'Запитання...'; 
                block.options=[{id:uuid(),text:'Варіант 1'}, {id:uuid(),text:'Варіант 2'}, {id:uuid(),text:'Варіант 3'}]; 
                block.correctIds = []; 
                block.explanation = '';
                block.hint = '';
            }
            if(type==='short') {
                block.number = window.state.editorDraft.blocks.filter(b => b.number).length + 1;
                block.points = 2; 
                block.question = 'Запитання...'; 
                block.correctAnswer = '0';
                block.explanation = '';
                block.hint = '';
            }
            if(type==='matching') {
                block.number = window.state.editorDraft.blocks.filter(b => b.number).length + 1;
                block.pointsPerPair = 1; 
                block.question = 'Установіть відповідність...'; 
                block.leftLabel = 'Ліва колонка';
                block.rightLabel = 'Права колонка';
                block.leftItems=[{id:uuid(),text:'1'}]; 
                block.rightItems=[{id:uuid(),text:'А'}]; 
                block.correctPairs={};
                block.explanation = '';
                block.hint = '';
            }
            // NEW Dropdown block
            if (type === 'dropdown') {
                block.number = window.state.editorDraft.blocks.filter(b => b.number).length + 1;
                block.pointsPerDropdown = 1;
                block.question = 'Запитання...';
                block.dropdowns = []; // Array of dropdown objects
                block.explanation = '';
                block.hint = '';
            }
	    if (type === 'structured') {
                block.number = window.state.editorDraft.blocks.filter(b => b.number).length + 1;
                block.question = 'Умова завдання...';
                // Створюємо одразу 2 підпитання за замовчуванням
                block.items = [
                    { id: uuid(), text: 'Питання 1', correctAnswer: '0', points: 1 },
                    { id: uuid(), text: 'Питання 2', correctAnswer: '0', points: 1 }
                ];
                block.explanation = '';
                block.hint = '';
            }
            if (type === 'pageBreak') {
                // Розрив сторінки не має номера і контенту, це просто маркер
            }
            window.state.editorDraft.blocks.push(block);
            window.renderApp();
        };

        window.duplicateBlock = function(index) {
            const original = window.state.editorDraft.blocks[index];
            const clone = JSON.parse(JSON.stringify(original));
            clone.id = uuid(); // New block ID

            // Generate new IDs for inner elements to avoid conflicts
            if (clone.type === 'single') {
                const idMap = {};
                clone.options.forEach(o => {
                    const newId = uuid();
                    idMap[o.id] = newId;
                    o.id = newId;
                });
                if (clone.correctId) clone.correctId = idMap[clone.correctId];
            } else if (clone.type === 'multiple') {
                const idMap = {};
                clone.options.forEach(o => {
                    const newId = uuid();
                    idMap[o.id] = newId;
                    o.id = newId;
                });
                if (clone.correctIds) {
                    clone.correctIds = clone.correctIds.map(oldId => idMap[oldId]).filter(id => id);
                }
            } else if (clone.type === 'matching') {
                const leftMap = {};
                clone.leftItems.forEach(i => {
                    const newId = uuid();
                    leftMap[i.id] = newId;
                    i.id = newId;
                });
                const rightMap = {};
                clone.rightItems.forEach(i => {
                    const newId = uuid();
                    rightMap[i.id] = newId;
                    i.id = newId;
                });
                
                const newPairs = {};
                for (const [leftId, rightId] of Object.entries(clone.correctPairs)) {
                    if (leftMap[leftId] && rightMap[rightId]) {
                        newPairs[leftMap[leftId]] = rightMap[rightId];
                    }
                }
                clone.correctPairs = newPairs;
            } else if (clone.type === 'dropdown') {
                if (clone.dropdowns) {
                    clone.dropdowns.forEach(dd => {
                        const oldId = dd.id;
                        const newId = uuid();
                        dd.id = newId;
                        
                        // Update options IDs inside dropdown
                        const optMap = {};
                        dd.options.forEach(o => {
                            const newOptId = uuid();
                            optMap[o.id] = newOptId;
                            o.id = newOptId;
                        });
                        if (dd.correctId) dd.correctId = optMap[dd.correctId];

                        // Update placeholder in Question Text
                        // We need a robust replace because simple string replace might be dangerous if IDs are simple
                        // But UUIDs are safe.
                        const regex = new RegExp(`data-id="${oldId}"`, 'g');
                        clone.question = clone.question.replace(regex, `data-id="${newId}"`);
                    });
                }
            }

            // Insert after original
            window.state.editorDraft.blocks.splice(index + 1, 0, clone);
            window.renderApp();
        };

        window.updateBlock = function(idx, field, val) {
            window.state.editorDraft.blocks[idx][field] = val;
            
            // ЖИВЕ ОНОВЛЕННЯ БІЧНОЇ ПАНЕЛІ
            if (field === 'number') {
                const sidebarEl = document.getElementById(`sidebar-blk-${idx}`);
                if (sidebarEl) sidebarEl.innerText = val;
            }
        };
        
        window.addOption = function(blockIdx) {
            const newOpt = { id: uuid(), text: 'Новий варіант' };
            window.state.editorDraft.blocks[blockIdx].options.push(newOpt);
            window.renderApp();
        };

	// Функції для структурованого завдання
        window.addStructuredItem = function(blockIdx) {
            const newItem = { id: uuid(), text: 'Нове питання', correctAnswer: '0', points: 1 };
            window.state.editorDraft.blocks[blockIdx].items.push(newItem);
            window.renderApp();
        };

        window.removeStructuredItem = function(blockIdx, itemIdx) {
            if (window.state.editorDraft.blocks[blockIdx].items.length <= 1) return alert("Має бути хоча б одне питання");
            window.state.editorDraft.blocks[blockIdx].items.splice(itemIdx, 1);
            window.renderApp();
        };

        window.updateStructuredItem = function(blockIdx, itemIdx, field, val) {
            window.state.editorDraft.blocks[blockIdx].items[itemIdx][field] = val;
        };

        window.removeOption = function(blockIdx, optIdx) {
            window.state.editorDraft.blocks[blockIdx].options.splice(optIdx, 1);
            const block = window.state.editorDraft.blocks[blockIdx];
            if (block.type === 'multiple' && block.correctIds) {
                const optId = block.options[optIdx]?.id; 
                if (optId) {
                    block.correctIds = block.correctIds.filter(id => id !== optId);
                }
            }
            window.renderApp();
        };

        window.updateOption = function(blockIdx, optIdx, val) {
            window.state.editorDraft.blocks[blockIdx].options[optIdx].text = val;
        };

        window.setCorrectOption = function(blockIdx, optId) {
            window.state.editorDraft.blocks[blockIdx].correctId = optId;
        };

        window.toggleCorrectOption = function(blockIdx, optId) {
            const block = window.state.editorDraft.blocks[blockIdx];
            if (!block.correctIds) block.correctIds = [];
            
            const index = block.correctIds.indexOf(optId);
            if (index > -1) {
                block.correctIds.splice(index, 1); 
            } else {
                block.correctIds.push(optId); 
            }
        };

        window.addMatchingItem = function(blockIdx, side) {
            const newItem = { id: uuid(), text: 'Новий елемент' };
            if (side === 'left') {
                window.state.editorDraft.blocks[blockIdx].leftItems.push(newItem);
            } else {
                window.state.editorDraft.blocks[blockIdx].rightItems.push(newItem);
            }
            window.renderApp();
        };

        window.removeMatchingItem = function(blockIdx, side, itemIdx) {
            if (side === 'left') {
                const removedId = window.state.editorDraft.blocks[blockIdx].leftItems[itemIdx].id;
                window.state.editorDraft.blocks[blockIdx].leftItems.splice(itemIdx, 1);
                delete window.state.editorDraft.blocks[blockIdx].correctPairs[removedId];
            } else {
                const removedId = window.state.editorDraft.blocks[blockIdx].rightItems[itemIdx].id;
                window.state.editorDraft.blocks[blockIdx].rightItems.splice(itemIdx, 1);
                const pairs = window.state.editorDraft.blocks[blockIdx].correctPairs;
                for (let leftId in pairs) {
                    if (pairs[leftId] === removedId) delete pairs[leftId];
                }
            }
            window.renderApp();
        };

        window.updateMatchingItem = function(blockIdx, side, itemIdx, val) {
            if (side === 'left') {
                window.state.editorDraft.blocks[blockIdx].leftItems[itemIdx].text = val;
            } else {
                window.state.editorDraft.blocks[blockIdx].rightItems[itemIdx].text = val;
            }
            window.renderApp();
        };

        window.updateMatchingPair = function(blockIdx, leftId, rightId) {
            if (rightId === "") {
                delete window.state.editorDraft.blocks[blockIdx].correctPairs[leftId];
            } else {
                window.state.editorDraft.blocks[blockIdx].correctPairs[leftId] = rightId;
            }
        };

        // --- Dropdown Block Helpers ---
        window.insertDropdownPlaceholder = function(blockIdx) {
            const block = window.state.editorDraft.blocks[blockIdx];
            const dropdownId = uuid();
            const dropdownName = `Список ${block.dropdowns.length + 1}`;
            
            // Add new dropdown data structure
            block.dropdowns.push({
                id: dropdownId,
                name: dropdownName,
                options: [{id: uuid(), text: 'Варіант 1'}],
                correctId: ''
            });

            // Insert HTML placeholder
            const html = `&nbsp;<span class="dropdown-marker" contenteditable="false" data-id="${dropdownId}">[${dropdownName}]</span>&nbsp;`;
            
            // Find the correct editor and insert
            // We need to be careful about focus. If user clicked button, focus might be lost.
            // We assume global `activeEditorElement` is set from last click or we append to end.
            
            if (window.activeEditorElement) {
                // Restore selection if possible or just append
                // Ideally, user clicked inside the editor before clicking the button.
                const sel = window.getSelection();
                sel.removeAllRanges();
                if(window.savedRange) sel.addRange(window.savedRange);
                document.execCommand('insertHTML', false, html);
            } else {
                // Append to end if no focus
                // This is a fallback and might not work perfectly with `contenteditable` div directly
                // But we can try updating the block.question text directly
                block.question += html;
            }
            window.renderApp();
        };

        window.addDropdownOption = function(blockIdx, ddIdx) {
            window.state.editorDraft.blocks[blockIdx].dropdowns[ddIdx].options.push({ id: uuid(), text: 'Новий варіант' });
            window.renderApp();
        };

        window.removeDropdownOption = function(blockIdx, ddIdx, optIdx) {
            window.state.editorDraft.blocks[blockIdx].dropdowns[ddIdx].options.splice(optIdx, 1);
            window.renderApp();
        };

        window.updateDropdownOption = function(blockIdx, ddIdx, optIdx, val) {
            window.state.editorDraft.blocks[blockIdx].dropdowns[ddIdx].options[optIdx].text = val;
        };

        window.setCorrectDropdownOption = function(blockIdx, ddIdx, val) {
            window.state.editorDraft.blocks[blockIdx].dropdowns[ddIdx].correctId = val;
        };

        // REFACTORED REMOVE DROPDOWN
        window.removeDropdown = function(blockIdx, ddIdx) {
            // Use custom modal instead of confirm()
            window.showModal("Видалення списку", "Видалити цей список? (Маркер у тексті залишиться, його треба видалити вручну)", () => {
                window.state.editorDraft.blocks[blockIdx].dropdowns.splice(ddIdx, 1);
                window.renderApp();
            });
        };


        window.moveBlock = function(index, direction) {
            const blocks = window.state.editorDraft.blocks;
            if (direction === 'up' && index > 0) {
                [blocks[index], blocks[index - 1]] = [blocks[index - 1], blocks[index]];
            } else if (direction === 'down' && index < blocks.length - 1) {
                [blocks[index], blocks[index + 1]] = [blocks[index + 1], blocks[index]];
            }
            window.renderApp();
        };

	// Функція для примусового збереження виділення перед кліком на колір
        window.saveSelectionManual = function() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                window.savedRange = sel.getRangeAt(0);
            }
        };

        // --- RICH TEXT EDITOR HELPERS ---
        window.formatExec = function(cmd, val = null) {
            // 1. Відновлюємо виділення перед виконанням
            if (window.savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(window.savedRange);
            }

            // 2. Якщо активний елемент загубився, шукаємо його через виділення
            if (!window.activeEditorElement && window.savedRange) {
                let node = window.savedRange.commonAncestorContainer;
                window.activeEditorElement = node.nodeType === 1 ? node.closest('.rich-content') : node.parentElement.closest('.rich-content');
            }

            // 3. Зберігаємо історію
            window.saveHistory();

            // 4. Виконуємо команду
            document.execCommand(cmd, false, val);

            // 5. Повертаємо фокус у редактор
            if (window.activeEditorElement) {
                window.activeEditorElement.focus();
                // Оновлюємо збережений діапазон
                const sel = window.getSelection();
                if (sel.rangeCount > 0) window.savedRange = sel.getRangeAt(0);
            }
        };

        // REWRITTEN LINK FUNCTION
window.insertLink = function() {
            // 1. Спочатку відновлюємо виділення зі "сховку" (savedRange)
            if (window.savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(window.savedRange);
            }

            // 2. Перевіряємо, чи текст дійсно виділений
            const selection = window.getSelection();
            if (selection.toString().length === 0) {
                // Якщо все одно нічого не виділено - намагаємось знайти активний редактор і попередити
                if (window.activeEditorElement) window.activeEditorElement.focus();
                return alert("Будь ласка, спочатку виділіть текст для посилання!");
            }

            // 3. Зберігаємо історію для Ctrl+Z ПЕРЕД змінами
            window.saveHistory();

            // 4. Запитуємо посилання
            const url = prompt("Введіть URL посилання:", "https://");
            
            if (url) {
                document.execCommand("createLink", false, url);
                
                // Оновлюємо стилі, щоб прибрати підкреслення за замовчуванням (якщо ви це налаштували)
                const anchorNode = selection.anchorNode.parentElement;
                if(anchorNode && anchorNode.tagName === 'A') {
                    anchorNode.style.textDecoration = "none";
                }
            }
        };

        window.setFontSize = function(size) {
            if (!size) return;
            window.saveHistory(); // Save state for Undo
            
            if (window.savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(window.savedRange);
            }

            if (window.activeEditorElement) {
                // ... logic same as before ...
                const sel = window.getSelection();
                if (!sel.rangeCount) return;

                const span = document.createElement("span");
                span.style.fontSize = size + "pt";
                
                if (!sel.isCollapsed) {
                    const range = sel.getRangeAt(0);
                    const content = range.extractContents();
                    span.appendChild(content);
                    range.insertNode(span);
                    
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    sel.removeAllRanges();
                    sel.addRange(newRange);
                    window.savedRange = newRange; 
                }
                window.activeEditorElement.focus();
            }
        };
        
        // NEW: Format Columns
window.formatColumns = function(cols) {
            // 1. Відновлюємо виділення
            const sel = window.getSelection();
            if (sel.rangeCount === 0 && window.savedRange) {
                sel.removeAllRanges();
                sel.addRange(window.savedRange);
            }

            // 2. Визначаємо редактор
            if (sel.rangeCount > 0) {
                let node = sel.getRangeAt(0).commonAncestorContainer;
                let foundEditor = node.nodeType === 1 ? node.closest('.rich-content') : node.parentElement.closest('.rich-content');
                if (foundEditor) window.activeEditorElement = foundEditor;
            }

            if (!window.activeEditorElement) return alert("Поставте курсор у текст!");

            window.saveHistory(); 

            // 3. ПЕРЕВІРКА: Чи ми вже всередині колонок?
            let existingColumnBlock = null;
            let currentNode = sel.anchorNode;
            
            // Піднімаємось вгору по дереву елементів, поки не знайдемо блок колонок або не вийдемо з редактора
            while (currentNode && currentNode !== window.activeEditorElement) {
                if (currentNode.nodeType === 1 && (currentNode.style.columnCount || currentNode.style.webkitColumnCount)) {
                    existingColumnBlock = currentNode;
                    break;
                }
                currentNode = currentNode.parentNode;
            }

            // А) Якщо ми вже в колонках:
            if (existingColumnBlock) {
                if (cols === 1) {
                    // Скасувати колонки (прибрати стилі)
                    existingColumnBlock.style.columnCount = '';
                    existingColumnBlock.style.columnGap = '';
                    existingColumnBlock.style.width = '';
                    existingColumnBlock.style.textAlign = '';
                    // Опціонально: перетворити div назад на p, але скидання стилів безпечніше
                } else {
                    // Змінити кількість (наприклад, з 2 на 3)
                    existingColumnBlock.style.columnCount = cols;
                }
                return; // Виходимо, нові блоки не створюємо
            }

            // Б) Якщо колонок немає, а ми просимо 1 колонку - нічого не робити
            if (cols === 1) return;

            // В) Створюємо нові колонки (якщо їх не було)
            if (sel.rangeCount > 0 && !sel.isCollapsed) {
                const range = sel.getRangeAt(0);
                const content = range.extractContents();
                
                const div = document.createElement('div');
                div.style.columnCount = cols;
                div.style.columnGap = '2rem';
                div.style.width = '100%';
                div.style.textAlign = 'justify';
                div.style.marginBottom = '1em';
                
                div.appendChild(content);
                range.insertNode(div);
                
                const p = document.createElement('p');
                p.innerHTML = '<br>';
                range.collapse(false);
                range.insertNode(p);
            } else {
                alert("Виділіть текст, який треба розділити на колонки.");
            }
        };

        window.savedRange = null;
        window.activeEditorElement = null;

        // Track focus for Dropdown insertion
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const node = sel.getRangeAt(0).commonAncestorContainer;
                const editor = node.closest ? node.closest('.rich-content') : (node.parentNode ? node.parentNode.closest('.rich-content') : null);
                if (editor) {
                    window.activeEditorElement = editor;
                    window.savedRange = sel.getRangeAt(0);
                }
            }
        });

        window.insertLatex = function() {
            window.saveHistory(); // Save state for Undo
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const text = selection.toString();
                if (text) {
                    const latexCode = text;
                    const html = `<span class="math-node" contenteditable="false" data-latex="${latexCode}">\\(${latexCode}\\)</span>&nbsp;`;
                    document.execCommand('insertHTML', false, html);
                    if(window.MathJax) window.MathJax.typesetPromise();
                } else {
                    window.savedRange = selection.getRangeAt(0);
                    let node = window.savedRange.commonAncestorContainer;
                    while(node && !node.classList?.contains('rich-content')) {
                        node = node.parentNode;
                    }
                    window.activeEditorElement = node;
                    
                    document.getElementById('latex-input-area').value = '';
                    document.getElementById('latex-modal').style.display = 'flex';
                    setTimeout(() => document.getElementById('latex-input-area').focus(), 100);
                }
            } else {
                alert("Спочатку поставте курсор у текстове поле!");
            }
        };

        document.addEventListener('dblclick', function(e) {
            // ЗАХИСТ 1: Не дозволяти редагування у режимі проходження тесту
            if (window.state.view === 'runner') return;

            // ЗАХИСТ 2: Не дозволяти редагування у розділі "Банк завдань"
            if (window.state.currentSection === 'bank') return;

            // ЗАХИСТ 3: Не дозволяти редагування у модальних вікнах (статистика, імпорт, експорт)
            // Шукаємо найближчий modal-content
            if (e.target.closest('.modal-content')) return;

            const mathNode = e.target.closest('.math-node');
            const editor = e.target.closest('.rich-content');

            if (mathNode && editor) {
                const latex = mathNode.getAttribute('data-latex');
                if (latex) {
                    document.getElementById('latex-input-area').value = latex;
                    document.getElementById('latex-modal').style.display = 'flex';
                    window.editingMathNode = mathNode;
                }
            } 
        });

        setTimeout(() => {
            try {
                document.getElementById('latex-btn-insert').addEventListener('click', () => {
                    window.saveHistory(); // Save state for Undo inside modal action
                    const val = document.getElementById('latex-input-area').value;
                    
                    if (window.editingMathNode) {
                        if (val) {
                            window.editingMathNode.setAttribute('data-latex', val);
                            window.editingMathNode.innerHTML = `\\(${val}\\)`;
                            if(window.MathJax) window.MathJax.typesetPromise([window.editingMathNode]);
                            
                            const editor = window.editingMathNode.closest('.rich-content');
                            if(editor) {
                                editor.dispatchEvent(new Event('blur')); 
                            }
                        } else {
                            window.editingMathNode.remove();
                        }
                        window.editingMathNode = null;
                    } else if (val && window.savedRange) {
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(window.savedRange);
                        
                        const html = `<span class="math-node" contenteditable="false" data-latex="${val}">\\(${val}\\)</span>&nbsp;`;
                        document.execCommand('insertHTML', false, html);
                        
                        if(window.MathJax) window.MathJax.typesetPromise();
                    }
                    
                    document.getElementById('latex-modal').style.display = 'none';
                });

                document.getElementById('table-btn-insert').addEventListener('click', () => {
                    window.saveHistory(); // Save state for Undo inside modal action
                    const rows = parseInt(document.getElementById('table-rows').value) || 3;
                    const cols = parseInt(document.getElementById('table-cols').value) || 3;
                    const borderColor = document.getElementById('table-border-color').value || '#000000';
                    const bgColor = document.getElementById('table-bg-color').value || '#FFFFFF';
                    const width = document.getElementById('table-width').value;
                    const widthUnit = document.getElementById('table-width-unit').value;
                    const height = document.getElementById('table-height').value;
                    const heightUnit = document.getElementById('table-height-unit').value;
                    
                    // NEW Alignment Inputs
                    const textAlign = document.getElementById('table-text-align').value;
                    const verticalAlign = document.getElementById('table-vertical-align').value;

                    const tableWidth = width ? `${width}${widthUnit}` : '100%';
                    const tableHeight = height ? `${height}${heightUnit}` : 'auto';
                    const tableStyle = `border-collapse: collapse; border: 1px solid ${borderColor}; resize: both; overflow: auto; width: ${tableWidth}; height: ${tableHeight};`;
                    const cellStyle = `border: 1px solid ${borderColor}; background-color: ${bgColor}; padding: 8px; text-align: ${textAlign}; vertical-align: ${verticalAlign};`;

                    if (window.editingTableElement) {
                        // --- EDIT EXISTING TABLE ---
                        const table = window.editingTableElement;
                        table.style.cssText = tableStyle;
                        
                        // Apply cell styles
                        table.querySelectorAll('td, th').forEach(cell => {
                            cell.style.borderColor = borderColor;
                            cell.style.backgroundColor = bgColor;
                            cell.style.padding = '8px';
                            cell.style.borderWidth = '1px';
                            cell.style.borderStyle = 'solid';
                            cell.style.textAlign = textAlign;
                            cell.style.verticalAlign = verticalAlign;
                        });

                        // Adjust rows
                        const currentRows = table.rows.length;
                        const currentCols = table.rows[0] ? table.rows[0].cells.length : 0;

                        if (rows > currentRows) { // Add rows
                            for (let r = currentRows; r < rows; r++) {
                                const newRow = table.insertRow(-1);
                                for (let c = 0; c < currentCols; c++) {
                                    const newCell = newRow.insertCell(-1);
                                    newCell.innerHTML = '<p>&nbsp;</p>';
                                    newCell.style.cssText = cellStyle;
                                }
                            }
                        } else if (rows < currentRows) { // Delete rows
                            for (let r = currentRows - 1; r >= rows; r--) {
                                table.deleteRow(r);
                            }
                        }

                        // Adjust columns
                        const newCurrentCols = table.rows[0] ? table.rows[0].cells.length : 0;
                        if (cols > newCurrentCols) { // Add cols
                            for (let r = 0; r < table.rows.length; r++) {
                                for (let c = newCurrentCols; c < cols; c++) {
                                    const newCell = table.rows[r].insertCell(-1);
                                    newCell.innerHTML = '<p>&nbsp;</p>';
                                    newCell.style.cssText = cellStyle;
                                }
                            }
                        } else if (cols < newCurrentCols) { // Delete cols
                            for (let r = 0; r < table.rows.length; r++) {
                                for (let c = newCurrentCols - 1; c >= cols; c--) {
                                    table.rows[r].deleteCell(c);
                                }
                            }
                        }

                    } else {
                        // --- CREATE NEW TABLE ---
                        let tableHTML = `<table style="${tableStyle}"><tbody>`;
                        for (let r = 0; r < rows; r++) {
                            tableHTML += '<tr>';
                            for (let c = 0; c < cols; c++) {
                                tableHTML += `<td style="${cellStyle}"><p>&nbsp;</p></td>`;
                            }
                            tableHTML += '</tr>';
                        }
                        tableHTML += '</tbody></table><p>&nbsp;</p>'; 

                        if (window.activeEditorElement) {
                            window.activeEditorElement.focus();
                        }
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        
                        if (window.savedRange) {
                            sel.addRange(window.savedRange);
                        }
                        
                        document.execCommand('insertHTML', false, tableHTML);
                    }
                    
                    document.getElementById('table-modal').style.display = 'none';
                    window.editingTableElement = null;
                });
            } catch (e) {
                console.error("Error setting up modal listeners:", e);
            }
        }, 0); 

        window.getRichEditorHtml = function(content, onBlurCode) {
            const uniqueId = uuid(); 
            return `
            <div class="rich-editor-container">
                <div class="rich-toolbar">
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('justifyLeft')" title="За лівим краєм">${ICONS.left}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('justifyCenter')" title="По центру">${ICONS.center}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('justifyRight')" title="За правим краєм">${ICONS.right}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('justifyFull')" title="По ширині">${ICONS.justify}</button>
                    
                    <div class="rich-separator"></div>
                    <button type="button" class="rich-btn font-bold" onmousedown="event.preventDefault(); window.formatColumns(1)" title="1 колонка (скасувати поділ)">1</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatColumns(2)" title="2 колонки">${ICONS.col2}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatColumns(3)" title="3 колонки">${ICONS.col3}</button>
                    
                    <div class="rich-separator"></div>
                    
                    <select class="rich-select" onmousedown="window.saveSelectionManual()" onchange="window.setFontSize(this.value);" title="Розмір шрифту">
                        <option value="">Розмір</option>
                        <option value="8">8 pt</option>
                        <option value="10">10 pt</option>
                        <option value="12">12 pt</option>
                        <option value="14">14 pt</option>
                        <option value="18">18 pt</option>
                        <option value="24">24 pt</option>
                        <option value="36">36 pt</option>
                    </select>

                    <div class="rich-separator"></div>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('bold')" title="Жирний">${ICONS.bold}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('italic')" title="Курсив">${ICONS.italic}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('underline')" title="Підкреслений">${ICONS.underline}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('strikeThrough')" title="Перекреслений">${ICONS.strike}</button>
                    
                    <div class="rich-separator"></div>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault()" onclick="window.insertLink()" title="Вставити посилання">${ICONS.link}</button>
                    
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('insertUnorderedList')" title="Маркерований список">${ICONS.ul}</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.formatExec('insertOrderedList')" title="Нумерований список">${ICONS.ol}</button>
                    
                    <div class="rich-separator"></div>
                    <button type="button" class="rich-btn font-bold text-lg text-blue-600 hover:bg-blue-50" onmousedown="event.preventDefault(); window.insertLatex()" title="Вставити LaTeX формулу">Σ</button>
                    <button type="button" class="rich-btn text-blue-600 hover:bg-blue-50" onclick="window.insertImage(event)" title="Вставити зображення">${ICONS.image}</button>
                    <button type="button" class="rich-btn text-blue-600 hover:bg-blue-50" onmousedown="event.preventDefault(); window.showTableModal()" title="Вставити таблицю">${ICONS.table}</button>
                
                    <div class="rich-separator"></div>
                    
                    <label for="fore-color-picker-${uniqueId}" class="rich-btn color-picker-label" title="Колір тексту" onmousedown="window.saveSelectionManual()">
                        <span style="border-bottom: 3px solid #000;">A</span>
                        <input type="color" id="fore-color-picker-${uniqueId}" onchange="window.formatExec('foreColor', this.value)">
                    </label>
                    <label for="back-color-picker-${uniqueId}" class="rich-btn color-picker-label" title="Колір фону" style="background-color: #fef08a; border: 1px solid #eab308; color: #a16207;" onmousedown="window.saveSelectionManual()">
                        A
                        <input type="color" id="back-color-picker-${uniqueId}" onchange="window.formatExec('hiliteColor', this.value)">
                    </label>

                    <div class="rich-separator"></div>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.tableManage('addRowBelow')" title="Додати рядок знизу">R+</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.tableManage('deleteRow')" title="Видалити рядок">R-</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.tableManage('addColRight')" title="Додати стовпець справа">C+</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.tableManage('deleteCol')" title="Видалити стовпець">C-</button>
                    <button type="button" class="rich-btn" onmousedown="event.preventDefault(); window.tableManage('showProperties')" title="Властивості таблиці">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px; height:18px;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                </div>
                <div class="rich-content" contenteditable="true" 
                     onblur="${onBlurCode}">${content}</div>
            </div>`;
        };

        window.showTableModal = function() {
            // MODIFIED: Robust active editor detection
            if (!window.activeEditorElement && window.savedRange) {
                 const node = window.savedRange.commonAncestorContainer;
                 window.activeEditorElement = node.closest ? node.closest('.rich-content') : (node.parentNode ? node.parentNode.closest('.rich-content') : null);
            }

            // Fallback for creating new table - focus active editor
            if (window.activeEditorElement) {
                window.activeEditorElement.focus();
            }

            const selection = window.getSelection();
            
            // Restore selection if lost
            if (selection.rangeCount === 0 && window.savedRange) {
                selection.removeAllRanges();
                selection.addRange(window.savedRange);
            }

            if (selection.rangeCount > 0) {
                window.savedRange = selection.getRangeAt(0);
                let node = window.savedRange.commonAncestorContainer;
                window.activeEditorElement = node.closest ? node.closest('.rich-content') : (node.parentNode ? node.parentNode.closest('.rich-content') : null);
                
                if (!window.activeEditorElement) {
                     alert("Спочатку поставте курсор у текстове поле!");
                     return;
                }
                
                // --- NEW: Reset for CREATE mode ---
                window.editingTableElement = null;
                document.getElementById('table-modal-title').innerText = "Вставити таблицю";
                document.getElementById('table-btn-insert').innerText = "Вставити";
                document.getElementById('table-rows').value = 3;
                document.getElementById('table-cols').value = 3;
                document.getElementById('table-border-color').value = "#000000";
                document.getElementById('table-bg-color').value = "#FFFFFF";
                document.getElementById('table-width').value = "100";
                document.getElementById('table-width-unit').value = "%";
                document.getElementById('table-height').value = "";
                document.getElementById('table-height-unit').value = "";
                // Reset Alignment
                document.getElementById('table-text-align').value = 'left';
                document.getElementById('table-vertical-align').value = 'top';
                // --- End Reset ---

                document.getElementById('table-modal').style.display = 'flex';
            } else {
                 alert("Спочатку поставте курсор у текстове поле!");
            }
        };

        // --- NEW TABLE MANAGE FUNCTIONS ---
        window.getActiveCellElements = function() {
            // MODIFIED: More robust way to find active cell
            let range = window.savedRange;
            if (!range) {
                const sel = window.getSelection();
                if (sel.rangeCount > 0) range = sel.getRangeAt(0);
            }
            if (!range) return null;

            let node = range.commonAncestorContainer;
            const cell = node.closest ? node.closest('td, th') : (node.parentNode ? node.parentNode.closest('td, th') : null);
            
            if (!cell) {
                 // Try looking inside the active editor if we missed the specific cell via range
                 if (window.activeEditorElement) {
                     // Check if selection is inside a table within active editor
                     const sel = window.getSelection();
                     if (sel.anchorNode) {
                         const cellCheck = sel.anchorNode.parentNode.closest('td, th');
                         if (cellCheck) return { cell: cellCheck, row: cellCheck.parentNode, table: cellCheck.closest('table') };
                     }
                 }
                 alert("Будь ласка, поставте курсор всередину таблиці.");
                 return null;
            }
            const row = cell.parentNode;
            const table = row.closest('table');
            return { cell, row, table };
        }

        window.tableManage = function(action) {
            window.saveHistory(); // Save state for Undo
            const elements = window.getActiveCellElements();
            if (!elements) return;
            
            const { cell, row, table } = elements;
            const rowIndex = row.rowIndex;
            const cellIndex = cell.cellIndex;
            const tableBody = table.querySelector('tbody') || table;

            try {
                if (action === 'addRowBelow') {
                    const newRow = tableBody.insertRow(rowIndex + 1);
                    for (let i = 0; i < row.cells.length; i++) {
                        const newCell = newRow.insertCell(i);
                        newCell.innerHTML = '<p>&nbsp;</p>';
                        // copy style from cell in the same column, from the current row
                        const styleSource = row.cells[i] || cell;
                        newCell.style.cssText = styleSource.style.cssText; 
                    }
                } 
                else if (action === 'deleteRow') {
                    if (table.rows.length > 1) {
                        tableBody.deleteRow(rowIndex);
                    } else {
                        alert("Не можна видалити останній рядок.");
                    }
                }
                else if (action === 'addColRight') {
                    for (let i = 0; i < table.rows.length; i++) {
                        const newCell = table.rows[i].insertCell(cellIndex + 1);
                        newCell.innerHTML = '<p>&nbsp;</p>';
                        newCell.style.cssText = cell.style.cssText; // copy style
                    }
                }
                else if (action === 'deleteCol') {
                    if (row.cells.length > 1) {
                        for (let i = 0; i < table.rows.length; i++) {
                            if(table.rows[i].cells[cellIndex]) {
                                table.rows[i].deleteCell(cellIndex);
                            }
                        }
                    } else {
                        alert("Не можна видалити останній стовпець.");
                    }
                }
                else if (action === 'showProperties') {
                    window.editingTableElement = table;
                    document.getElementById('table-modal-title').innerText = "Властивості таблиці";
                    document.getElementById('table-btn-insert').innerText = "Застосувати";

                    // Populate modal
                    document.getElementById('table-rows').value = table.rows.length;
                    document.getElementById('table-cols').value = table.rows[0] ? table.rows[0].cells.length : 0;
                    
                    // Try to get colors and ALIGNMENT (from first cell as example)
                    const firstCell = table.querySelector('td, th');
                    if (firstCell) {
                        document.getElementById('table-border-color').value = rgbToHex(firstCell.style.borderColor || table.style.borderColor || '#000000');
                        document.getElementById('table-bg-color').value = rgbToHex(firstCell.style.backgroundColor || '#FFFFFF');
                        document.getElementById('table-text-align').value = firstCell.style.textAlign || 'left';
                        document.getElementById('table-vertical-align').value = firstCell.style.verticalAlign || 'top';
                    }
                    
                    // Get width/height
                    const widthMatch = table.style.width.match(/([\d.]+)(%|px|cm)?/);
                    if (widthMatch) {
                        document.getElementById('table-width').value = widthMatch[1];
                        document.getElementById('table-width-unit').value = widthMatch[2] || 'px';
                    } else {
                        document.getElementById('table-width').value = '';
                        document.getElementById('table-width-unit').value = '%';
                    }
                    
                    const heightMatch = table.style.height.match(/([\d.]+)(%|px|cm)?/);
                    if (heightMatch) {
                        document.getElementById('table-height').value = heightMatch[1];
                        document.getElementById('table-height-unit').value = heightMatch[2] || 'px';
                    } else {
                        document.getElementById('table-height').value = '';
                        document.getElementById('table-height-unit').value = '';
                    }

                    document.getElementById('table-modal').style.display = 'flex';
                }
            } catch (e) {
                console.error("Table manage error:", e);
                alert("Помилка при редагуванні таблиці.");
            }
        }

        window.rgbToHex = function(rgb) {
            if (!rgb) return '#000000';
            if (rgb.startsWith('#')) return rgb;
            let match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#000000'; // default
            function hex(x) {
                return ("0" + parseInt(x).toString(16)).slice(-2);
            }
            return "#" + hex(match[1]) + hex(match[2]) + hex(match[3]);
        }
        // --- END NEW TABLE MANAGE ---

        window.insertImage = function(event) {
            window.saveHistory(); // Save state for Undo
            event.preventDefault(); 
            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                 if (!window.activeEditorElement) {
                    alert("Спочатку поставте курсор у текстове поле!");
                    return;
                 }
                 window.activeEditorElement.focus();
                 window.savedRange = window.getSelection().getRangeAt(0);

            } else {
                window.savedRange = selection.getRangeAt(0);
                let node = window.savedRange.commonAncestorContainer;
                window.activeEditorElement = node.closest ? node.closest('.rich-content') : (node.parentNode ? node.parentNode.closest('.rich-content') : null);
            }


            if (!window.activeEditorElement) {
                alert("Не вдалося знайти активний редактор. Спробуйте клікнути в поле ще раз.");
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = () => {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Src = e.target.result;
                    
                    const html = `
                    <div style="resize: both; overflow: auto; border: 1px dashed #ccc; display: inline-block; max-width: 100%; width: 300px;" contenteditable="false">
                        <img src="${base64Src}" style="max-width: 100%; width: 100%; display: block;" alt="Завантажене зображення" contenteditable="false">
                    </div>&nbsp;`;

                    if (window.activeEditorElement) {
                        window.activeEditorElement.focus();
                    }
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    
                    if (window.savedRange) {
                        sel.addRange(window.savedRange);
                    }
                    
                    document.execCommand('insertHTML', false, html);
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        };

        window.handlePaste = function(e) {
            const editor = e.target.closest('.rich-content');
            if (!editor) return; 

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            if (!items) return;

            let foundImage = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    if (!blob) continue;

                    e.preventDefault();
                    foundImage = true;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64Src = event.target.result;
                        const html = `
                        <div style="resize: both; overflow: auto; border: 1px dashed #ccc; display: inline-block; max-width: 100%; width: 300px;" contenteditable="false">
                            <img src="${base64Src}" style="max-width: 100%; width: 100%; display: block;" alt="Вставлене зображення" contenteditable="false">
                        </div>&nbsp;`;
                        
                        editor.focus(); 
                        document.execCommand('insertHTML', false, html);
                    };
                    reader.readAsDataURL(blob);
                }
            }
        };


        window.renderEditor = function(container) {
            const test = window.state.editorDraft;
            const isBankMode = test.isBankMode; // Перевіряємо режим
            
            const typeLabels = {
                'instruction': 'Інструкція / Текст',
                'single': 'Тест з одною правильною відповіддю',
                'multiple': 'Тест з кількома правильними відповідями', 
                'matching': 'Встановлення відповідності',
                'short': 'Неструктуроване завдання з короткою відповіддю',
                'dropdown': 'Випадний список',
                'structured': 'Структуроване завдання з короткою відповіддю',
                'pageBreak': '--- РОЗРИВ СТОРІНКИ ---'
            };

            // Рахуємо кількість завдань для сітки (тільки якщо не банк)
            const numberedTasksCount = test.blocks.filter(b => b.number).length;
            const sbConfig = window.getSidebarConfig(numberedTasksCount);

            // Бічна панель (Показуємо ТІЛЬКИ якщо НЕ режим банку)
            const sidebarHtml = !isBankMode ? `
                <div class="w-full lg:w-48 flex-shrink-0 hidden lg:block">
                    <div class="sidebar-panel" style="top: 20px;">
                        <div class="sidebar-title text-sm font-bold mb-2 text-center text-gray-500">Навігація</div>
                        <div class="sidebar-grid" style="grid-template-columns: repeat(${sbConfig.cols}, 1fr);">
                            ${test.blocks.map((b, i) => {
                                if (b.type === 'pageBreak') return `<div style="grid-column: 1 / -1; width: 100%; height: 2px; background-color: #fca5a5; margin: 4px 0;" title="Розрив сторінки"></div>`;
                                let label = b.number || 'i';
                                return `<div id="sidebar-blk-${i}" class="task-square ${b.type==='instruction'?'bg-gray-100':''}" 
                                        style="width: ${sbConfig.size}; height: ${sbConfig.size}; font-size: ${sbConfig.fontSize};"
                                        onclick="document.getElementById('edit-blk-${i}').scrollIntoView({behavior:'smooth', block:'center'})">${label}</div>`;
                            }).join('')}
                        </div>
                        <div class="mt-4 text-center">
                             <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="text-xs text-blue-600 underline">Вгору сторінки</button>
                        </div>
                    </div>
                </div>
            ` : ''; // Пусто для банку

            // Налаштування тесту (Ховаємо в режимі банку, але додаємо опис джерела)
            const settingsHtml = !isBankMode ? `
                <div class="mb-4 border p-4 bg-blue-50">
                    <label class="block text-sm font-bold mb-1">Назва тесту</label>
                    <input class="w-full mb-2 p-2 border" value="${test.title}" onchange="window.state.editorDraft.title=this.value">
                    <label class="block text-sm font-bold mb-1">Опис</label>
                    <input class="w-full p-2 border mb-2" value="${test.description}" placeholder="Опис" onchange="window.state.editorDraft.description=this.value">
                    
                    <label class="block text-sm font-bold mb-1 mt-2">Опис перед тестуванням (вступ)</label>
                    ${window.getRichEditorHtml(test.preTestDescription || '', `window.state.editorDraft.preTestDescription = this.innerHTML`)}

                    <label class="block text-sm font-bold mb-1 mt-2">Текст інформаційної панелі</label>
                    ${window.getRichEditorHtml(test.infoPanelContent || 'Національний мультипредметний тест...', `window.state.editorDraft.infoPanelContent = this.innerHTML`)}

                    <label class="block text-sm font-bold mb-1 mt-2">Посилання на довідкові матеріали</label>
                    <input type="text" class="w-full p-2 border" value="${test.referenceUrl || ''}" placeholder="https://..." onchange="window.state.editorDraft.referenceUrl = this.value">

                    <label class="block text-sm font-bold mb-1 mt-2">Тривалість (хвилин)</label>
                    <div class="text-xs text-gray-500 mb-1">Залиште порожнім або 0, щоб прибрати таймер (без обмежень).</div>
                    <input type="number" class="w-full p-2 border" value="${test.timeLimit > 0 ? test.timeLimit / 60 : ''}" placeholder="Без обмежень" onchange="window.state.editorDraft.timeLimit = this.value ? this.value * 60 : 0">
                </div>
            ` : `
                <div class="mb-4 p-4 bg-red-50 border border-red-100 rounded">
                    <div class="font-bold text-gray-700 mb-2">Налаштування завдання в Банку</div>
                    <label class="block text-sm font-bold mb-1 text-gray-600">Короткий опис / Джерело (напр. "ЗНО 2021, основна сесія"):</label>
                    <input type="text" class="w-full p-2 border rounded" value="${test.bankSource || ''}" placeholder="Введіть рік, сесію або тему..." onchange="window.state.editorDraft.bankSource = this.value">
                </div>
            `;

            // Панель інструментів (Ховаємо, якщо в банку вже є 1 завдання, щоб не додали друге)
            const showToolbar = !isBankMode || test.blocks.length === 0;

            container.innerHTML = `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="flex flex-col lg:flex-row gap-8">
                        
                        <div class="flex-1 bg-white shadow-lg rounded p-6">
                            <div class="flex justify-between mb-4">
                                <button onclick="window.confirmExitEditor()" class="text-gray-500">← Назад</button>
                                ${isBankMode 
                                  ? `<button onclick="window.saveBankTaskChanges()" class="spa-btn bg-[#FF2938] text-white hover:bg-red-700">Зберегти в Банк</button>`
                                  : `<div class="flex gap-2">
                                        <button onclick="window.openBankImportModal()" class="spa-btn bg-purple-100 text-purple-700 border-purple-200">📥 Додати з Банку</button>
                                        <button onclick="window.saveEditorChanges()" class="spa-btn spa-btn-primary">Зберегти тест</button>
                                     </div>`
                                }
                            </div>
                            
                            ${settingsHtml}

                            ${showToolbar ? `
                            <div class="flex gap-2 mb-4 justify-center flex-wrap sticky top-0 bg-white z-10 py-2 border-b">
                                <button onclick="window.addBlock('instruction')" class="spa-btn spa-btn-secondary text-xs">+ ТЕКСТ/ІНСТРУКЦІЯ</button>
                                <button onclick="window.addBlock('single')" class="spa-btn spa-btn-secondary text-xs">+ ТЕСТ З ОДНОЮ ПРАВИЛЬНОЮ ВІДПОВІДДЮ</button>
                                <button onclick="window.addBlock('multiple')" class="spa-btn spa-btn-secondary text-xs">+ ТЕСТ З КІЛЬКОМА ПРАВИЛЬНИМИ ВІДПОВІДЯМИ</button>
                                <button onclick="window.addBlock('matching')" class="spa-btn spa-btn-secondary text-xs">+ ВСТАНОВЛЕННЯ ВІДПОВІДНОСТЕЙ</button>
                                <button onclick="window.addBlock('structured')" class="spa-btn spa-btn-secondary text-xs">+ СТРУКТУРОВАНЕ З КОРОТКОЮ ВІДПОВІДДЮ</button>
                                <button onclick="window.addBlock('short')" class="spa-btn spa-btn-secondary text-xs">+ НЕСТРУКТУРОВАНЕ З КОРОТКОЮ ВІДПОВІДДЮ</button>
                                <button onclick="window.addBlock('dropdown')" class="spa-btn spa-btn-secondary text-xs">+ ВИПАДНИЙ СПИСОК</button>
                                ${!isBankMode ? `<button onclick="window.addBlock('pageBreak')" class="spa-btn bg-red-50 text-red-600 border-red-200 hover:bg-red-100 text-xs font-bold">+ НОВА СТОРІНКА</button>` : ''}
                            </div>` : ''}

                            <div>
                                ${test.blocks.map((b, i) => {
                                    let content = '';
                                    let hintField = `
                                        <div class="mt-2">
                                            <label class="text-xs font-bold text-gray-500">Підказка (видно під час тесту):</label>
                                            ${window.getRichEditorHtml(b.hint || '', `window.updateBlock(${i}, 'hint', this.innerHTML)`)}
                                        </div>`;

                                    if (b.type === 'pageBreak') {
                                        return `
                                        <div id="edit-blk-${i}" class="mb-4 relative">
                                            <div class="absolute top-1/2 -translate-y-1/2 left-0 flex flex-col gap-1 z-10">
                                                <button class="move-btn" onclick="window.moveBlock(${i}, 'up')" ${i === 0 ? 'disabled' : ''}>▲</button>
                                                <button class="move-btn" onclick="window.moveBlock(${i}, 'down')" ${i === test.blocks.length - 1 ? 'disabled' : ''}>▼</button>
                                            </div>
                                            <div class="absolute top-2 right-2 z-10">
                                                <button onclick="window.state.editorDraft.blocks.splice(${i},1); window.renderApp()" class="text-red-500 font-bold bg-white border px-2 rounded">✕</button>
                                            </div>
                                            <div class="page-break-block">--- Розрив сторінки ---</div>
                                        </div>`;
                                    }
                                    
                                    // --- Генерація контенту для блоків (код без змін) ---
                                    if (b.type === 'instruction') {
                                        content = `<label class="text-xs font-bold text-gray-500">Текст інструкції:</label>
                                            ${window.getRichEditorHtml(b.text, `window.updateBlock(${i}, 'text', this.innerHTML)`)}`;
                                    } else if (b.type === 'structured') {
                                        content = `<div class="flex gap-2 mb-2"><div class="w-16"><label class="text-xs font-bold text-gray-500">№</label><input type="number" class="w-full border p-1" value="${b.number}" onchange="window.updateBlock(${i}, 'number', this.value)"></div><div class="flex-1"><label class="text-xs font-bold text-gray-500">Загальна умова завдання:</label>${window.getRichEditorHtml(b.question, `window.updateBlock(${i}, 'question', this.innerHTML)`)}</div></div><div class="bg-purple-50 p-3 border border-purple-100 rounded mt-2"><label class="text-xs font-bold text-gray-500 block mb-2">Підпитання:</label>${b.items.map((item, itemIdx) => `<div class="bg-white p-2 border rounded mb-2 shadow-sm"><div class="flex justify-between items-center mb-2 border-b pb-1"><span class="font-bold text-sm text-purple-600">Питання ${itemIdx + 1}</span><button type="button" onclick="window.removeStructuredItem(${i}, ${itemIdx})" class="text-red-500 text-xs hover:underline">Видалити</button></div><div class="mb-2"><label class="text-xs font-bold text-gray-600">Текст підпитання:</label>${window.getRichEditorHtml(item.text, `window.updateStructuredItem(${i}, ${itemIdx}, 'text', this.innerHTML)`)}</div><div class="flex gap-4"><div class="flex-1"><label class="text-xs text-gray-400">Правильна відповідь:</label><input type="text" class="w-full border p-1 font-bold" value="${item.correctAnswer}" onchange="window.updateStructuredItem(${i}, ${itemIdx}, 'correctAnswer', this.value)"></div><div class="w-24"><label class="text-xs text-gray-400">Бали:</label><input type="number" class="w-full border p-1" value="${item.points}" onchange="window.updateStructuredItem(${i}, ${itemIdx}, 'points', this.value)"></div></div></div>`).join('')}<button onclick="window.addStructuredItem(${i})" class="text-purple-600 text-xs underline font-bold">+ Додати ще підпитання</button></div><div class="mt-2"><label class="text-xs font-bold text-gray-500">Пояснення:</label>${window.getRichEditorHtml(b.explanation || '', `window.updateBlock(${i}, 'explanation', this.innerHTML)`)}</div>${hintField}`;
                                    } else if (b.type === 'single') {
                                        content = `<div class="flex gap-2 mb-2"><div class="w-16"><label class="text-xs font-bold text-gray-500">№</label><input type="number" class="w-full border p-1" value="${b.number}" onchange="window.updateBlock(${i}, 'number', this.value)"></div><div class="w-16"><label class="text-xs font-bold text-gray-500">Бали:</label><input type="number" class="w-full border p-1" value="${b.points}" onchange="window.updateBlock(${i}, 'points', this.value)"></div><div class="flex-1"><label class="text-xs font-bold text-gray-500">Запитання:</label>${window.getRichEditorHtml(b.question, `window.updateBlock(${i}, 'question', this.innerHTML)`)}</div></div><div class="ml-4 border-l-2 pl-2 mb-2"><label class="text-xs font-bold text-gray-500 block mb-1">Варіанти:</label>${b.options.map((opt, optIdx) => `<div class="flex items-start gap-2 mb-2"><div class="pt-3"><input type="radio" name="cor-${b.id}" ${b.correctId === opt.id ? 'checked' : ''} onchange="window.setCorrectOption(${i}, '${opt.id}')"></div><div class="flex-1">${window.getRichEditorHtml(opt.text, `window.updateOption(${i}, ${optIdx}, this.innerHTML)`)}</div><button onclick="window.removeOption(${i}, ${optIdx})" class="text-red-500 px-2 pt-3">×</button></div>`).join('')}<button onclick="window.addOption(${i})" class="text-blue-500 text-xs underline mt-1">+ Додати варіант</button></div><div class="mt-2"><label class="text-xs font-bold text-gray-500">Пояснення:</label>${window.getRichEditorHtml(b.explanation || '', `window.updateBlock(${i}, 'explanation', this.innerHTML)`)}</div>${hintField}`;
                                    } else if (b.type === 'multiple') { 
                                        content = `<div class="flex gap-2 mb-2"><div class="w-16"><label class="text-xs font-bold text-gray-500">№</label><input type="number" class="w-full border p-1" value="${b.number}" onchange="window.updateBlock(${i}, 'number', this.value)"></div><div class="w-24"><label class="text-xs font-bold text-gray-500">Бали (1 вибір):</label><input type="number" class="w-full border p-1" value="${b.pointsPerSelection}" onchange="window.updateBlock(${i}, 'pointsPerSelection', this.value)"></div><div class="flex-1"><label class="text-xs font-bold text-gray-500">Запитання:</label>${window.getRichEditorHtml(b.question, `window.updateBlock(${i}, 'question', this.innerHTML)`)}</div></div><div class="ml-4 border-l-2 pl-2 mb-2"><label class="text-xs font-bold text-gray-500 block mb-1">Варіанти:</label>${b.options.map((opt, optIdx) => `<div class="flex items-start gap-2 mb-2"><div class="pt-3"><input type="checkbox" name="cor-${b.id}" ${b.correctIds.includes(opt.id) ? 'checked' : ''} onchange="window.toggleCorrectOption(${i}, '${opt.id}')"></div><div class="flex-1">${window.getRichEditorHtml(opt.text, `window.updateOption(${i}, ${optIdx}, this.innerHTML)`)}</div><button onclick="window.removeOption(${i}, ${optIdx})" class="text-red-500 px-2 pt-3">×</button></div>`).join('')}<button onclick="window.addOption(${i})" class="text-blue-500 text-xs underline mt-1">+ Додати варіант</button></div><div class="mt-2"><label class="text-xs font-bold text-gray-500">Пояснення:</label>${window.getRichEditorHtml(b.explanation || '', `window.updateBlock(${i}, 'explanation', this.innerHTML)`)}</div>${hintField}`;
                                    } else if (b.type === 'short') {
                                        content = `<div class="flex gap-2 mb-2"><div class="w-16"><label class="text-xs font-bold text-gray-500">№</label><input type="number" class="w-full border p-1" value="${b.number}" onchange="window.updateBlock(${i}, 'number', this.value)"></div><div class="w-16"><label class="text-xs font-bold text-gray-500">Бали:</label><input type="number" class="w-full border p-1" value="${b.points}" onchange="window.updateBlock(${i}, 'points', this.value)"></div><div class="flex-1"><label class="text-xs font-bold text-gray-500">Запитання:</label>${window.getRichEditorHtml(b.question, `window.updateBlock(${i}, 'question', this.innerHTML)`)}</div></div><div class="mb-2"><label class="text-xs font-bold text-gray-500">Правильна відповідь:</label><input type="text" class="border p-1 w-full" value="${b.correctAnswer}" onchange="window.updateBlock(${i}, 'correctAnswer', this.value)"></div><div class="mt-2"><label class="text-xs font-bold text-gray-500">Пояснення:</label>${window.getRichEditorHtml(b.explanation || '', `window.updateBlock(${i}, 'explanation', this.innerHTML)`)}</div>${hintField}`;
                                    } else if (b.type === 'matching') {
                                        content = `<div class="flex gap-2 mb-2"><div class="w-16"><label class="text-xs font-bold text-gray-500">№</label><input type="number" class="w-full border p-1" value="${b.number}" onchange="window.updateBlock(${i}, 'number', this.value)"></div><div class="w-24"><label class="text-xs font-bold text-gray-500">Бали (за пару):</label><input type="number" class="w-full border p-1" value="${b.pointsPerPair}" onchange="window.updateBlock(${i}, 'pointsPerPair', this.value)"></div><div class="flex-1"><label class="text-xs font-bold text-gray-500">Запитання:</label>${window.getRichEditorHtml(b.question, `window.updateBlock(${i}, 'question', this.innerHTML)`)}</div></div><div class="grid grid-cols-2 gap-4 mb-2"><div><label class="text-xs font-bold text-gray-500">Ліва колонка:</label><input type="text" class="border p-1 w-full" value="${b.leftLabel || ''}" onchange="window.updateBlock(${i}, 'leftLabel', this.value)"></div><div><label class="text-xs font-bold text-gray-500">Права колонка:</label><input type="text" class="border p-1 w-full" value="${b.rightLabel || ''}" onchange="window.updateBlock(${i}, 'rightLabel', this.value)"></div></div><div class="grid grid-cols-2 gap-4 mb-2"><div><label class="text-xs font-bold text-gray-500">Ліва колонка:</label>${b.leftItems.map((item, itemIdx) => `<div class="flex items-start gap-1 mb-2"><div class="flex-1">${window.getRichEditorHtml(item.text, `window.updateMatchingItem(${i}, 'left', ${itemIdx}, this.innerHTML)`)}</div><button onclick="window.removeMatchingItem(${i}, 'left', ${itemIdx})" class="text-red-500 px-1 pt-3">×</button></div>`).join('')}<button onclick="window.addMatchingItem(${i}, 'left')" class="text-blue-500 text-xs underline">+ Додати</button></div><div><label class="text-xs font-bold text-gray-500">Права колонка:</label>${b.rightItems.map((item, itemIdx) => `<div class="flex items-start gap-1 mb-2"><div class="flex-1">${window.getRichEditorHtml(item.text, `window.updateMatchingItem(${i}, 'right', ${itemIdx}, this.innerHTML)`)}</div><button onclick="window.removeMatchingItem(${i}, 'right', ${itemIdx})" class="text-red-500 px-1 pt-3">×</button></div>`).join('')}<button onclick="window.addMatchingItem(${i}, 'right')" class="text-blue-500 text-xs underline">+ Додати</button></div></div><div class="bg-gray-50 p-2 border rounded"><label class="text-xs font-bold text-gray-500 block mb-1">Відповідності:</label>${b.leftItems.map(left => `<div class="flex items-center gap-2 mb-1 text-sm"><span class="w-1/2 truncate">${left.text.replace(/<[^>]*>/g, '')}</span><span>→</span><select class="border p-1 flex-1" onchange="window.updateMatchingPair(${i}, '${left.id}', this.value)"><option value="">(Оберіть)</option>${b.rightItems.map(right => `<option value="${right.id}" ${b.correctPairs[left.id] === right.id ? 'selected' : ''}>${right.text.replace(/<[^>]*>/g, '')}</option>`).join('')}</select></div>`).join('')}</div><div class="mt-2"><label class="text-xs font-bold text-gray-500">Пояснення:</label>${window.getRichEditorHtml(b.explanation || '', `window.updateBlock(${i}, 'explanation', this.innerHTML)`)}</div>${hintField}`;
                                    } else if (b.type === 'dropdown') { 
                                        content = `<div class="flex gap-2 mb-2"><div class="w-16"><label class="text-xs font-bold text-gray-500">№</label><input type="number" class="w-full border p-1" value="${b.number}" onchange="window.updateBlock(${i}, 'number', this.value)"></div><div class="w-24"><label class="text-xs font-bold text-gray-500">Бали (список):</label><input type="number" class="w-full border p-1" value="${b.pointsPerDropdown}" onchange="window.updateBlock(${i}, 'pointsPerDropdown', this.value)"></div><div class="flex-1"><label class="text-xs font-bold text-gray-500">Запитання:</label><div class="mb-1"><button class="spa-btn spa-btn-secondary text-xs bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100" onmousedown="event.preventDefault(); window.insertDropdownPlaceholder(${i})">+ Вставити список</button></div>${window.getRichEditorHtml(b.question, `window.updateBlock(${i}, 'question', this.innerHTML)`)}</div></div><div class="bg-gray-50 p-3 border rounded mt-2"><label class="text-xs font-bold text-gray-500 block mb-2">Списки:</label>${b.dropdowns && b.dropdowns.length > 0 ? b.dropdowns.map((dd, ddIdx) => `<div class="bg-white p-2 border rounded mb-2 shadow-sm"><div class="flex justify-between items-center mb-2 border-b pb-1"><span class="font-bold text-sm text-blue-600">${dd.name}</span><button type="button" onclick="window.removeDropdown(${i}, ${ddIdx})" class="text-red-500 text-xs hover:underline">Видалити</button></div><div class="space-y-2">${dd.options.map((opt, optIdx) => `<div class="flex items-center gap-2"><input type="radio" name="dd-correct-${dd.id}" ${dd.correctId === opt.id ? 'checked' : ''} onchange="window.setCorrectDropdownOption(${i}, ${ddIdx}, '${opt.id}')"><input type="text" class="flex-1 border p-1 text-sm" value="${opt.text}" onchange="window.updateDropdownOption(${i}, ${ddIdx}, ${optIdx}, this.value)"><button onclick="window.removeDropdownOption(${i}, ${ddIdx}, ${optIdx})" class="text-red-400 px-1">×</button></div>`).join('')}<button onclick="window.addDropdownOption(${i}, ${ddIdx})" class="text-blue-500 text-xs underline">+ Додати варіант</button></div></div>`).join('') : '<div class="text-sm text-gray-400 italic">Списки ще не додані.</div>'}</div><div class="mt-2"><label class="text-xs font-bold text-gray-500">Пояснення:</label>${window.getRichEditorHtml(b.explanation || '', `window.updateBlock(${i}, 'explanation', this.innerHTML)`)}</div>${hintField}`;
                                    }

                                    return `
                                        <div id="edit-blk-${i}" class="border p-4 mb-4 relative bg-white rounded shadow-sm" style="padding-left: 45px;">
                                            ${!isBankMode ? `
                                            <div class="absolute top-1/2 -translate-y-1/2 left-3 flex flex-col gap-1">
                                                <button class="move-btn" onclick="window.moveBlock(${i}, 'up')" ${i === 0 ? 'disabled' : ''}>▲</button>
                                                <button class="move-btn" onclick="window.moveBlock(${i}, 'down')" ${i === test.blocks.length - 1 ? 'disabled' : ''}>▼</button>
                                            </div>` : ''}
                                            
                                            <div>
                                                <div class="absolute top-2 right-2 flex gap-1">
                                                    ${!isBankMode ? `
                                                    <button onclick="window.duplicateBlock(${i})" class="text-blue-500 font-bold hover:bg-blue-50 px-2 py-1 rounded" title="Дублювати">${ICONS.copy}</button>
                                                    <button onclick="window.exportTaskToBank(${i})" class="text-purple-500 font-bold hover:bg-purple-50 px-2 py-1 rounded" title="Зберегти в Банк">💾</button>
                                                    <button onclick="window.state.editorDraft.blocks.splice(${i},1); window.renderApp()" class="text-red-500 font-bold hover:bg-red-50 px-2 py-1 rounded" title="Видалити">✕</button>
                                                    ` : ''}
                                                </div>
                                                <div class="text-xs font-bold uppercase mb-2 text-gray-400">${typeLabels[b.type] || b.type}</div>
                                                ${content}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        ${sidebarHtml}

                    </div>
                </div>
            `;
        };

        // --- RUNNER (TEST PLAYER) ---
        window.runTest = function(id) {
            window.state.activeTestId = id;
            
            // ВАЖЛИВІ ВИПРАВЛЕННЯ:
            window.state.activeSessionId = null; // Це не сесія учня
            window.state.studentName = null;     // Немає імені
            window.state.isReviewMode = false;   // <--- ВИМИКАЄМО РЕЖИМ ПЕРЕГЛЯДУ
            
            // ОЧИЩЕННЯ СТАНУ: Скидаємо все для нового запуску
            window.state.runnerState = {
                answers: {},
                isFinished: false,
                startTime: null, 
                timerVisible: true,
                currentPage: 0 
            };
            
            window.state.view = 'pre-test';
            window.renderApp();
        };

        window.renderPreTest = function(container) {
            const test = window.findItem(window.state.activeTestId); 
            container.innerHTML = `
                <div class="max-w-4xl mx-auto p-6">
                    <div class="spa-card">
                        <div class="text-center">
                            <h1 class="text-3xl font-bold mb-2">${test.title}</h1>
                            <p class="text-lg text-gray-600 mb-6">${test.description}</p>
                        </div>
                        
                        <div class="text-left p-4 border rounded bg-gray-50 mb-8">
                            <h2 class="text-xl font-bold mb-4">Інструкція</h2>
                            <div class="rich-content" style="max-height: none; min-height: 100px; padding: 0;">
                                ${test.preTestDescription || 'Ви готові розпочати тестування.'}
                            </div>
                        </div>

                        <div class="text-center">
                            <button onclick="window.startActualTest()" class="btn-brand text-lg px-8 py-3">Перейти до тестування</button>
                        </div>
                    </div>
                </div>
            `;
            if (window.MathJax && window.MathJax.typesetPromise) {
                 window.MathJax.typesetPromise();
            }
        }

        window.startActualTest = function() {
            const test = window.findItem(window.state.activeTestId); 
            const session = window.state.sessions.find(s => s.id === window.state.activeSessionId);

            window.state.view = 'runner';
            
            const startTime = window.state.runnerState.startTime || Date.now();
            
            window.state.runnerState = { 
                isFinished: false, 
                answers: window.state.runnerState.answers || {}, 
                timerVisible: true,
                startTime: startTime,
                currentPage: window.state.runnerState.currentPage || 0 // Зберігаємо поточну сторінку
            };
            
            window.saveProgress();
            window.renderApp();
            
            // --- ЛОГІКА ТАЙМЕРА (ЗМІНЕНО) ---
            // Запускаємо таймер тільки якщо час > 0
            if (test.timeLimit > 0) {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                const remaining = test.timeLimit - elapsedSeconds;
                window.startTimer(remaining > 0 ? remaining : 0);
            } else {
                // Якщо немає таймера, очищаємо будь-який старий інтервал
                if (window.timerInterval) clearInterval(window.timerInterval);
            }

            // --- ЛОГІКА ПОВНОГО ЕКРАНУ ---
            if (session && session.requiresFullscreen && !window.state.isReviewMode) {
                // ... (тут ваш старий код для повного екрану, без змін) ...
                const checkFullscreen = () => {
                    if (window.state.runnerState.isFinished) return;

                    const overlayId = 'fullscreen-pause-overlay';
                    let overlay = document.getElementById(overlayId);

                    if (!document.fullscreenElement) {
                        if (!overlay) {
                            overlay = document.createElement('div');
                            overlay.id = overlayId;
                            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;';
                            overlay.innerHTML = `
                                <h2 class="text-2xl font-bold text-red-600 mb-4">Тест призупинено!</h2>
                                <p class="mb-6 text-gray-700 max-w-md">Ви вийшли з повноекранного режиму. Тестування можливе лише в повному екрані.</p>
                                <button id="resume-fs-btn" class="btn-brand text-lg py-3 px-8">Повернутися до тесту ▶</button>
                            `;
                            document.body.appendChild(overlay);
                            
                            document.getElementById('resume-fs-btn').onclick = function() {
                                document.documentElement.requestFullscreen().then(() => {
                                    overlay.style.display = 'none';
                                }).catch(() => {
                                    alert("Не вдалося відновити повний екран. Спробуйте ще раз.");
                                });
                            };
                        }
                        overlay.style.display = 'flex';
                    } else {
                        if (overlay) overlay.style.display = 'none';
                    }
                };

                document.addEventListener('fullscreenchange', checkFullscreen);
                window.state.fullscreenListener = checkFullscreen; 
            }
        };


        window.startTimer = function(seconds) {
            if(timerInterval) clearInterval(timerInterval);
            let sec = seconds;
            timerInterval = setInterval(() => {
                if(window.state.runnerState.isFinished) { clearInterval(timerInterval); return; }
                sec--;
                const display = document.getElementById('timer-display');
                const open = document.getElementById('icon-eye-open');
                const closed = document.getElementById('icon-eye-closed');

                if (window.state.runnerState.timerVisible) {
                    open.style.display = 'block';
                    closed.style.display = 'none';
                    if(display) {
                        const h = Math.floor(sec / 3600).toString().padStart(1,'0');
                        const m = Math.floor((sec % 3600) / 60).toString().padStart(2,'0');
                        const s = (sec % 60).toString().padStart(2,'0');
                        display.textContent = `${h}:${m}:${s}`;
                    }
                } else {
                    open.style.display = 'none';
                    closed.style.display = 'block';
                    if(display) display.textContent = "";
                }

                if(sec <= 0) window.finishTest(true);
            }, 1000);
        };

        window.toggleTimer = function() {
            window.state.runnerState.timerVisible = !window.state.runnerState.timerVisible;
            const display = document.getElementById('timer-display');
            const open = document.getElementById('icon-eye-open');
            const closed = document.getElementById('icon-eye-closed');
            if (window.state.runnerState.timerVisible) {
                open.style.display = 'block';
                closed.style.display = 'none';
            } else {
                open.style.display = 'none';
                closed.style.display = 'block';
                if(display) display.textContent = "";
            }
        };

        window.toggleTopPanel = function() {
            document.getElementById('top-panel').classList.toggle('hidden-panel');
            const btn = document.getElementById('return-panel-btn');
            if(btn) btn.style.display = btn.style.display === 'block' ? 'none' : 'block';
            document.body.style.paddingTop = document.getElementById('top-panel').classList.contains('hidden-panel') ? '60px' : '260px';
        };

        window.toggleHint = function(id) {
            const box = document.getElementById(`hint-box-${id}`);
            const btn = document.getElementById(`hint-btn-${id}`);
            if (box.style.display === 'block') {
                box.style.display = 'none';
                btn.innerHTML = '💡 Показати підказку';
            } else {
                box.style.display = 'block';
                btn.innerHTML = '💡 Приховати підказку';
            }
        };

        window.showPrompt = function(title, defaultValue, onOk) {
            const modal = document.getElementById('prompt-modal');
            document.getElementById('prompt-modal-title').innerText = title;
            const input = document.getElementById('prompt-modal-input');
            input.value = defaultValue;
            modal.style.display = 'flex';
            
            setTimeout(() => input.focus(), 100); 

            const btnOk = document.getElementById('prompt-modal-btn-ok');
            const newBtnOk = btnOk.cloneNode(true); 
            btnOk.parentNode.replaceChild(newBtnOk, btnOk);

            const btnCancel = document.getElementById('prompt-modal-btn-cancel');
            const newBtnCancel = btnCancel.cloneNode(true); 
            btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);

            newBtnOk.onclick = function() {
                const val = input.value.trim();
                if (val) {
                    modal.style.display = 'none';
                    onOk(val);
                } else {
                    input.focus(); 
                }
            };
            newBtnCancel.onclick = function() {
                modal.style.display = 'none';
            };
        };
        
        window.showModal = function(title, bodyHTML, onYes) {
            const modal = document.getElementById('global-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = bodyHTML;
            modal.style.display = 'flex';
            
            const btnYes = document.getElementById('modal-btn-yes');
            const newBtnYes = btnYes.cloneNode(true);
            btnYes.parentNode.replaceChild(newBtnYes, btnYes);
            
            const btnNo = document.getElementById('modal-btn-no');
            const newBtnNo = btnNo.cloneNode(true);
            btnNo.parentNode.replaceChild(newBtnNo, btnNo);

            newBtnYes.onclick = function() {
                modal.style.display = 'none';
                onYes();
            };
            newBtnNo.onclick = function() {
                modal.style.display = 'none';
            };
        };

        window.requestReturnToEditor = function() {
            window.showModal(
                'Повернутися в редактор?', 
                '<p>Увага! Ваш прогрес тестування буде втрачено. Ви впевнені?</p>', 
                function() {
                    clearInterval(timerInterval);
                    window.editTest(window.state.activeTestId);
                }
            );
        };

        window.requestFinishTest = function() {
            const test = window.findItem(window.state.activeTestId); 
            const answers = window.state.runnerState.answers;
            
            const savedTasks = [];
            const unsavedTasks = [];

            test.blocks.forEach(b => {
                if(b.number) { 
                    if(answers[b.id] && answers[b.id].final) {
                        savedTasks.push(b.number);
                    } else {
                        unsavedTasks.push(b.number);
                    }
                }
            });

            let report = '';
            if(savedTasks.length > 0) {
                report += `<p class="text-green-600 mb-2"><b>Збережено відповіді на завдання:</b> ${savedTasks.join(', ')}</p>`;
            } else {
                report += `<p class="text-gray-500 mb-2">Жодної відповіді не збережено.</p>`;
            }

            if(unsavedTasks.length > 0) {
                report += `<p class="text-red-600 mb-4"><b>НЕ збережено відповіді на завдання:</b> ${unsavedTasks.join(', ')}</p>`;
            }

            report += `<p class="font-bold">Ви точно хочете завершити роботу над тестом?</p>`;

            window.showModal(
                'Завершення роботи', 
                report, 
                function() {
                    window.finishTest(true);
                }
            );
        };

	window.saveStructured = function(id) {
            if(window.state.runnerState.isFinished) return;
            
            // Збираємо всі інпути цього блоку
            const inputs = document.querySelectorAll(`[id^="in-${id}-"]`);
            const answers = {};
            let allFilled = true;

            inputs.forEach(input => {
                const itemId = input.dataset.itemid;
                const val = input.value.trim();
                if (!val) allFilled = false;
                answers[itemId] = val;
            });

            if(allFilled) { 
                window.state.runnerState.answers[id] = { final: answers }; 
                window.markSaved(id); 
            } else { 
                const fb=document.getElementById(`fb-${id}`); 
                fb.innerText="Заповніть відповіді на всі підпитання!"; 
                fb.style.display='block'; 
            }
        };

        window.changePage = function(delta) {
            window.state.runnerState.currentPage += delta;
            // Скролимо вгору при зміні сторінки
            window.scrollTo({ top: 0, behavior: 'smooth' });
            window.renderApp();
        };

        window.renderRunner = function(container) {
            const test = window.findItem(window.state.activeTestId); 
            
            // --- ЛОГІКА СТОРІНОК ---
            // Розбиваємо блоки на сторінки
            const pages = window.getTestPages(test.blocks);
            // Перевіряємо, чи індекс сторінки в межах (на випадок помилки)
            if (window.state.runnerState.currentPage >= pages.length) {
                window.state.runnerState.currentPage = pages.length - 1;
            }
            if (window.state.runnerState.currentPage < 0) {
                window.state.runnerState.currentPage = 0;
            }
            
            const currentBlocks = pages[window.state.runnerState.currentPage];
            // ---------------------

            // --- ТАЙМЕР ---
            let initialTimeStr = '';
            let timerControls = '';
            
            if (window.state.isReviewMode) {
                timerControls = `<div class="text-xl font-bold text-gray-700">Перегляд результатів: ${window.state.studentName || 'Учень'}</div>`;
            } else {
                // Якщо є ліміт часу
                if (test.timeLimit > 0) {
                    const initialSeconds = test.timeLimit;
                    const h = Math.floor(initialSeconds / 3600).toString().padStart(1, '0');
                    const m = Math.floor((initialSeconds % 3600) / 60).toString().padStart(2, '0');
                    const s = (initialSeconds % 60).toString().padStart(2, '0');
                    initialTimeStr = `${h}:${m}:${s}`;
                    
                    timerControls = `
                        ${test.referenceUrl ? `<button class="btn-brand bg-blue-600 border-blue-600 hover:bg-blue-700" onclick="window.showReferenceMaterials()">Довідкові матеріали</button>` : ''}
                        <button class="btn-brand" onclick="window.requestFinishTest()">Завершити роботу над тестом</button>
                        <div id="timer-display" class="timer-display">${initialTimeStr}</div>
                        <button id="eye-btn" class="eye-btn-styled" onclick="window.toggleTimer()" title="Показати/Приховати час">
                             <svg id="icon-eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                             <svg id="icon-eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                        </button>
                    `;
                } else {
                    // Якщо немає ліміту - просто кнопки
                    timerControls = `
                        ${test.referenceUrl ? `<button class="btn-brand bg-blue-600 border-blue-600 hover:bg-blue-700" onclick="window.showReferenceMaterials()">Довідкові матеріали</button>` : ''}
                        <button class="btn-brand" onclick="window.requestFinishTest()">Завершити роботу над тестом</button>
                    `;
                }
            }

            // Генеруємо HTML блоків (ТІЛЬКИ ДЛЯ ПОТОЧНОЇ СТОРІНКИ)
            const blocksHtml = currentBlocks.map(b => {
                if(b.type==='instruction') return `<div class="instruction-block"><b>${b.text}</b></div>`;
                
                let content = '';
                let hintBlock = '';
                if (b.hint && b.hint.trim() !== '') {
                    hintBlock = `
                        <button id="hint-btn-${b.id}" class="hint-btn" onclick="window.toggleHint('${b.id}')">💡 Показати підказку</button>
                        <div id="hint-box-${b.id}" class="hint-box"><div class="hint-content">${b.hint}</div></div>
                    `;
                }

                if(b.type==='single') {
                    content = `<div class="wrapper-problem-response"><div class="mb-4 text-lg">${b.question}</div>
                    <div id="g-${b.id}">${b.options.map(o => `<label class="option-card" id="opt-${o.id}"><input type="radio" name="n-${b.id}" class="field-input" onclick="window.selectOpt('${b.id}','${o.id}')"><span class="response-label">${o.text}</span></label>`).join('')}</div></div>
                    ${hintBlock}
                    <div class="mt-6"><button id="btn-${b.id}" class="btn-brand" onclick="window.saveSingle('${b.id}')">Зберегти відповідь</button></div><div id="fb-${b.id}" class="notification"></div>
                    <div id="an-${b.id}" class="analysis-block"><div class="correct-answer-box">Правильно: ${b.options.find(o=>o.id===b.correctId)?.text}</div><div class="explanation-box">${b.explanation}</div></div>`;
                }

                else if (b.type === 'structured') {
                    // Формуємо HTML для підпитань
                    let itemsHtml = '';
                    
                    // ЗМІНА 2: Спрощений список правильних відповідей (тільки нумерація і значення)
                    let correctHtml = '<ul class="list-none pl-0">';
                    
                    b.items.forEach((item, index) => {
                        // Формуємо рядок: "1. 15.5"
                        correctHtml += `<li class="mb-1">${index + 1}. <b>${item.correctAnswer}</b></li>`;
                        
                        itemsHtml += `
                            <div class="mb-6 p-4 bg-white border border-gray-200 rounded shadow-sm">
                                <div class="mb-3 rich-content text-lg" style="padding:0; border:none; font-weight: normal;">${item.text}</div>
                                
                                <div class="formulaequationinput">
                                    <label class="block mb-2 text-black">Упишіть відповідь:</label>
                                    <input type="text" id="in-${b.id}-${item.id}" data-itemid="${item.id}" class="field-input-text w-full md:w-1/2 p-2 border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors" oninput="window.resetBtn('${b.id}')">
                                </div>
                            </div>
                        `;
                    });
                    correctHtml += '</ul>';

                    content = `<div class="wrapper-problem-response">
                        <div class="mb-4 text-lg">${b.question}</div>
                        <div class="mt-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                            ${itemsHtml}
                        </div>
                    </div>
                    ${hintBlock}
                    <div class="mt-6"><button id="btn-${b.id}" class="btn-brand" onclick="window.saveStructured('${b.id}')">Зберегти відповідь</button></div>
                    <div id="fb-${b.id}" class="notification"></div>
                    <div id="an-${b.id}" class="analysis-block">
                        <div class="correct-answer-box"><b>Правильні відповіді:</b><br>${correctHtml}</div>
                        <div class="explanation-box">${b.explanation}</div>
                    </div>`;
                
                } else if(b.type==='multiple') { 
                    let correctHtml = '<ul class="list-none text-left p-0">';
                    b.correctIds.forEach(id => {
                        const correctText = b.options.find(item => item.id === id)?.text || '???';
                        correctHtml += `<li class="mb-1 p-1 border-b border-blue-100">${correctText.replace(/<[^>]*>/g, '')}</li>`;
                    });
                    correctHtml += '</ul>';
                    content = `<div class="wrapper-problem-response"><div class="mb-4 text-lg">${b.question}</div>
                    <div id="g-${b.id}">${b.options.map(o => `<label class="option-card-multi" id="opt-${o.id}"><input type="checkbox" name="n-${b.id}" class="field-input-multi" onclick="window.selectMultiOpt('${b.id}','${o.id}', this)"><span class="response-label">${o.text}</span></label>`).join('')}</div></div>
                    ${hintBlock}
                    <div class="mt-6"><button id="btn-${b.id}" class="btn-brand" onclick="window.saveMulti('${b.id}')">Зберегти відповідь</button></div><div id="fb-${b.id}" class="notification"></div>
                    <div id="an-${b.id}" class="analysis-block"><div class="correct-answer-box"><b>Правильні відповіді:</b><br>${correctHtml}</div><div class="explanation-box">${b.explanation}</div></div>`;

                } else if (b.type==='short') {
                    content = `<div class="wrapper-problem-response"><div class="mb-4 text-lg">${b.question}</div><div class="formulaequationinput"><label class="block mb-2 text-lg">Упишіть відповідь:</label><div><input type="text" id="in-${b.id}" class="field-input-text" oninput="window.resetBtn('${b.id}')"></div></div></div>
                    ${hintBlock}
                    <div class="mt-6"><button id="btn-${b.id}" class="btn-brand" onclick="window.saveShort('${b.id}')">Зберегти відповідь</button></div><div id="fb-${b.id}" class="notification"></div>
                    <div id="an-${b.id}" class="analysis-block"><div class="correct-answer-box">Правильно: ${b.correctAnswer}</div><div class="explanation-box">${b.explanation}</div></div>`;
                
                } else if (b.type==='matching') {
                    let correctHtml = '<ul class="list-none text-left p-0">';
                    for (const leftId in b.correctPairs) {
                        const rightId = b.correctPairs[leftId];
                        const leftText = b.leftItems.find(item => item.id === leftId)?.text || '???';
                        const rightText = b.rightItems.find(item => item.id === rightId)?.text || '???';
                        correctHtml += `<li class="mb-1 p-1 border-b border-blue-100">${leftText.replace(/<[^>]*>/g, '')} <span class="font-bold text-blue-600">→</span> ${rightText.replace(/<[^>]*>/g, '')}</li>`;
                    }
                    correctHtml += '</ul>';
                    content = `<div class="wrapper-problem-response"><div class="mb-6 text-lg">${b.question}</div>
                    <div class="dnd-container">
                        <div class="dnd-column-left">
                            ${b.leftLabel ? `<div class="text-lg text-gray-800 mb-2 italic">${b.leftLabel}</div>` : ''}
                            <div class="dnd-questions-box">${b.leftItems.map(l=>`<div class="dnd-row"><div class="dnd-item-question">${l.text}</div><div class="dnd-arrow"></div><div class="dnd-slot" id="slot-${b.id}-${l.id}" data-bid="${b.id}" data-lid="${l.id}" ondrop="window.dndDrop(event)" ondragover="event.preventDefault()"><span class="dnd-remove" onclick="window.dndRemove(event)">×</span></div></div>`).join('')}</div>
                        </div>
                        <div class="dnd-column-right">
                            ${b.rightLabel ? `<div class="text-lg text-gray-800 mb-2 italic">${b.rightLabel}</div>` : ''}
                            <div class="dnd-answers-box" id="pool-${b.id}" ondrop="window.dndDrop(event)" ondragover="event.preventDefault()">${b.rightItems.map(r=>`<div id="drag-${r.id}" class="dnd-draggable" draggable="true" ondragstart="window.dndStart(event)" data-rid="${r.id}" data-origin="pool-${b.id}">${r.text}</div>`).join('')}</div>
                        </div>
                    </div></div>
                    ${hintBlock}
                    <div class="mt-6"><button id="btn-${b.id}" class="btn-brand" onclick="window.saveMatching('${b.id}')">Зберегти відповідь</button></div><div id="fb-${b.id}" class="notification"></div>
                    <div id="an-${b.id}" class="analysis-block"><div class="correct-answer-box"><b>Правильні відповідності:</b><br>${correctHtml}</div><div class="explanation-box">${b.explanation}</div></div>`;
                
                } else if (b.type === 'dropdown') {
                    let questionHtml = b.question;
                    if (b.dropdowns) {
                        b.dropdowns.forEach(dd => {
                            const placeholderRegex = new RegExp(`<span[^>]*data-id="${dd.id}"[^>]*>.*?</span>`, 'g');
                            const optionsHtml = dd.options.map(opt => `<option value="${opt.id}">${opt.text}</option>`).join('');
                            const selectHtml = `<select class="runner-select" id="dd-input-${b.id}-${dd.id}" onchange="window.resetBtn('${b.id}')">${optionsHtml}</select>`;
                            questionHtml = questionHtml.replace(placeholderRegex, selectHtml);
                        });
                    }
                    let correctHtml = '<ul class="list-none text-left p-0">';
                    if(b.dropdowns) {
                        b.dropdowns.forEach(dd => {
                            const correctOpt = dd.options.find(o => o.id === dd.correctId);
                            correctHtml += `<li class="mb-1"><b>${dd.name}:</b> ${correctOpt ? correctOpt.text : '(не вказано)'}</li>`;
                        });
                    }
                    correctHtml += '</ul>';
                    content = `<div class="wrapper-problem-response"><div class="mb-4 text-lg leading-loose">${questionHtml}</div></div>
                    ${hintBlock}
                    <div class="mt-6"><button id="btn-${b.id}" class="btn-brand" onclick="window.saveDropdown('${b.id}')">Зберегти відповідь</button></div><div id="fb-${b.id}" class="notification"></div>
                    <div id="an-${b.id}" class="analysis-block"><div class="correct-answer-box"><b>Правильні відповіді:</b><br>${correctHtml}</div><div class="explanation-box">${b.explanation}</div></div>`;
                }

                return `<div class="xblock" id="blk-${b.id}">${b.number ? `<h3 class="problem-header">Завдання ${b.number}</h3>`:''}<div class="problem">${content}</div></div>`;
            }).join('');

            // ЛОГІКА ПАНЕЛІ (Back etc)
            const infoText = test.infoPanelContent || 'Національний мультипредметний тест...';
            const editorReturnBtn = (!window.state.activeSessionId) 
                ? `<br><button id="btn-return-editor" class="text-blue-600 underline bg-transparent border-0 cursor-pointer mt-1" onclick="window.requestReturnToEditor()">← Повернутися в редактор</button>` 
                : ``;
            const backToCabinetBtn = (window.state.isReviewMode) 
                ? `<div class="fixed top-2 left-4 z-[2000]"><button onclick="window.state.view='dashboard'; window.switchSection('cabinet'); window.renderApp();" class="bg-gray-700 text-white py-2 px-4 rounded hover:bg-gray-900">← Назад у кабінет</button></div>`
                : ``;

            // --- ПАНЕЛЬ НАВІГАЦІЇ (КНОПКИ ВНИЗУ) ---
            const currentPageIndex = window.state.runnerState.currentPage;
            const totalPages = pages.length;
            
            let paginationHtml = '';
            if (totalPages > 1) {
                const prevBtn = currentPageIndex > 0 
                    ? `<button onclick="window.changePage(-1)" class="btn-brand bg-white text-gray-800 border-gray-300 hover:bg-gray-100">← Назад</button>` 
                    : `<div></div>`;
                
                const nextBtn = currentPageIndex < totalPages - 1 
                    ? `<button onclick="window.changePage(1)" class="btn-brand">Далі →</button>` 
                    : `<div></div>`; // На останній сторінці кнопки "Далі" немає (є кнопка "Завершити" вгорі)

                paginationHtml = `
                    <div class="pagination-container">
                        ${prevBtn}
                        <div class="text-gray-500 font-bold self-center">Сторінка ${currentPageIndex + 1} з ${totalPages}</div>
                        ${nextBtn}
                    </div>
                `;
            }

            // Визначаємо завдання поточної сторінки для відображення в панелі
            const visibleTasks = currentBlocks.filter(b => b.number);
            const sbConfig = window.getSidebarConfig(visibleTasks.length);

            container.innerHTML = `
                ${backToCabinetBtn}
                <button id="return-panel-btn" class="btn-brand return-panel-btn" onclick="window.toggleTopPanel()">Повернути панель інформації</button>
                <div id="top-panel" class="top-info-panel">
                    <p class="info-text">${infoText}
                    <span class="text-[#FF2938] cursor-pointer font-bold ml-2" onclick="window.toggleTopPanel()">Сховати</span>
                    ${editorReturnBtn}</p>
                    <div class="timer-controls">
                        ${timerControls}
                    </div>
                </div>
                <div class="p-4 md:p-8 max-w-7xl mx-auto">
                    <header class="mb-10 p-8 rounded-xl shadow-lg text-center uppercase bg-white border border-gray-100">
                        <h1 class="header-brand-color text-3xl font-bold">${test.title}</h1>
                        ${test.description ? `<p class="text-gray-600 text-lg mt-2 normal-case">${test.description}</p>` : ''}
                    </header>
                    <div class="flex flex-col lg:flex-row gap-8">
                        <div class="flex-1">
                            ${blocksHtml}
                            ${paginationHtml}
                        </div>
                        <div class="w-full lg:w-48 flex-shrink-0"><div class="sidebar-panel">
                            <div class="sidebar-title">Завдання</div>
                            
                            <div class="sidebar-grid" style="grid-template-columns: repeat(${sbConfig.cols}, 1fr);">
                                ${visibleTasks.map(b => `
                                    <div id="side-${b.id}" class="task-square" 
                                         style="width: ${sbConfig.size}; height: ${sbConfig.size}; font-size: ${sbConfig.fontSize};"
                                         onclick="document.getElementById('blk-${b.id}').scrollIntoView({behavior:'smooth'})">
                                         ${b.number}
                                    </div>
                                `).join('')}
                            </div>

                        </div></div>
                    </div>
                </div>
            `;
            
            if (window.state.isReviewMode) {
                setTimeout(() => window.highlightAnswersInReview(), 100);
            }
        };

        // --- INTERACTION LOGIC ---
        window.resetBtn = function(id) {
            if(window.state.runnerState.isFinished) return;
            const btn = document.getElementById(`btn-${id}`);
            if(btn) { btn.textContent = "Зберегти відповідь"; btn.classList.remove('btn-saved-state'); }
            const side = document.getElementById(`side-${id}`);
            if(side) side.classList.remove('completed');
        };
        
        window.markSaved = function(id) {
            const btn = document.getElementById(`btn-${id}`);
            if(btn) {
                btn.textContent = "Відповідь збережено"; 
                btn.classList.add('btn-saved-state');
            }
            document.getElementById(`side-${id}`)?.classList.add('completed');
            const fb = document.getElementById(`fb-${id}`);
            if(fb) fb.style.display = 'none';
            
            // НОВЕ: Зберігаємо прогрес у LocalStorage після кожного успішного збереження відповіді
            window.saveProgress();
        };

        window.selectOpt = function(bid, oid) {
            if(window.state.runnerState.isFinished) return;
            window.resetBtn(bid);
            document.querySelectorAll(`#g-${bid} .option-card`).forEach(el=>el.classList.remove('selected'));
            document.getElementById(`opt-${oid}`).classList.add('selected');
            if(!window.state.runnerState.answers[bid]) window.state.runnerState.answers[bid] = {};
            window.state.runnerState.answers[bid].temp = oid;
        };

        window.selectMultiOpt = function(bid, oid, checkboxElement) {
            if(window.state.runnerState.isFinished) return;
            window.resetBtn(bid);
            
            const test = window.findItem(window.state.activeTestId);
            const block = test.blocks.find(b => b.id === bid);
            const maxAllowed = block.correctIds ? block.correctIds.length : 0;

            if (!window.state.runnerState.answers[bid]) {
                window.state.runnerState.answers[bid] = { temp: [] };
            }
            const tempAnswers = window.state.runnerState.answers[bid].temp;
            
            const index = tempAnswers.indexOf(oid);

            if (checkboxElement.checked) {
                // Якщо намагається вибрати новий варіант
                if (tempAnswers.length >= maxAllowed) {
                    // НОВА ЛОГІКА: Видаляємо найстаріший (перший) обраний варіант
                    const removedId = tempAnswers.shift(); // Видаляє перший елемент масиву
                    
                    // Візуально знімаємо галочку зі старого варіанту
                    const removedInput = document.querySelector(`#opt-${removedId} input`);
                    if(removedInput) removedInput.checked = false;
                    document.getElementById(`opt-${removedId}`).classList.remove('selected');
                }
                // Додаємо новий
                if (index === -1) tempAnswers.push(oid);
            } else {
                // Якщо знімає вибір вручну
                if (index > -1) tempAnswers.splice(index, 1);
            }
            
            // Візуальне виділення поточного
            document.getElementById(`opt-${oid}`).classList.toggle('selected', checkboxElement.checked);
        };

        window.saveSingle = function(id) {
            if(window.state.runnerState.isFinished) return;
            const ans = window.state.runnerState.answers[id]?.temp;
            if(ans) { window.state.runnerState.answers[id].final = ans; window.markSaved(id); }
            else { const fb=document.getElementById(`fb-${id}`); fb.innerText="Оберіть варіант!"; fb.style.display='block'; }
        };

        window.saveMulti = function(id) {
            if(window.state.runnerState.isFinished) return;
            const ans = window.state.runnerState.answers[id]?.temp;
            if(ans && ans.length > 0) { 
                window.state.runnerState.answers[id].final = [...ans]; 
                window.markSaved(id); 
            } else { 
                const fb=document.getElementById(`fb-${id}`); 
                fb.innerText="Оберіть хоча б один варіант!"; 
                fb.style.display='block'; 
            }
        };

        window.saveShort = function(id) {
            if(window.state.runnerState.isFinished) return;
            const val = document.getElementById(`in-${id}`).value;
            if(val) { window.state.runnerState.answers[id] = { final: val }; window.markSaved(id); }
            else { const fb=document.getElementById(`fb-${id}`); fb.innerText="Введіть число!"; fb.style.display='block'; }
        };

        // Save function for Dropdowns
        window.saveDropdown = function(id) {
            if(window.state.runnerState.isFinished) return;
            
            // Find all dropdowns in this block
            // We can get them from DOM or state
            // Let's get state since we have ID
            const test = window.findItem(window.state.activeTestId);
            const block = test.blocks.find(b => b.id === id);
            
            if (!block || !block.dropdowns) return;

            const answers = {};
            let allSelected = true;

            block.dropdowns.forEach(dd => {
                const selectEl = document.getElementById(`dd-input-${id}-${dd.id}`);
                if (selectEl) {
                    if (!selectEl.value) {
                        allSelected = false;
                    }
                    answers[dd.id] = selectEl.value;
                }
            });

            if(allSelected) {
                window.state.runnerState.answers[id] = { final: answers }; 
                window.markSaved(id);
            } else {
                const fb=document.getElementById(`fb-${id}`); 
                fb.innerText="Заповніть усі поля!"; 
                fb.style.display='block'; 
            }
        };

        // DND Logic
        let dragItem = null;
        window.dndStart = function(ev) { if(!window.state.runnerState.isFinished) dragItem = ev.target; };
        window.dndDrop = function(ev) {
            if(window.state.runnerState.isFinished) return;
            ev.preventDefault();
            
            let t = ev.target;
            if (!t.classList.contains('dnd-slot') && !t.id.startsWith('pool-')) {
                t = t.closest('.dnd-slot') || t.closest('.dnd-answers-box');
            }
            
            if(!t) return; 

            if(t.classList.contains('dnd-slot')) {
                if(t.children.length > 0 && t.children[0] !== dragItem) {
                    const existingItem = t.children[0];
                    const pool = document.getElementById(existingItem.dataset.origin);
                    if(pool) pool.appendChild(existingItem);
                }
                t.appendChild(dragItem);
                window.resetBtn(t.dataset.bid);
            } else if(t.id.startsWith('pool-')) {
                const pool = t;
                const draggablesInPool = Array.from(pool.querySelectorAll('.dnd-draggable'));
                
                if (!draggablesInPool.includes(dragItem)) {
                     draggablesInPool.push(dragItem);
                }

                const draggablesWithText = draggablesInPool.map(d => ({ el: d, text: d.innerText }));
                draggablesWithText.sort((a, b) => a.text.localeCompare(b.text, 'uk', { sensitivity: 'base' }));

                draggablesWithText.forEach(item => {
                    pool.appendChild(item.el);
                });
            }
        };

        window.dndRemove = function(ev) {
            if(window.state.runnerState.isFinished) return;
            ev.stopPropagation(); 
            const slot = ev.target.closest('.dnd-slot');
            if (!slot) return;

            let draggableItem = null;
            for (let child of slot.children) {
                if (child.classList.contains('dnd-draggable')) {
                    draggableItem = child;
                    break;
                }
            }
            
            if (draggableItem) {
                const originPoolId = draggableItem.dataset.origin;
                const pool = document.getElementById(originPoolId);
                
                if (pool) {
                    const draggablesInPool = Array.from(pool.querySelectorAll('.dnd-draggable'));
                    draggablesInPool.push(draggableItem); 

                    const draggablesWithText = draggablesInPool.map(d => ({ el: d, text: d.innerText }));
                    draggablesWithText.sort((a, b) => a.text.localeCompare(b.text, 'uk', { sensitivity: 'base' }));

                    draggablesWithText.forEach(item => {
                        pool.appendChild(item.el);
                    });
                } else {
                    slot.removeChild(draggableItem);
                }
                
                window.resetBtn(slot.dataset.bid);
            }
        };

        window.saveMatching = function(id) {
            if(window.state.runnerState.isFinished) return;
            const pairs = {};
            let hasAnswers = false; 

            document.querySelectorAll(`[id^="slot-${id}-"]`).forEach(slot => {
                const draggableItem = slot.querySelector('.dnd-draggable'); 
                
                if(draggableItem) { 
                    pairs[slot.dataset.lid] = draggableItem.dataset.rid;
                    hasAnswers = true; 
                }
            });

            if(hasAnswers) { 
                window.state.runnerState.answers[id] = { final: pairs };
                window.markSaved(id);
            } else { 
                const fb=document.getElementById(`fb-${id}`); 
                fb.innerText="Заповніть поля!"; 
                fb.style.display='block'; 
                if (window.state.runnerState.answers[id]) {
                     delete window.state.runnerState.answers[id];
                }
            }
        };

        window.finishTest = function(confirmed) {
            // ЗАХИСТ ВІД ПОДВІЙНОГО СПРАЦЮВАННЯ
            if (window.state.runnerState.isFinished) return;

            clearInterval(timerInterval);
            // Поки що НЕ видаляємо прогрес, щоб не втратити дані при збої
            // localStorage.removeItem(...) перенесено вниз

            const test = window.findItem(window.state.activeTestId); 
            let score = 0, max = 0;
            
            test.blocks.forEach(b => {
                if(b.type==='instruction' || b.type==='pageBreak') return;
                
                const an = document.getElementById(`an-${b.id}`);
                const hasExplanation = b.explanation && b.explanation.replace(/<[^>]*>/g, '').trim().length > 0;
                
                if(an && hasExplanation) {
                    an.style.display = 'block';
                } else if (an) {
                    an.style.display = 'none';
                }
                
                const blk = document.getElementById(`blk-${b.id}`);
                // Перевіряємо чи існує блок (він може бути на іншій сторінці і не відрендерений в DOM)
                if(blk) {
                    blk.querySelectorAll('input, button, select').forEach(el => el.disabled = true);
                }

                // Підрахунок балів (Single)
                if(b.type==='single') { 
                    const points = parseInt(b.points) || 1; 
                    max += points; 
                    if(window.state.runnerState.answers[b.id]?.final === b.correctId) {
                        score += points; 
                    }
                }
                // Підрахунок балів (Short)
                else if(b.type==='short') { 
                    const points = parseInt(b.points) || 2; 
                    max += points; 
                    let userAns = window.state.runnerState.answers[b.id]?.final;
                    if(userAns) userAns = userAns.toString().replace(',', '.').trim();
                    
                    if(userAns == b.correctAnswer) {
                        score += points; 
                    }
                }
                // Підрахунок балів (Structured)
                else if(b.type==='structured') {
                    const userAnswers = window.state.runnerState.answers[b.id]?.final || {};
                    
                    b.items.forEach(item => {
                        const p = parseInt(item.points) || 1;
                        max += p;
                        
                        let userVal = userAnswers[item.id];
                        if (userVal) userVal = userVal.toString().replace(',', '.').trim();
                        let correctVal = item.correctAnswer.toString().replace(',', '.').trim();

                        if (userVal == correctVal) {
                            score += p;
                        }
                    });
                }
                // Підрахунок балів (Matching)
                else if(b.type==='matching') {
                    const pairs = window.state.runnerState.answers[b.id]?.final || {};
                    const points = parseInt(b.pointsPerPair) || 1; 
                    
                    Object.keys(b.correctPairs).forEach(k => { 
                        max += points; 
                        if(pairs[k] === b.correctPairs[k]) {
                            score += points; 
                        }
                    });
                }
                // Підрахунок балів (Multiple)
                else if(b.type==='multiple') { 
                    const userSelections = window.state.runnerState.answers[b.id]?.final || [];
                    const correctIds = b.correctIds || [];
                    const points = parseInt(b.pointsPerSelection) || 1;

                    let matchCount = 0;
                    userSelections.forEach(sel => {
                        if (correctIds.includes(sel)) {
                            matchCount++;
                        }
                    });
                    
                    score += (matchCount * points);
                    max += (correctIds.length * points);
                }
                // Підрахунок балів (Dropdown)
                else if(b.type==='dropdown') {
                    const userAnswers = window.state.runnerState.answers[b.id]?.final || {};
                    const points = parseInt(b.pointsPerDropdown) || 1;
                    
                    if(b.dropdowns) {
                        b.dropdowns.forEach(dd => {
                            max += points; 
                            if(userAnswers[dd.id] === dd.correctId) {
                                score += points;
                            }
                        });
                    }
                }
            });

            // ЗБЕРЕЖЕННЯ РЕЗУЛЬТАТУ (Якщо це сесія учня)
            if (window.state.activeSessionId && window.state.studentName) {
                const resultRecord = {
                    id: uuid(),
                    sessionId: window.state.activeSessionId,
                    studentName: window.state.studentName,
                    score: score,
                    maxScore: max,
                    answers: window.state.runnerState.answers, 
                    timestamp: new Date().toLocaleString()
                };
                
                // Додаємо в масив
                window.state.results.push(resultRecord);
                
                // !!! СПРОБА ЗБЕРЕЖЕННЯ З ПЕРЕВІРКОЮ !!!
                const saveSuccess = window.saveTestsToStorage();
                
                if (saveSuccess) {
                    // Тільки якщо зберегли успішно - ставимо прапорець і чистимо прогрес
                    window.state.runnerState.isFinished = true;
                    localStorage.removeItem('nmtProgress_' + window.state.activeSessionId);
                    
                    // Вивід результату
                    document.getElementById('top-panel').innerHTML = `
                        <div id="result-full-box" class="text-center py-6 transition-all duration-300">
                            <div class="text-3xl font-bold text-green-600 mb-2">Тест завершено!</div>
                            <div class="text-xl mb-4">${window.state.studentName}, ваш результат збережено.</div>
                            <div class="text-4xl font-bold mb-6 border-2 border-green-600 inline-block p-4 rounded-full w-32 h-32 flex items-center justify-center mx-auto bg-green-50 text-green-800">
                                ${score}
                            </div>
                            <p class="text-gray-500 mb-4">з ${max} можливих балів</p>
                            <div class="flex justify-center gap-4">
                                <button onclick="window.toggleResultPanel()" class="btn-brand bg-blue-500 border-blue-500">👁 Переглянути помилки</button>
                                <button onclick="window.location.reload()" class="btn-brand bg-gray-500 border-gray-500">Вийти</button>
                            </div>
                        </div>
                        <div id="result-minimized-box" style="display:none;" class="flex justify-between items-center py-2 px-4">
                            <div class="font-bold text-lg text-green-700">Результат: ${score} / ${max}</div>
                            <button onclick="window.toggleResultPanel()" class="btn-brand text-sm py-1 px-3">Розгорнути результат</button>
                        </div>
                    `;
                } else {
                    // Якщо зберегти не вийшло, скасовуємо зміни в пам'яті
                    // (видаляємо незаписаний результат з масиву, щоб не було дублів при повторному натисканні)
                    window.state.results.pop(); 
                    window.state.runnerState.isFinished = false; // Дозволяємо спробувати ще раз
                    // Таймер можна запустити знову або залишити зупиненим
                }

            } else {
                // Для режиму "Пройти" з редактора (без збереження в базу)
                window.state.runnerState.isFinished = true;
                document.getElementById('top-panel').innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-2xl font-bold text-red-600 mb-2">Тест завершено!</div>
                        <div class="text-xl">Ваш результат: <b>${score}</b> з <b>${max}</b></div>
                        <button onclick="window.state.view='dashboard'; window.renderApp()" class="btn-brand mt-4">Вийти в меню</button>
                    </div>
                `;
            }

            // Показуємо панель тільки якщо тест реально завершено
            if (window.state.runnerState.isFinished) {
                document.getElementById('top-panel').classList.remove('hidden-panel');
                document.body.style.paddingTop = '180px';
                const retBtn = document.getElementById('return-panel-btn');
                if(retBtn) retBtn.style.display = 'none';
            }
        };

	window.toggleResultPanel = function() {
            const full = document.getElementById('result-full-box');
            const min = document.getElementById('result-minimized-box');
            
            if (full.style.display === 'none') {
                full.style.display = 'block';
                min.style.display = 'none';
                document.body.style.paddingTop = '400px'; // Збільшуємо відступ, коли панель велика
            } else {
                full.style.display = 'none';
                min.style.display = 'flex';
                document.body.style.paddingTop = '80px'; // Зменшуємо відступ, коли згорнута
            }
        };

	// НОВА ФУНКЦІЯ: Збереження проміжного прогресу
        window.saveProgress = function() {
            if (window.state.activeSessionId && window.state.studentName && !window.state.isReviewMode) {
                const dataToSave = {
                    sessionId: window.state.activeSessionId,
                    testId: window.state.activeTestId,
                    studentName: window.state.studentName,
                    answers: window.state.runnerState.answers,
                    startTime: window.state.runnerState.startTime // Зберігаємо час старту
                };
                localStorage.setItem('nmtProgress_' + window.state.activeSessionId, JSON.stringify(dataToSave));
            }
        };

	// --- ФУНКЦІЇ СТАТИСТИКИ ТА АНАЛІТИКИ ---

        window.calculateTaskStats = function(block, results) {
            const total = results.length;
            if (total === 0) return { type: 'empty' };

            // 1. Для однієї відповіді (Single)
            if (block.type === 'single') {
                const counts = {};
                block.options.forEach(o => counts[o.id] = 0);
                
                results.forEach(res => {
                    const ans = res.answers[block.id]?.final;
                    if (ans && counts.hasOwnProperty(ans)) counts[ans]++;
                });

                const stats = block.options.map(o => ({
                    label: o.text.replace(/<[^>]*>/g, '').trim(), // Очищаємо HTML теги для таблиці
                    count: counts[o.id] || 0,
                    percent: ((counts[o.id] || 0) / total * 100).toFixed(1),
                    isCorrect: o.id === block.correctId
                }));
                return { type: 'options', stats };
            }

            // 2. Для випадаючих списків (Dropdown)
            if (block.type === 'dropdown') {
                // Тут складніше, бо списків може бути декілька. Робимо статистику для кожного списку окремо.
                const dropdownStats = block.dropdowns.map(dd => {
                    const counts = {};
                    dd.options.forEach(o => counts[o.id] = 0);

                    results.forEach(res => {
                        const userVal = res.answers[block.id]?.final?.[dd.id];
                        if (userVal && counts.hasOwnProperty(userVal)) counts[userVal]++;
                    });

                    return {
                        name: dd.name,
                        rows: dd.options.map(o => ({
                            label: o.text,
                            percent: ((counts[o.id] || 0) / total * 100).toFixed(1),
                            isCorrect: o.id === dd.correctId
                        }))
                    };
                });
                return { type: 'dropdown', dropdownStats };
            }

	    // 3. Для структурованих завдань
            if (block.type === 'structured') {
                const subStats = block.items.map(item => {
                    let correctCount = 0;
                    
                    results.forEach(res => {
                        let uVal = res.answers[block.id]?.final?.[item.id];
                        if (uVal) uVal = uVal.toString().replace(',', '.').trim();
                        let cVal = item.correctAnswer.toString().replace(',', '.').trim();
                        
                        if (uVal == cVal) correctCount++;
                    });

                    return {
                        label: item.text,
                        points: item.points,
                        percent: (correctCount / total * 100).toFixed(1)
                    };
                });
                return { type: 'structured', subStats };
            }

            // 4. Для балів (Multiple, Matching, Short)
            const scoreCounts = {}; 
            
            // Визначаємо масив можливих балів (possibleScores)
            let possibleScores = [];
            let maxPoints = 0;

            if (block.type === 'short') {
                // Для короткої відповіді: або 0, або Максимум (без проміжних)
                maxPoints = parseInt(block.points) || 2;
                possibleScores = [0, maxPoints];
            } 
            else if (block.type === 'multiple') {
                maxPoints = (block.correctIds?.length || 0) * (parseInt(block.pointsPerSelection) || 1);
                // Тут бали йдуть підряд: 0, 1, 2...
                for(let i=0; i<=maxPoints; i++) possibleScores.push(i);
            } 
            else if (block.type === 'matching') {
                maxPoints = Object.keys(block.correctPairs || {}).length * (parseInt(block.pointsPerPair) || 1);
                // Тут теж підряд
                for(let i=0; i<=maxPoints; i++) possibleScores.push(i);
            }

            // Ініціалізуємо лічильники
            possibleScores.forEach(s => scoreCounts[s] = 0);

            results.forEach(res => {
                let score = 0;
                const userAns = res.answers[block.id]?.final;

                if (block.type === 'short') {
                     let cleanAns = userAns ? userAns.toString().replace(',', '.').trim() : '';
                     // Якщо правильно - даємо макс, якщо ні - 0
                     if (cleanAns == block.correctAnswer) score = maxPoints;
                     else score = 0;
                }
                else if (block.type === 'multiple') {
                    const sel = userAns || [];
                    const correct = block.correctIds || [];
                    const p = parseInt(block.pointsPerSelection) || 1;
                    
                    let matchCount = 0;
                    sel.forEach(s => {
                        if (correct.includes(s)) matchCount++;
                    });
                    score = matchCount * p;
                }
                else if (block.type === 'matching') {
                    const pairs = userAns || {};
                    const p = parseInt(block.pointsPerPair) || 1;
                    Object.keys(block.correctPairs).forEach(k => {
                        if (pairs[k] === block.correctPairs[k]) score += p;
                    });
                }
                
                // Записуємо результат, якщо він є в списку можливих (безпека)
                if (scoreCounts[score] !== undefined) scoreCounts[score]++;
            });

            // Формуємо статистику тільки для possibleScores
            const stats = [];
            possibleScores.forEach(score => {
                stats.push({
                    score: score,
                    percent: ((scoreCounts[score] || 0) / total * 100).toFixed(1)
                });
            });
            
            return { type: 'points', stats };
        };

	// --- ПСИХОМЕТРИЧНІ ФУНКЦІЇ ---

        // 1. Кореляція Пірсона (для Rit)
        window.calculateCorrelation = function(x, y) {
            const n = x.length;
            if (n < 2) return 0;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = (n * sumXY) - (sumX * sumY);
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            if (denominator === 0) return 0;
            return numerator / denominator;
        };

        // 2. Розрахунок усіх метрик для завдання (або підпитання)
        window.calculateItemMetrics = function(block, results, subItemId = null) {
            const totalStudents = results.length;
            if (totalStudents === 0) return null;

            // Визначаємо макс. бал
            let maxPoints = 1;
            
            if (subItemId && block.type === 'structured') {
                // Якщо рахуємо для підпитання
                const item = block.items.find(i => i.id === subItemId);
                maxPoints = parseInt(item?.points) || 1;
            } else {
                // Якщо для цілого блоку (стара логіка)
                if (block.type === 'short') maxPoints = parseInt(block.points) || 2;
                else if (block.type === 'multiple') maxPoints = (block.correctIds?.length || 0) * (parseInt(block.pointsPerSelection) || 1);
                else if (block.type === 'matching') maxPoints = Object.keys(block.correctPairs || {}).length * (parseInt(block.pointsPerPair) || 1);
                else if (block.type === 'structured') {
                    maxPoints = block.items.reduce((acc, item) => acc + (parseInt(item.points)||1), 0);
                }
                else if (block.type === 'dropdown') {
                    maxPoints = (block.dropdowns?.length || 0) * (parseInt(block.pointsPerDropdown) || 1);
                }
                else if (block.points) maxPoints = parseInt(block.points);
            }

            if (maxPoints === 0) maxPoints = 1;

            const itemScores = [];
            const totalScores = [];
            
            const studentData = results.map(res => {
                let score = 0;
                const userAns = res.answers[block.id]?.final;

                // --- ЛОГІКА ДЛЯ ПІДПИТАННЯ ---
                if (subItemId && block.type === 'structured') {
                    const item = block.items.find(i => i.id === subItemId);
                    if (item) {
                        let uVal = userAns?.[subItemId];
                        if (uVal) uVal = uVal.toString().replace(',', '.').trim();
                        let cVal = item.correctAnswer.toString().replace(',', '.').trim();
                        if (uVal == cVal) score = parseInt(item.points) || 1;
                    }
                } 
                // --- ЛОГІКА ДЛЯ ЦІЛИХ БЛОКІВ ---
                else {
                    if (block.type === 'single') {
                        if (userAns === block.correctId) score = parseInt(block.points) || 1;
                    }
                    else if (block.type === 'short') {
                        let cleanAns = userAns ? userAns.toString().replace(',', '.').trim() : '';
                        if (cleanAns == block.correctAnswer) score = maxPoints;
                    }
                    else if (block.type === 'multiple') {
                        const sel = userAns || [];
                        const correct = block.correctIds || [];
                        const p = parseInt(block.pointsPerSelection) || 1;
                        let matchCount = 0;
                        sel.forEach(s => { if (correct.includes(s)) matchCount++; });
                        score = matchCount * p;
                    }
                    else if (block.type === 'matching') {
                        const pairs = userAns || {};
                        const p = parseInt(block.pointsPerPair) || 1;
                        Object.keys(block.correctPairs).forEach(k => {
                            if (pairs[k] === block.correctPairs[k]) score += p;
                        });
                    }
                    else if (block.type === 'dropdown') {
                        const ddAns = userAns || {};
                        const p = parseInt(block.pointsPerDropdown) || 1;
                        if(block.dropdowns) {
                            block.dropdowns.forEach(dd => {
                                if(ddAns[dd.id] === dd.correctId) score += p;
                            });
                        }
                    }
                    else if (block.type === 'structured') {
                        const stAns = userAns || {};
                        block.items.forEach(item => {
                            let uVal = stAns[item.id];
                            if (uVal) uVal = uVal.toString().replace(',', '.').trim();
                            let cVal = item.correctAnswer.toString().replace(',', '.').trim();
                            if (uVal == cVal) score += (parseInt(item.points) || 1);
                        });
                    }
                }

                itemScores.push(score);
                totalScores.push(res.score);

                return { itemScore: score, totalScore: res.score };
            });

            // 1. P-value
            const avgItemScore = itemScores.reduce((a,b)=>a+b, 0) / totalStudents;
            const pValue = (avgItemScore / maxPoints) * 100;

            let pText = "";
            let pColor = "text-gray-600";
            if (pValue > 80) { pText = "тест дуже легкий"; pColor = "text-green-600"; }
            else if (pValue >= 60) { pText = "тест легкий"; pColor = "text-green-500"; }
            else if (pValue >= 40) { pText = "тест оптимальний"; pColor = "text-blue-600"; }
            else if (pValue >= 21) { pText = "тест складний"; pColor = "text-orange-500"; }
            else { pText = "тест дуже складний"; pColor = "text-red-600"; }

            // 2. D-index
            studentData.sort((a, b) => b.totalScore - a.totalScore);
            const groupSize = Math.ceil(totalStudents * 0.27);
            const activeGroupSize = (totalStudents < 4) ? Math.floor(totalStudents / 2) : groupSize;
            
            let dIndex = 0;
            if (activeGroupSize > 0) {
                const highGroup = studentData.slice(0, activeGroupSize);
                const lowGroup = studentData.slice(totalStudents - activeGroupSize, totalStudents);
                const avgHigh = highGroup.reduce((a,b)=>a+b.itemScore, 0) / activeGroupSize;
                const avgLow = lowGroup.reduce((a,b)=>a+b.itemScore, 0) / activeGroupSize;
                dIndex = ((avgHigh - avgLow) / maxPoints) * 100;
            }

            let dText = "";
            let dColor = "text-gray-600";
            if (dIndex >= 41) { dText = "дуже хороша"; dColor = "text-green-600"; }
            else if (dIndex >= 31) { dText = "хороша"; dColor = "text-blue-600"; }
            else if (dIndex >= 21) { dText = "середня"; dColor = "text-orange-500"; }
            else { dText = "низька"; dColor = "text-red-600"; }

            // 3. Rit
            const rit = window.calculateCorrelation(itemScores, totalScores);
            let rText = "";
            let rColor = "text-gray-600";
            if (rit > 0.25) { rText = "висока"; rColor = "text-green-600"; }
            else if (rit > 0.20) { rText = "прийнятна"; rColor = "text-orange-500"; }
            else { rText = "низька"; rColor = "text-red-600"; }

            return {
                pValue: pValue.toFixed(1),
                pText, pColor,
                dIndex: dIndex.toFixed(1),
                dText, dColor,
                rit: rit.toFixed(2),
                rText, rColor
            };
        };

	// --- BANK SYSTEM ---

	// НОВА ФУНКЦІЯ: Обробка перетягування завдання В ПАПКУ
        window.bankFolderDrop = function(e, targetFolderId) {
            e.stopPropagation();
            e.preventDefault();
            
            const bankId = e.dataTransfer.getData("bankId");
            if (!bankId) return;

            // Знаходимо елемент, який перетягуємо
            const item = window.state.bankItems.find(i => i.id === bankId);
            if (!item) return;

            // Перевірка: не можна кинути папку в саму себе
            if (item.id === targetFolderId) return;

            // Змінюємо батька
            item.parentId = targetFolderId;
            
            window.saveTestsToStorage();
            window.renderApp();
        };

	window.renameBankFolder = function(e, id) {
            e.stopPropagation(); // Щоб не відкривати папку при кліку на олівець
            const item = window.state.bankItems.find(i => i.id === id);
            if(!item) return;

            window.showPrompt("Перейменувати папку", item.title, (newName) => {
                if (newName) {
                    item.title = newName;
                    window.saveTestsToStorage();
                    window.renderApp();
                }
            });
        };

        window.renderBank = function(container) {
            const currentFolderId = window.state.currentBankFolderId;
            const items = window.state.bankItems.filter(i => i.parentId === currentFolderId);
            
            const folders = items.filter(i => i.type === 'folder').sort((a,b) => a.title.localeCompare(b.title));
            const tasks = items.filter(i => i.type === 'task'); 

            let breadcrumbs = [];
            let tempId = currentFolderId;
            while(tempId !== 'root') {
                const f = window.state.bankItems.find(i => i.id === tempId);
                if(!f) break;
                breadcrumbs.unshift(f);
                tempId = f.parentId;
            }
            const breadcrumbHtml = `
                <div class="flex items-center gap-2 mb-4 text-sm text-gray-600">
                    <span class="cursor-pointer hover:underline" onclick="window.openBankFolder('root')">🏦 Банк</span>
                    ${breadcrumbs.map(f => `<span>/</span> <span class="cursor-pointer hover:underline font-bold" onclick="window.openBankFolder('${f.id}')">${f.title}</span>`).join('')}
                </div>
            `;

            container.innerHTML = `
                <div class="max-w-7xl mx-auto p-6 h-screen flex flex-col">
                    <div class="flex gap-4 mb-4 border-b pb-2">
                        <button onclick="window.switchSection('tests')" class="text-xl font-bold text-gray-500 hover:text-gray-800 pb-2 px-4">Мої тести</button>
                        <button onclick="window.switchSection('bank')" class="text-xl font-bold border-b-2 border-[#FF2938] pb-2 px-4 text-[#FF2938]">Банк завдань</button>
                        <button onclick="window.switchSection('cabinet')" class="text-xl font-bold text-gray-500 hover:text-gray-800 pb-2 px-4">Кабінет тестування</button>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Банк завдань</h2>
                            ${breadcrumbHtml}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.createBankFolder()" class="spa-btn spa-btn-secondary">+ Папка</button>
                            <button onclick="window.createBankTask()" class="spa-btn bg-[#FF2938] text-white hover:bg-red-700">+ Нове завдання</button>
                        </div>
                    </div>

                    <div class="flex flex-1 gap-6 overflow-hidden">
                        <div class="w-1/4 bg-white border rounded shadow-sm overflow-y-auto p-2">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Папки</div>
                            ${currentFolderId !== 'root' ? `
                                <div class="bank-folder-item" 
                                     ondrop="window.bankFolderDrop(event, '${window.state.bankItems.find(i=>i.id===currentFolderId)?.parentId || 'root'}')"
                                     ondragover="event.preventDefault()"
                                     onclick="window.openBankFolder('${window.state.bankItems.find(i=>i.id===currentFolderId)?.parentId || 'root'}')">
                                    <span class="text-gray-400">⤴</span> .. (На рівень вище)
                                </div>
                            ` : ''}
                            ${folders.length === 0 ? '<div class="text-sm text-gray-400 italic p-2">Немає папок</div>' : ''}
                            ${folders.map(f => `
                                <div class="bank-folder-item group justify-between" 
                                     draggable="true" 
                                     ondragstart="window.bankDragStart(event, '${f.id}')"
                                     ondragover="event.preventDefault()" 
                                     ondrop="window.bankFolderDrop(event, '${f.id}')"
                                     onclick="window.openBankFolder('${f.id}')">
                                    <div class="flex items-center gap-2 overflow-hidden">
                                        <span class="bank-folder-icon">📁</span>
                                        <span class="truncate">${f.title}</span>
                                    </div>
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100">
                                        <button onclick="window.renameBankFolder(event, '${f.id}')" class="text-blue-400 hover:text-blue-600 px-1" title="Перейменувати">✎</button>
                                        <button onclick="window.deleteBankItem(event, '${f.id}')" class="text-red-400 hover:text-red-600 px-1" title="Видалити">×</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="flex-1 bg-gray-50 border rounded shadow-inner overflow-y-auto p-4" 
                             ondragover="window.bankDragOver(event)" ondrop="window.bankDrop(event)">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Завдання в цій папці (${tasks.length})</div>
                            ${tasks.length === 0 ? '<div class="text-center text-gray-400 mt-10">Папка порожня. Додайте завдання.</div>' : ''}
                            
                            ${tasks.map((t, index) => {
                                // Ми тепер НЕ вирізаємо HTML, а показуємо як є (обмежено CSS класом)
                                const contentHtml = t.content.question;
                                
                                const sourceHtml = t.bankSource 
                                    ? `<div class="text-xs text-blue-600 font-bold bg-blue-50 inline-block px-2 py-1 rounded mt-1 border border-blue-100">${t.bankSource}</div>` 
                                    : '';

                                return `
                                <div class="bank-task-card" draggable="true" ondragstart="window.bankDragStart(event, '${t.id}')">
                                    <div class="bank-task-number">${index + 1}</div>
                                    <div class="bank-task-info" style="min-width: 0;"> <div class="bank-task-type">${t.content.type}</div>
                                        
                                        <div class="bank-preview-content rich-content" style="border:none; padding:0;">
                                            ${contentHtml}
                                        </div>
                                        
                                        ${sourceHtml}
                                    </div>
                                    <div class="bank-task-actions flex flex-col gap-2 items-center justify-center pl-2 border-l">
                                        <button onclick="window.editBankTask('${t.id}')" class="text-gray-500 hover:text-blue-600 p-1" title="Редагувати">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                        </button>
                                        <button onclick="window.deleteBankItem(event, '${t.id}')" class="text-red-400 hover:text-red-600 p-1" title="Видалити">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                        </button>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            // ВАЖЛИВО: Запускаємо MathJax для рендеру формул у списку
            setTimeout(() => {
                if(window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise();
                }
            }, 100);
        };

        // --- Bank Actions ---

        window.openBankFolder = function(id) {
            window.state.currentBankFolderId = id;
            window.renderApp();
        };

        window.createBankFolder = function() {
            window.showPrompt("Назва папки", "Новий розділ", (name) => {
                if(name) {
                    window.state.bankItems.push({
                        id: uuid(),
                        type: 'folder',
                        parentId: window.state.currentBankFolderId,
                        title: name
                    });
                    window.saveTestsToStorage();
                    window.renderApp();
                }
            });
        };

        // ХИТРИЙ ТРЮК: Використовуємо існуючий редактор для створення завдання в банку
        window.createBankTask = function() {
            // Створюємо "чорновий" тест з одним блоком
            const tempTestId = 'bank-draft-' + uuid();
            const draftTest = {
                id: tempTestId,
                title: 'Редагування завдання банку',
                description: 'Тимчасовий буфер',
                blocks: [], // Порожній, користувач натисне "+"
                isBankMode: true // Прапорець для редактора
            };
            
            // Зберігаємо в items (тимчасово) або просто в editorDraft
            window.state.editorDraft = draftTest;
            window.state.activeTestId = tempTestId; // Фейковий ID
            window.state.editingBankTaskId = null; // Нове завдання
            
            // Додаємо один блок за замовчуванням
            window.addBlock('single'); // Або відкриваємо порожній
            
            window.state.view = 'editor';
            window.renderApp();
        };

        window.editBankTask = function(taskId) {
            const task = window.state.bankItems.find(i => i.id === taskId);
            if(!task) return;

            const draftTest = {
                id: 'bank-edit-' + taskId,
                title: 'Редагування завдання',
                blocks: [JSON.parse(JSON.stringify(task.content))],
                isBankMode: true,
                bankSource: task.bankSource || '' // НОВЕ: Завантажуємо існуючий опис
            };

            window.state.editorDraft = draftTest;
            window.state.activeTestId = draftTest.id;
            window.state.editingBankTaskId = taskId;

            window.state.view = 'editor';
            window.renderApp();
        };

        window.deleteBankItem = function(e, id) {
            e.stopPropagation();
            if(confirm("Видалити цей елемент з банку?")) {
                // Якщо папка - треба видалити і вкладене (спрощено: видаляємо тільки папку, вкладене стає сиротами або теж видаляється)
                // Для надійності краще рекурсивно
                const idsToDelete = [id];
                const gatherChildren = (pid) => {
                    window.state.bankItems.filter(i => i.parentId === pid).forEach(child => {
                        idsToDelete.push(child.id);
                        if(child.type === 'folder') gatherChildren(child.id);
                    });
                };
                const item = window.state.bankItems.find(i => i.id === id);
                if (item.type === 'folder') gatherChildren(id);

                window.state.bankItems = window.state.bankItems.filter(i => !idsToDelete.includes(i.id));
                window.saveTestsToStorage();
                window.renderApp();
            }
        };

        // --- Drag & Drop у Банку (сортування) ---
        window.bankDragStart = function(e, id) {
            e.dataTransfer.setData("bankId", id);
            e.dataTransfer.effectAllowed = "move";
        };
        window.bankDragOver = function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
        };
        window.bankDrop = function(e) {
            e.preventDefault();
            const id = e.dataTransfer.getData("bankId");
            if (!id) return;

            const items = window.state.bankItems;
            const itemIndex = items.findIndex(i => i.id === id);
            if (itemIndex === -1) return;
            const item = items[itemIndex];

            // Визначаємо, куди кинули (знаходимо найближчу картку)
            const targetCard = e.target.closest('.bank-task-card');
            
            // Якщо кинули в порожнє місце - просто в кінець цієї папки
            // Але якщо кинули на іншу картку - міняємо місцями або вставляємо перед
            
            // Спрощена реалізація: Переміщення в кінець списку (якщо треба сортування - треба складнішу логіку insertBefore)
            // Для "стовпчика" найпростіше: видалити і вставити в нову позицію масиву.
            // Але у нас масив плаский (всі елементи банку разом).
            // Тому ми просто оновлюємо parentId (якщо перетягнули в іншу папку - але тут DragZone - це список поточної папки).
            
            // Реалізуємо сортування: знаходимо індекс цільового елемента в загальному масиві
            // Це складно з пласким списком. 
            // ПРОСТЕ РІШЕННЯ: Видаляємо елемент і додаємо його в кінець масиву (він стане останнім у папці).
            // Для повноцінного сортування треба окреме поле `order`.
            
            // Давайте поки що зробимо так: при дропі елемент стає останнім у списку.
            items.splice(itemIndex, 1);
            items.push(item);
            
            window.saveTestsToStorage();
            window.renderApp();
        };

	// --- BANK INTEGRATION ---

        // 1. Збереження редагованого завдання назад у Банк
        window.saveBankTaskChanges = function() {
            const draft = window.state.editorDraft;
            const block = draft.blocks[0]; 
            
            if (!block) return alert("Завдання порожнє!");

            if (window.state.editingBankTaskId) {
                // Оновлення існуючого
                const item = window.state.bankItems.find(i => i.id === window.state.editingBankTaskId);
                if (item) {
                    item.content = block;
                    item.bankSource = draft.bankSource; // НОВЕ: Зберігаємо джерело
                }
            } else {
                // Створення нового
                window.state.bankItems.push({
                    id: uuid(),
                    type: 'task',
                    parentId: window.state.currentBankFolderId,
                    content: block,
                    bankSource: draft.bankSource // НОВЕ: Зберігаємо джерело
                });
            }
            
            window.saveTestsToStorage();
            window.state.view = 'dashboard';
            window.state.currentSection = 'bank'; 
            window.renderApp();
        };

        // 2. Експорт завдання з Тесту в Банк
        window.exportTaskToBank = function(blockIndex) {
            // Зберігаємо індекс блоку, який хочемо експортувати
            window.state.exportBlockIndex = blockIndex;
            
            // Відкриваємо модалку вибору папки
            window.openBankExportModal();
        };

	// Функція для розгортання/згортання папок у модальному вікні
        window.toggleTreeFolder = function(element) {
            const container = element.nextElementSibling; // Знаходимо контейнер з дітьми
            const icon = element.querySelector('.folder-tree-icon');
            
            if (container) {
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    if(icon) icon.innerText = '📂'; // Відкрита папка
                } else {
                    container.style.display = 'none';
                    if(icon) icon.innerText = '📁'; // Закрита папка
                }
            }
        };

        // 3. Імпорт з Банку в Тест (Модальне вікно)
        window.openBankImportModal = function() {
            // Функція побудови дерева (рекурсивна)
            const renderTree = (parentId, level=0) => {
                const items = window.state.bankItems.filter(i => i.parentId === parentId);
                const folders = items.filter(i => i.type === 'folder').sort((a,b) => a.title.localeCompare(b.title));
                const tasks = items.filter(i => i.type === 'task');
                
                let html = '';
                
                // Рендер папок
                folders.forEach(f => {
                    // Перевіряємо, чи є вміст, щоб знати, чи малювати стрілочку/плюсик (опціонально)
                    const childrenHtml = renderTree(f.id, level + 1);
                    
                    html += `
                        <div style="margin-left: ${level * 10}px;">
                            <div class="cursor-pointer hover:bg-gray-100 p-1 rounded flex items-center gap-2 select-none" 
                                 onclick="window.toggleTreeFolder(this)">
                                <span class="folder-tree-icon">📁</span> 
                                <span class="font-bold text-gray-700">${f.title}</span>
                            </div>
                            
                            <div style="display: none; border-left: 1px solid #ddd; margin-left: 7px; padding-left: 5px;">
                                ${childrenHtml || '<div class="text-xs text-gray-400 italic pl-6">Пусто</div>'}
                            </div>
                        </div>
                    `;
                });

                // Рендер завдань
                tasks.forEach(t => {
                    // Використовуємо повний HTML замість preview text
                    const contentHtml = t.content.question; 
                    const sourceLabel = t.bankSource ? `<span class="text-xs text-blue-600 bg-blue-50 px-1 rounded border border-blue-100 ml-2 whitespace-nowrap">${t.bankSource}</span>` : '';
                    
                    html += `
                        <div style="margin-left: ${level * 10 + 20}px; border-bottom:1px solid #f3f4f6; padding:8px; display:flex; justify-content:space-between; align-items:start; background: white;">
                            <div class="flex flex-col w-full pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold text-blue-500 uppercase border border-blue-200 px-1 rounded bg-blue-50 flex-shrink-0">${t.content.type}</span>
                                    ${sourceLabel}
                                </div>
                                <div class="rich-content text-sm text-gray-700 bank-preview-content text-left" style="border:none; padding:0; max-height:100px;">
   			 		${contentHtml}
				</div>
                            </div>
                            <button onclick="window.importTaskFromBank('${t.id}')" class="text-xs bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 shadow-sm whitespace-nowrap self-center">+ Додати</button>
                        </div>
                    `;
                });
                return html;
            };

            const html = `
                <div class="h-[60vh] overflow-y-auto border p-4 bg-white rounded shadow-inner">
                    <div class="text-sm text-gray-500 mb-2 italic">Натисніть на папку, щоб розгорнути її:</div>
                    ${renderTree('root')}
                </div>
            `;
            
            window.showModal("Оберіть завдання з Банку", html, () => {});
            
            // Запуск Latex у модалці
            setTimeout(() => {
                if(window.MathJax && window.MathJax.typesetPromise) {
                    const modalBody = document.getElementById('modal-body');
                    if(modalBody) window.MathJax.typesetPromise([modalBody]);
                }
            }, 100);
            
            // 1. Ховаємо кнопку "Так", бо ми використовуємо кнопки "+ Додати" всередині списку
            const btnYes = document.getElementById('modal-btn-yes');
            btnYes.style.display = 'none';

            // 2. Налаштовуємо кнопку "Скасувати/Назад", щоб вона відновлювала кнопку "Так" при закритті
            const btnNo = document.getElementById('modal-btn-no');
            // Клонуємо, щоб прибрати старі слухачі і додати новий
            const newBtnNo = btnNo.cloneNode(true);
            btnNo.parentNode.replaceChild(newBtnNo, btnNo);
            
            newBtnNo.textContent = "Скасувати"; // Або "Назад"
            newBtnNo.onclick = function() {
                document.getElementById('global-modal').style.display = 'none';
                // ВАЖЛИВО: Відновлюємо кнопку "Так" для інших модальних вікон
                document.getElementById('modal-btn-yes').style.display = 'inline-flex';
            };
        };

        window.importTaskFromBank = function(taskId) {
            const item = window.state.bankItems.find(i => i.id === taskId);
            if(item) {
                const newBlock = JSON.parse(JSON.stringify(item.content));
                newBlock.id = uuid(); // Новий ID для тесту
                
                // Додаємо в кінець поточного тесту
                window.state.editorDraft.blocks.push(newBlock);
                
                // Оновлюємо інтерфейс (але залишаємось у модалці? ні, краще закрити)
                document.getElementById('global-modal').style.display = 'none';
                document.getElementById('modal-btn-yes').style.display = 'inline-block'; // Відновлюємо кнопку
                window.renderApp();
            }
        };

	window.openBankExportModal = function() {
            // Функція для побудови дерева ПАПОК (рекурсивна, зі згортанням)
            const renderFolderTree = (parentId, level=0) => {
                const folders = window.state.bankItems
                    .filter(i => i.parentId === parentId && i.type === 'folder')
                    .sort((a,b) => a.title.localeCompare(b.title));
                
                let html = '';
                
                // Якщо це корінь, додаємо опцію "Коренева папка"
                if (parentId === 'root' && level === 0) {
                     html += `
                        <div style="border-bottom:1px solid #eee; padding:6px; display:flex; justify-content:space-between; align-items:center; background: #f9fafb; margin-bottom: 5px;">
                            <span class="font-bold text-gray-700">📂 Коренева папка (Банк)</span>
                            <button onclick="window.confirmExportToBank('root')" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700">Зберегти сюди</button>
                        </div>
                     `;
                }

                folders.forEach(f => {
                    const childrenHtml = renderFolderTree(f.id, level + 1);
                    
                    // Перевіряємо, чи є підпапки, щоб знати, чи потрібен відступ/іконка
                    // Але тут ми завжди малюємо структуру, просто ховаємо її
                    
                    html += `
                        <div style="margin-left: ${level * 10}px;">
                            <div style="border-bottom:1px solid #f3f4f6; padding:6px; display:flex; justify-content:space-between; align-items:center; background: white; border-radius: 4px;" class="hover:bg-gray-50">
                                <div class="flex items-center gap-2 cursor-pointer select-none flex-1" onclick="window.toggleTreeFolder(this.parentElement)">
                                    <span class="folder-tree-icon text-yellow-500">📁</span> 
                                    <span class="text-sm font-bold text-gray-700">${f.title}</span>
                                </div>
                                <button onclick="window.confirmExportToBank('${f.id}')" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 shadow-sm">Зберегти сюди</button>
                            </div>
                            
                            <div style="display: none; border-left: 1px solid #ddd; margin-left: 8px;">
                                ${childrenHtml}
                            </div>
                        </div>
                    `;
                });
                return html;
            };

            const html = `
                <div class="h-[60vh] overflow-y-auto border p-4 bg-white rounded shadow-inner text-left">
                    <p class="mb-4 text-gray-500 text-sm">Оберіть папку, куди зберегти це завдання (натисніть на папку, щоб відкрити підпапки):</p>
                    ${renderFolderTree('root')}
                </div>
            `;
            
            window.showModal("Експорт у Банк завдань", html, () => {});
            
            // Ховаємо "Так", залишаємо тільки "Скасувати"
            document.getElementById('modal-btn-yes').style.display = 'none';
            const btnNo = document.getElementById('modal-btn-no');
            const newBtnNo = btnNo.cloneNode(true);
            btnNo.parentNode.replaceChild(newBtnNo, btnNo);
            newBtnNo.textContent = "Скасувати";
            newBtnNo.onclick = function() {
                document.getElementById('global-modal').style.display = 'none';
                document.getElementById('modal-btn-yes').style.display = 'inline-flex';
            };
        };

	window.confirmExportToBank = function(targetFolderId) {
            const blockIndex = window.state.exportBlockIndex;
            if (blockIndex === undefined || blockIndex === null) return;

            const block = window.state.editorDraft.blocks[blockIndex];
            
            const newTask = {
                id: uuid(),
                type: 'task',
                parentId: targetFolderId,
                content: JSON.parse(JSON.stringify(block)),
                bankSource: window.state.editorDraft.bankSource || '' // Якщо раптом є
            };
            
            window.state.bankItems.push(newTask);
            window.saveTestsToStorage();
            
            document.getElementById('global-modal').style.display = 'none';
            document.getElementById('modal-btn-yes').style.display = 'inline-flex';
            
            alert("Завдання успішно збережено в обрану папку!");
        };

        window.showSessionStatistics = function(sessionId) {
            const session = window.state.sessions.find(s => s.id === sessionId);
            const results = window.state.results.filter(r => r.sessionId === sessionId);
            const test = window.findItem(session.testId);

            if (!results.length) return alert("Немає завершених результатів для аналізу.");

            // --- ЗАГАЛЬНА СТАТИСТИКА ---
            const scores = results.map(r => r.score).sort((a,b) => a - b);
            const maxPossible = results[0].maxScore; 
            
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = (sum / scores.length).toFixed(1);

            const mid = Math.floor(scores.length / 2);
            const median = scores.length % 2 !== 0 
                ? scores[mid] 
                : ((scores[mid - 1] + scores[mid]) / 2);

            // Бінінг
            const maxBarsTarget = 30;
            let binSize = 1;
            // Якщо макс. бал > 40, вмикаємо групування
            if (maxPossible > 40) binSize = Math.ceil((maxPossible + 1) / maxBarsTarget);
            
            const numBins = Math.ceil((maxPossible + 1) / binSize);
            const histogramData = new Array(numBins).fill(0);
            const binLabels = new Array(numBins).fill('');

            for (let i = 0; i < numBins; i++) {
                const start = i * binSize;
                const end = Math.min(start + binSize - 1, maxPossible);
                binLabels[i] = (start === end) ? `${start}` : `${start}–${end}`;
            }

            scores.forEach(s => {
                if (s >= 0 && s <= maxPossible) {
                    const binIndex = Math.floor(s / binSize);
                    if (binIndex < numBins) histogramData[binIndex]++;
                }
            });
            
            const maxFrequency = Math.max(...histogramData);

            // Шкала Y
            let yMax = 10, yStep = 1;
            if (maxFrequency > 100) { yMax = Math.ceil(maxFrequency/20)*20; if(yMax<200) yMax=200; yStep=20; }
            else if (maxFrequency > 50) { yMax = 100; yStep = 10; }
            else if (maxFrequency > 20) { yMax = 50; yStep = 5; }
            else if (maxFrequency > 10) { yMax = 20; yStep = 2; }
            while (yMax < maxFrequency) yMax += yStep;

            let gridLinesHtml = '', yAxisLabelsHtml = '';
            for (let v = yMax; v >= 0; v -= yStep) {
                const bottomPos = (v / yMax) * 100;
                if (v > 0) gridLinesHtml += `<div style="position: absolute; left: 0; right: 0; bottom: ${bottomPos}%; border-top: 1px solid #e5e7eb; z-index: 0;"></div>`;
                yAxisLabelsHtml += `<div style="position: absolute; right: 8px; bottom: ${bottomPos}%; transform: translateY(50%); font-size: 12px; color: #4b5563;">${v}</div>`;
            }

            // --- HTML ---
            let html = `<div class="text-left max-h-[80vh] overflow-y-auto pr-4">`;
            
            html += `<div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">${test.title}</h2>
                        <p class="text-gray-600 text-center mb-6">Аналіз результатів (${results.length} учасників)</p>
                        
                        <div class="flex justify-center gap-4 mb-8">
                            <div class="bg-gray-100 border border-gray-300 rounded p-3 text-center w-32">
                                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Середній бал</div>
                                <div class="text-xl font-bold text-blue-700">${avg}/${maxPossible}</div>
                            </div>
                            <div class="bg-gray-100 border border-gray-300 rounded p-3 text-center w-32">
                                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Медіана</div>
                                <div class="text-xl font-bold text-purple-700">${median}/${maxPossible}</div>
                            </div>
                            <div class="bg-gray-100 border border-gray-300 rounded p-3 text-center w-32">
                                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Діапазон</div>
                                <div class="text-xl font-bold text-gray-700">0–${maxPossible}</div>
                            </div>
                        </div>

                        <div class="flex pb-6 pl-2">
                            <div class="flex items-center justify-center w-10 mr-1">
                                <div style="writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap;" class="text-sm text-gray-600">
                                    <span class="italic font-normal">Кількість учасників:</span> 
                                    <span class="not-italic font-normal ml-1">${results.length}</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex h-64 relative mb-12"> 
                                    <div class="w-10 relative border-r border-gray-300 mr-1 flex-shrink-0">${yAxisLabelsHtml}</div>
                                    <div class="flex-1 relative flex items-end gap-1 px-2 border-b border-gray-300">
                                        <div class="absolute inset-0 pointer-events-none w-full h-full">${gridLinesHtml}</div>
                                        ${histogramData.map((count, index) => {
                                            const label = binLabels[index];
                                            const heightPercent = (count / yMax) * 100;
                                            const displayHeight = heightPercent === 0 ? '0px' : heightPercent + '%';
                                            const border = heightPercent > 0 ? '1px solid black' : 'none';
                                            const tooltipLabel = label.includes('–') ? `Бали: ${label}` : `Бал: ${label}`;
                                            
                                            // ЛОГІКА ПОВОРОТУ ПІДПИСІВ
                                            // Якщо binSize > 1 (є проміжки), то повертаємо вертикально.
                                            // Якщо binSize == 1 (звичайні числа), то горизонтально.
                                            let labelHtml = '';
                                            if (binSize > 1) {
                                                // Вертикальний підпис (для діапазонів)
                                                labelHtml = `
                                                <div class="text-[10px] text-gray-600 absolute top-full mt-2 w-full text-right origin-top-right" 
                                                     style="transform: rotate(-90deg) translateX(-50%); white-space: nowrap; right: 50%;">
                                                    ${label}
                                                </div>`;
                                            } else {
                                                // Горизонтальний підпис (для звичайних чисел)
                                                labelHtml = `
                                                <div class="text-[10px] text-gray-600 absolute top-full mt-1 w-full text-center">
                                                    ${label}
                                                </div>`;
                                            }

                                            return `
                                            <div class="flex flex-col items-center flex-1 min-w-[20px] group relative z-10" style="height: 100%;">
                                                <div class="w-full flex items-end justify-center h-full relative">
                                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity absolute -top-8 bg-black text-white text-xs rounded px-2 py-1 pointer-events-none whitespace-nowrap z-20">
                                                        ${tooltipLabel}, Учнів: ${count}
                                                    </div>
                                                    <div style="height: ${displayHeight}; width: 100%; background-color: #2563eb; border: ${border};" class="transition-all hover:bg-blue-600"></div>
                                                </div>
                                                ${labelHtml}
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-600 italic">Набрані бали</div>
                            </div>
                        </div>
                     </div>`;

            html += `<h3 class="text-xl font-bold text-gray-800 mb-4 bg-gray-100 p-2 rounded">Детальний аналіз завдань</h3>`;

            test.blocks.forEach(b => {
                if (b.type === 'instruction' || b.type === 'pageBreak') return; 

                const psychometrics = (b.type !== 'structured') ? window.calculateItemMetrics(b, results) : null;
                const data = window.calculateTaskStats(b, results);
                
                let questionHtml = b.question;
                if (b.type === 'dropdown' && b.dropdowns) {
                     b.dropdowns.forEach(dd => {
                        const regex = new RegExp(`<span[^>]*data-id="${dd.id}"[^>]*>.*?</span>`, 'g');
                        questionHtml = questionHtml.replace(regex, `<span class="font-bold border-b-2 border-blue-400 px-1 text-blue-800">[${dd.name}]</span>`);
                     });
                }
                
                let optionsHtml = '';
                if (b.type === 'single' || b.type === 'multiple') {
                    optionsHtml = `<div class="mt-2 ml-4 space-y-2">` + 
                        b.options.map(o => {
                            const isCorrect = (b.type === 'single' && o.id === b.correctId) || (b.type === 'multiple' && b.correctIds?.includes(o.id));
                            const borderClass = isCorrect ? 'border-green-500 bg-green-50' : 'border-gray-200';
                            const icon = isCorrect ? '✅' : '⚪';
                            return `<div class="border rounded p-2 flex items-center gap-2 ${borderClass}">${icon} ${o.text}</div>`;
                        }).join('') + `</div>`;
                } else if (b.type === 'matching') {
                     optionsHtml = `<div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                        <div class="border p-2 bg-gray-50 rounded"><b>${b.leftLabel || 'Ліва колонка'}:</b><br>${b.leftItems.map(i => `<div class="mb-1">${i.text}</div>`).join('')}</div>
                        <div class="border p-2 bg-gray-50 rounded"><b>${b.rightLabel || 'Права колонка'}:</b><br>${b.rightItems.map(i => `<div class="mb-1">${i.text}</div>`).join('')}</div>
                     </div>`;
                } else if (b.type === 'structured') {
                    optionsHtml = `<div class="mt-2 ml-4 space-y-2">
                        ${b.items.map(item => `<div class="p-2 bg-gray-50 border rounded"><div class="text-sm rich-content" style="border:none; padding:0;">${item.text}</div><div class="text-xs text-gray-500">Відповідь: ${item.correctAnswer}</div></div>`).join('')}
                    </div>`;
                }

                // Статистика
                let statsHtml = `<div class="mt-4 pt-4 border-t border-gray-300">
                                    <h4 class="font-bold text-gray-700 mb-2">📊 Статистика відповідей:</h4>`;

                if (b.type === 'structured') {
                    // СПЕЦІАЛЬНИЙ ВИВІД ДЛЯ СТРУКТУРОВАНИХ
                    b.items.forEach((item, idx) => {
                        const subMetrics = window.calculateItemMetrics(b, results, item.id);
                        
                        const p = parseInt(item.points) || 1;
                        const scoreDist = {};
                        for(let s=0; s<=p; s++) scoreDist[s] = 0;
                        
                        results.forEach(res => {
                            let uVal = res.answers[b.id]?.final?.[item.id];
                            if (uVal) uVal = uVal.toString().replace(',', '.').trim();
                            let cVal = item.correctAnswer.toString().replace(',', '.').trim();
                            
                            if (uVal == cVal) scoreDist[p]++;
                            else scoreDist[0]++;
                        });

                        statsHtml += `
                        <div class="mb-6 border border-blue-200 rounded bg-white overflow-hidden">
                            <div class="bg-blue-50 p-2 font-bold text-blue-800 border-b border-blue-200">
                                Підпитання ${idx + 1}: ${item.text.replace(/<[^>]*>/g, '').substring(0, 50)}...
                            </div>
                            <div class="p-3">
                                <table class="w-full text-sm border mb-3">
                                    <thead><tr class="bg-gray-50"><th class="p-1 border w-20 text-center">Бал</th><th class="p-1 border text-center">Учасників (%)</th></tr></thead>
                                    <tbody>
                                        ${Object.keys(scoreDist).map(s => {
                                            const count = scoreDist[s];
                                            const pct = ((count / results.length) * 100).toFixed(1);
                                            const isMax = parseInt(s) === p;
                                            return `<tr class="${isMax ? 'bg-green-50' : ''}">
                                                <td class="p-1 border text-center font-bold">${s}</td>
                                                <td class="p-1 border text-center">
                                                    <div class="flex items-center gap-2 justify-center">
                                                        <div class="w-20 bg-gray-200 rounded h-2"><div class="bg-blue-600 h-2 rounded" style="width: ${pct}%"></div></div>
                                                        <span>${pct}%</span>
                                                    </div>
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>

                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div class="text-center p-1 border rounded bg-slate-50">
                                        <div class="text-gray-500">P-value</div>
                                        <div class="font-bold text-lg ${subMetrics.pColor}">${subMetrics.pValue}%</div>
                                        <div class="text-[10px] text-gray-400 uppercase">${subMetrics.pText}</div>
                                    </div>
                                    <div class="text-center p-1 border rounded bg-slate-50">
                                        <div class="text-gray-500">D-index</div>
                                        <div class="font-bold text-lg ${subMetrics.dColor}">${subMetrics.dIndex}%</div>
                                        <div class="text-[10px] text-gray-400 uppercase">${subMetrics.dText}</div>
                                    </div>
                                    <div class="text-center p-1 border rounded bg-slate-50">
                                        <div class="text-gray-500">Rit</div>
                                        <div class="font-bold text-lg ${subMetrics.rColor}">${subMetrics.rit}</div>
                                        <div class="text-[10px] text-gray-400 uppercase">${subMetrics.rText}</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });

                } else {
                    // ЗВИЧАЙНИЙ ВИВІД
                    if (data.type === 'options') {
                        statsHtml += `<table class="w-full text-sm border bg-white"><thead><tr class="bg-gray-100"><th class="p-2 border text-left">Варіант</th><th class="p-2 border w-24 text-center">%</th><th class="p-2 border w-24 text-center">К-сть</th></tr></thead><tbody>`;
                        data.stats.forEach(row => {
                            const style = row.isCorrect ? 'bg-green-100 font-bold text-green-800' : '';
                            statsHtml += `<tr class="${style}"><td class="p-2 border">${row.label} ${row.isCorrect ? '(Правильно)' : ''}</td><td class="p-2 border text-center"><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 mt-1"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${row.percent}%"></div></div><span class="text-xs">${row.percent}%</span></td><td class="p-2 border text-center">${row.count}</td></tr>`;
                        });
                        statsHtml += `</tbody></table>`;
                    } else if (data.type === 'dropdown') {
                        data.dropdownStats.forEach(dd => {
                            statsHtml += `<div class="mt-2 mb-1 font-bold text-sm bg-gray-100 p-1">${dd.name}:</div><table class="w-full text-sm border bg-white mb-2"><tbody>`;
                            dd.rows.forEach(row => {
                                const style = row.isCorrect ? 'bg-green-100 font-bold' : '';
                                statsHtml += `<tr class="${style}"><td class="p-2 border w-2/3">${row.label}</td><td class="p-2 border text-center w-1/3"><div class="w-full bg-gray-200 rounded-full h-1.5 mb-1"><div class="bg-blue-600 h-1.5 rounded-full" style="width: ${row.percent}%"></div></div>${row.percent}%</td></tr>`;
                            });
                            statsHtml += `</tbody></table>`;
                        });
                    } else if (data.type === 'points') {
                        statsHtml += `<table class="w-full text-sm border bg-white"><thead><tr class="bg-gray-100"><th class="p-2 border text-center">Набрано балів</th><th class="p-2 border text-center">Відсоток учнів</th></tr></thead><tbody>`;
                        data.stats.forEach(row => {
                            const isMax = row.score === (data.stats.length - 1);
                            const style = isMax ? 'bg-green-50 font-bold' : '';
                            statsHtml += `<tr class="${style}"><td class="p-2 border text-center text-lg">${row.score}</td><td class="p-2 border text-center"><div class="flex items-center gap-2 justify-center"><div class="w-24 bg-gray-200 rounded-full h-2.5"><div class="bg-purple-600 h-2.5 rounded-full" style="width: ${row.percent}%"></div></div><span>${row.percent}%</span></div></td></tr>`;
                        });
                        statsHtml += `</tbody></table>`;
                        if (b.type === 'short') statsHtml += `<div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 text-sm">🔑 Правильна відповідь: <b>${b.correctAnswer}</b></div>`;
                        else if (b.type === 'matching') {
                             let pairsText = Object.entries(b.correctPairs).map(([l, r]) => {
                                 const lText = b.leftItems.find(i=>i.id===l)?.text.replace(/<[^>]*>/g, '') || '?';
                                 const rText = b.rightItems.find(i=>i.id===r)?.text.replace(/<[^>]*>/g, '') || '?';
                                 return `${lText} → ${rText}`;
                             }).join('; ');
                             statsHtml += `<div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 text-sm">🔑 Ключ: ${pairsText}</div>`;
                        }
                    }

                    if (psychometrics) {
                        statsHtml += `
                        <div class="mt-4 bg-slate-50 border border-slate-200 rounded p-4 text-sm">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex flex-col items-center p-2 bg-white rounded border border-slate-100 shadow-sm">
                                    <div class="font-bold text-gray-500 mb-1">Складність (P-value)</div>
                                    <div class="text-2xl font-bold ${psychometrics.pColor}">${psychometrics.pValue}%</div>
                                    <div class="text-xs text-gray-400 text-center mt-1 uppercase">${psychometrics.pText}</div>
                                </div>
                                <div class="flex flex-col items-center p-2 bg-white rounded border border-slate-100 shadow-sm">
                                    <div class="font-bold text-gray-500 mb-1">Дискримінація (D-index)</div>
                                    <div class="text-2xl font-bold ${psychometrics.dColor}">${psychometrics.dIndex}%</div>
                                    <div class="text-xs text-gray-400 text-center mt-1 uppercase">${psychometrics.dText}</div>
                                </div>
                                <div class="flex flex-col items-center p-2 bg-white rounded border border-slate-100 shadow-sm">
                                    <div class="font-bold text-gray-500 mb-1">Кореляція (Rit)</div>
                                    <div class="text-2xl font-bold ${psychometrics.rColor}">${psychometrics.rit}</div>
                                    <div class="text-xs text-gray-400 text-center mt-1 uppercase">${psychometrics.rText}</div>
                                </div>
                            </div>
                        </div>`;
                    }
                }
                
                statsHtml += `</div>`; 

                html += `<div class="mb-8 p-6 border-2 border-gray-200 rounded-xl bg-white shadow-sm relative">
                            <div class="absolute top-0 left-0 bg-gray-100 px-3 py-1 rounded-br-lg border-r border-b text-xs font-bold text-gray-500">Завдання ${b.number || '#'} (${b.type})</div>
                            <div class="mt-4 text-lg rich-content">${questionHtml}</div>
                            ${optionsHtml}
                            ${statsHtml}
                         </div>`;
            });
            html += `</div>`;

            window.showModal(`Статистика: ${test.title}`, html, () => {});

            setTimeout(() => {
                if(window.MathJax && window.MathJax.typesetPromise) {
                    const modalBody = document.getElementById('modal-body');
                    if (modalBody) window.MathJax.typesetPromise([modalBody]);
                }
            }, 200);
        };

        window.init();

	// --- НОВЕ: Експорт та Імпорт Даних ---
        
        window.downloadJSON = function(content, fileName) {
            const a = document.createElement("a");
            const file = new Blob([JSON.stringify(content, null, 2)], {type: 'application/json'});
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        };

        window.exportFullBackup = function() {
            const backup = {
                items: window.state.items,          // Ваші тести і папки
                bankItems: window.state.bankItems,  // Банк завдань
                date: new Date().toLocaleString()
            };
            const name = `NMT_Backup_${new Date().toISOString().slice(0,10)}.json`;
            window.downloadJSON(backup, name);
            alert('Файл успішно збережено! Збережіть його в надійному місці.');
        };

        window.triggerImport = function() {
            document.getElementById('import-file-input').click();
        };

        window.importFullBackup = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("УВАГА! Імпорт повністю замінить ваші поточні тести та банк завдань даними з файлу. Продовжити?")) {
                event.target.value = ''; // Скидаємо вибір
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.items) window.state.items = data.items;
                    if (data.bankItems) window.state.bankItems = data.bankItems;
                    
                    // Зберігаємо в браузер
                    window.saveTestsToStorage();
                    
                    alert("Дані успішно відновлено!");
                    window.location.reload(); // Перезавантажуємо сторінку
                } catch (err) {
                    alert("Помилка при зчитуванні файлу. Переконайтеся, що це правильний JSON файл.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        };
    </script>
</body>
</html>